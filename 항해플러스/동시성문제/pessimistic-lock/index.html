<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.12.8"/><meta data-react-helmet="true" name="description" content="e-커머스 상품 주문 서비스 중에 동시성 문제가 야기 되는 경우를 분석하고 테스트 코드를 작성해본다."/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0"/><meta data-react-helmet="true" http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:title" content="동시성 문제와 데이터 일관성 문제 해결 with pessimistic lock"/><meta data-react-helmet="true" property="og:description" content="e-커머스 상품 주문 서비스 중에 동시성 문제가 야기 되는 경우를 분석하고 테스트 코드를 작성해본다."/><meta data-react-helmet="true" property="og:image" content="/static/9cc56873e8f0777bd2c8da78846ecabf/image.png"/><meta data-react-helmet="true" property="og:url"/><meta data-react-helmet="true" property="og:site_name" content="동시성 문제와 데이터 일관성 문제 해결 with pessimistic lock"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="동시성 문제와 데이터 일관성 문제 해결 with pessimistic lock"/><meta data-react-helmet="true" name="twitter:description" content="e-커머스 상품 주문 서비스 중에 동시성 문제가 야기 되는 경우를 분석하고 테스트 코드를 작성해본다."/><meta data-react-helmet="true" name="twitter:image" content="/static/9cc56873e8f0777bd2c8da78846ecabf/image.png"/><meta data-react-helmet="true" name="twitter:site" content="@사용자이름"/><meta data-react-helmet="true" name="twitter:creator" content="@사용자이름"/><meta data-react-helmet="true" name="google-site-verification" content="웹 마스터 도구가 제공하는 Meta 태그"/><meta data-react-helmet="true" name="naver-site-verification" content="웹 마스터 도구가 제공하는 Meta 태그"/><style data-href="/styles.9e907bc32054b7771552.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">동시성 문제와 데이터 일관성 문제 해결 with pessimistic lock</title><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="canonical" href="https://connieya.github.io/항해플러스/동시성문제/pessimistic-lock/" data-baseprotocol="https:" data-basehost="connieya.github.io"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css 13ku56z">.css-13ku56z{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;height:100%;}</style><div class="css-13ku56z esjg9ma0"><style data-emotion="css 1l1mfmq">.css-1l1mfmq{position:fixed;top:0;z-index:10;width:100%;height:60px;background:linear-gradient(
    90deg,
    #423434,
    #988b3f 25%,
    #967950 46%,
    #af7a28 69%,
    #eceb08
  );}</style><div class="css-1l1mfmq e1o8p83g1"><style data-emotion="css 1p3pcfy">.css-1p3pcfy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:28px;padding-top:6px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#fff;font-family:Catamaran;font-weight:800;margin-left:20px;opacity:0.7;}</style><a class="css-1p3pcfy e1o8p83g0" href="/">Connieya</a></div><style data-emotion="css-global kxm5mf">@import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap');*{padding:0;margin:0;box-sizing:border-box;font-family:'Nanum Myeongjo',serif;}html,body,#___gatsby{height:100%;}a,a:hover{color:inherit;-webkit-text-decoration:none;text-decoration:none;cursor:pointer;}</style><style data-emotion="css 11k3q87">.css-11k3q87{position:relative;width:100%;max-width:768px;margin:0 auto;}</style><div class="css-11k3q87 e17f455w0"><style data-emotion="css 1fttcpj">.css-1fttcpj{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}</style><div class="css-1fttcpj ehbuenk5"><style data-emotion="css 9aqgc6">.css-9aqgc6{width:100%;max-width:768px;margin:4rem auto;}</style><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained css-9aqgc6 ehbuenk4"><div style="max-width:1062px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg%20height=&#x27;387&#x27;%20width=&#x27;1062&#x27;%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><img aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear" decoding="async" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAAA40lEQVR42p2Q23LCMAxE+Q9y891xDG5MAoH+/3dtV5TOtB3aBx52tN5IZxTt8nGGDwlNp9D2Gu1gENMR4yQqyKUi0sd0QKAce7WLUMbffceZ79p9AVVvoAgzlJUq707DiNgomXvkfrBwymL4BfsBrCbg6hJuPuFKbfSF2UY/24jFjrgwW1nlW2U2ao+mV8+BbzrgnY0XNmY2yqAaNPY8RSOnoPb9p2+4tYDavza0BE7cpnKbNUw4mIgTgZq/2D0Z+k93YIiEsJ7WDWVeMMaM8wPYvgL0BKZcMNcznCeIB1/ca8APcWPHgkecgmEAAAAASUVORK5CYII=" alt=""/><picture><source type="image/webp" data-srcset="/static/9cc56873e8f0777bd2c8da78846ecabf/c07fe/image.webp 266w,/static/9cc56873e8f0777bd2c8da78846ecabf/5a620/image.webp 531w,/static/9cc56873e8f0777bd2c8da78846ecabf/20678/image.webp 1062w" sizes="(min-width: 1062px) 1062px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 1062px) 1062px, 100vw" decoding="async" loading="lazy" data-src="/static/9cc56873e8f0777bd2c8da78846ecabf/99484/image.png" data-srcset="/static/9cc56873e8f0777bd2c8da78846ecabf/8ebf9/image.png 266w,/static/9cc56873e8f0777bd2c8da78846ecabf/7a139/image.png 531w,/static/9cc56873e8f0777bd2c8da78846ecabf/99484/image.png 1062w" alt="해당 포스트 썸네일 이미지"/></picture><noscript><picture><source type="image/webp" srcSet="/static/9cc56873e8f0777bd2c8da78846ecabf/c07fe/image.webp 266w,/static/9cc56873e8f0777bd2c8da78846ecabf/5a620/image.webp 531w,/static/9cc56873e8f0777bd2c8da78846ecabf/20678/image.webp 1062w" sizes="(min-width: 1062px) 1062px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 1062px) 1062px, 100vw" decoding="async" loading="lazy" src="/static/9cc56873e8f0777bd2c8da78846ecabf/99484/image.png" srcSet="/static/9cc56873e8f0777bd2c8da78846ecabf/8ebf9/image.png 266w,/static/9cc56873e8f0777bd2c8da78846ecabf/7a139/image.png 531w,/static/9cc56873e8f0777bd2c8da78846ecabf/99484/image.png 1062w" alt="해당 포스트 썸네일 이미지"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><div><style data-emotion="css 255c6r">.css-255c6r{word-break:keep-all;}</style><h1 class="css-255c6r ehbuenk2">동시성 문제와 데이터 일관성 문제 해결 with pessimistic lock</h1></div><style data-emotion="css jr6aws">.css-jr6aws{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;color:#757575;}</style><div class="css-jr6aws ehbuenk3"><style data-emotion="css s5xdrg">.css-s5xdrg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-s5xdrg ehbuenk1"><style data-emotion="css onhpl3">.css-onhpl3{margin:0.25rem;padding:0.25rem;}.css-onhpl3:first-of-type{margin:0.25rem 0.25rem 0.25rem 0;}</style><span role="checkbox" aria-checked="false" class="css-onhpl3 e12y0cgh1"><style data-emotion="css 1gprwe9">.css-1gprwe9{z-index:9;display:inline-block;padding:0.25rem 0.75rem;color:#000000 font-size:0.9rem;font-weight:600;white-space:nowrap;background-color:-m-a-i-n:#f5f5f8;-s-u-b:#e4f1ff;-s-u-b_-m-i-d-d-l-e_-b-o-l-d:#badcff;-s-u-b_-b-o-l-d:#0E68C8;-w-h-i-t-e:#ffffff;-b-l-a-c-k:#000000;-g-r-a-y:#e2e5e6;-g-r-a-y_-b-o-l-d:#757575;-s-h-a-d-o-w:rgba(82,82,82,0.75);border:1px solid #b5a5a5;border-radius:1rem;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);transform:scale(1);cursor:pointer;-webkit-transition:all 0.1s ease-out;transition:all 0.1s ease-out;}.css-1gprwe9:not(:first-of-type){margin-left:1rem;}.css-1gprwe9:hover{color:#000000 background-color:#b5a5a5;}@media (max-width: 768px){.css-1gprwe9{font-size:0.75rem;}}</style><a aria-label="항해플러스 카테고리" class="css-1gprwe9 e12y0cgh0" href="/?category=%ED%95%AD%ED%95%B4%ED%94%8C%EB%9F%AC%EC%8A%A4">항해플러스</a></span></div><div class="css-0 ehbuenk0">2023.12.30.</div></div></div><style data-emotion="css 1ybhd0e">.css-1ybhd0e{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;margin:0 auto;padding:5rem 0;line-height:1.75;word-break:break-all;}.css-1ybhd0e h1,.css-1ybhd0e h2,.css-1ybhd0e h3{margin-bottom:1.5rem;font-weight:700;}.css-1ybhd0e h1{padding-left:0.2rem;font-size:2rem;border-bottom:1px solid #e2e5e6;}.css-1ybhd0e h2{font-size:1.75rem;border-bottom:1px solid #e2e5e6;}.css-1ybhd0e h3{font-size:1.25rem;}.css-1ybhd0e *+h1,.css-1ybhd0e *+h2,.css-1ybhd0e *+h3{margin-top:2rem;margin-bottom:0.5rem;}.css-1ybhd0e hr+h1,.css-1ybhd0e hr+h2,.css-1ybhd0e hr+h3{margin-top:0;}.css-1ybhd0e blockquote{margin:30px 0;padding:0 1rem;color:#757575;font-weight:800;border-left:2px solid #e2e5e6;}.css-1ybhd0e ol,.css-1ybhd0e ul{margin-top:0rem;margin-bottom:0rem;margin-left:1rem;padding:0.5rem 0;}.css-1ybhd0e li{font-weight:300;}.css-1ybhd0e hr{margin:100px 0;border:1px solid #000;}.css-1ybhd0e a{color:#0E68C8;}.css-1ybhd0e p{margin:0;padding:0.5rem 0;font-weight:300;}.css-1ybhd0e img{margin:3rem 0;}.css-1ybhd0e pre[class*='language-'],.css-1ybhd0e code[class*='language-']{color:#d4d4d4;font-size:13px;font-family:Menlo,Monaco,Consolas,'Andale Mono','Ubuntu Mono','Courier New',monospace;direction:ltr;white-space:pre;text-align:left;text-shadow:none;word-break:normal;word-spacing:normal;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;border-radius:0.5rem;}.css-1ybhd0e pre[class*='language-']::selection,.css-1ybhd0e code[class*='language-']::selection,.css-1ybhd0e pre[class*='language-'] *::selection,.css-1ybhd0e code[class*='language-'] *::selection{text-shadow:none;background:#264f78;}@media print{.css-1ybhd0e pre[class*='language-'],.css-1ybhd0e code[class*='language-']{text-shadow:none;}}.css-1ybhd0e pre[class*='language-']{padding:1rem;overflow:auto;background:#1e1e1e;}.css-1ybhd0e:not(pre)>code[class*='language-']{padding:0.1em 0.3em;background:#1e1e1e;border-radius:0;border-radius:0.3em;}.css-1ybhd0e .namespace{opacity:0.7;}.css-1ybhd0e .token.doctype .token.doctype-tag{color:#569cd6;}.css-1ybhd0e .token.doctype .token.name{color:#9cdcfe;}.css-1ybhd0e .token.comment,.css-1ybhd0e .token.prolog{color:#6a9955;}.css-1ybhd0e .token.punctuation,.css-1ybhd0e .language-html .language-css .token.punctuation,.css-1ybhd0e .language-html .language-javascript .token.punctuation{color:#d4d4d4;}.css-1ybhd0e .token.property,.css-1ybhd0e .token.tag,.css-1ybhd0e .token.boolean,.css-1ybhd0e .token.number,.css-1ybhd0e .token.constant,.css-1ybhd0e .token.symbol,.css-1ybhd0e .token.inserted,.css-1ybhd0e .token.unit{color:#b5cea8;}.css-1ybhd0e .token.selector,.css-1ybhd0e .token.attr-name,.css-1ybhd0e .token.string,.css-1ybhd0e .token.char,.css-1ybhd0e .token.builtin,.css-1ybhd0e .token.deleted{color:#ce9178;}.css-1ybhd0e .language-css .token.string.url{-webkit-text-decoration:underline;text-decoration:underline;}.css-1ybhd0e .token.operator,.css-1ybhd0e .token.entity{color:#d4d4d4;}.css-1ybhd0e .token.operator.arrow{color:#569cd6;}.css-1ybhd0e .token.atrule{color:#ce9178;}.css-1ybhd0e .token.atrule .token.rule{color:#c586c0;}.css-1ybhd0e .token.atrule .token.url{color:#9cdcfe;}.css-1ybhd0e .token.atrule .token.url .token.function{color:#dcdcaa;}.css-1ybhd0e .token.atrule .token.url .token.punctuation{color:#d4d4d4;}.css-1ybhd0e .token.keyword{color:#569cd6;}.css-1ybhd0e .token.keyword.module,.css-1ybhd0e .token.keyword.control-flow{color:#c586c0;}.css-1ybhd0e .token.function,.css-1ybhd0e .token.function .token.maybe-class-name{color:#dcdcaa;}.css-1ybhd0e .token.regex{color:#d16969;}.css-1ybhd0e .token.important{color:#569cd6;}.css-1ybhd0e .token.italic{font-style:italic;}.css-1ybhd0e .token.constant{color:#9cdcfe;}.css-1ybhd0e .token.class-name,.css-1ybhd0e .token.maybe-class-name{color:#4ec9b0;}.css-1ybhd0e .token.console{color:#9cdcfe;}.css-1ybhd0e .token.parameter{color:#9cdcfe;}.css-1ybhd0e .token.interpolation{color:#9cdcfe;}.css-1ybhd0e .token.punctuation.interpolation-punctuation{color:#569cd6;}.css-1ybhd0e .token.boolean{color:#569cd6;}.css-1ybhd0e .token.property,.css-1ybhd0e .token.variable,.css-1ybhd0e .token.imports .token.maybe-class-name,.css-1ybhd0e .token.exports .token.maybe-class-name{color:#9cdcfe;}.css-1ybhd0e .token.selector{color:#d7ba7d;}.css-1ybhd0e .token.escape{color:#d7ba7d;}.css-1ybhd0e .token.tag{color:#569cd6;}.css-1ybhd0e .token.tag .token.punctuation{color:#808080;}.css-1ybhd0e .token.cdata{color:#808080;}.css-1ybhd0e .token.attr-name{color:#9cdcfe;}.css-1ybhd0e .token.attr-value,.css-1ybhd0e .token.attr-value .token.punctuation{color:#ce9178;}.css-1ybhd0e .token.attr-value .token.punctuation.attr-equals{color:#d4d4d4;}.css-1ybhd0e .token.entity{color:#569cd6;}.css-1ybhd0e .token.namespace{color:#4ec9b0;}.css-1ybhd0e pre[class*='language-javascript'],.css-1ybhd0e code[class*='language-javascript'],.css-1ybhd0e pre[class*='language-jsx'],.css-1ybhd0e code[class*='language-jsx'],.css-1ybhd0e pre[class*='language-typescript'],.css-1ybhd0e code[class*='language-typescript'],.css-1ybhd0e pre[class*='language-tsx'],.css-1ybhd0e code[class*='language-tsx']{color:#9cdcfe;}.css-1ybhd0e pre[class*='language-css'],.css-1ybhd0e code[class*='language-css']{color:#ce9178;}.css-1ybhd0e pre[class*='language-html'],.css-1ybhd0e code[class*='language-html']{color:#d4d4d4;}.css-1ybhd0e .language-regex .token.anchor{color:#dcdcaa;}.css-1ybhd0e .language-html .token.punctuation{color:#808080;}.css-1ybhd0e pre[class*='language-']>code[class*='language-']{position:relative;z-index:1;}.css-1ybhd0e .line-highlight.line-highlight{z-index:0;background:#f7ebc6;box-shadow:inset 5px 0 0 #f7d87c;}.css-1ybhd0e pre[class*='language-text'],.css-1ybhd0e code[class*='language-text']{padding:0.25rem;color:#000000;background-color:#e2e5e6;}@media (max-width: 768px){.css-1ybhd0e img{width:100%;}.css-1ybhd0e pre[class*='language-']{width:100%;overflow-x:auto;}}</style><div class="css-1ybhd0e e13plzdv0"><h1 id="tdd-기반-기능-구현-동시성-문제" style="position:relative;"><a href="#tdd-%EA%B8%B0%EB%B0%98-%EA%B8%B0%EB%8A%A5-%EA%B5%AC%ED%98%84-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C" aria-label="tdd 기반 기능 구현 동시성 문제 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TDD 기반 기능 구현 동시성 문제</h1>
<p>e-커머스 상품 주문 서비스 기능에서 동시에 요청이 발생 했을 때 야기되는 문제를 생각해보고 테스트 코드를 작성 해본다.</p>
<h2 id="재고-차감" style="position:relative;"><a href="#%EC%9E%AC%EA%B3%A0-%EC%B0%A8%EA%B0%90" aria-label="재고 차감 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>재고 차감</h2>
<p>주문 비즈니스 로직</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">OrderPostResponse</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderPostRequest</span> request <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 재고 차감</span>
        stockManager<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 주문</span>
        <span class="token class-name">Order</span> savedOrder <span class="token operator">=</span> orderAppender<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 잔액 차감</span>
        userManager<span class="token punctuation">.</span><span class="token function">deductPoint</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> savedOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 포인트 내역 저장</span>
        pointManager<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> savedOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 결제</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span>savedOrder<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Payment</span> savedPayment <span class="token operator">=</span> paymentRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        publisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PaymentEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>savedPayment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">OrderPostResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>savedOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div>
<p>여러 사용자가 동시에 주문을 요청할 때 , 상품의 재고 수량이 요청된 주문 만큼
잘 차감 되는지 확인을 해야 한다.</p>
<h3 id="테스트-코드-작성" style="position:relative;"><a href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1" aria-label="테스트 코드 작성 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>테스트 코드 작성</h3>
<p>주문 요청을 동시에 처리하는 코드를 작성 하기 위해 <code class="language-text">CompletableFuture</code> 클래스를 사용하였다.</p>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html" target="_blank" rel="nofollow">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html</a></p>
<p><code class="language-text">CompletableFuture</code> 클래스는 Java 에서 비동기적 및 동시성 작업을 처리하기 위한 클래스로 Future 와 CompletionStage 인터페이스를 구현하여 미래에 완료될
작업을 나타낸다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">deductQuantityWithConcurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token class-name">User</span> user1 <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"건희"</span><span class="token punctuation">,</span> <span class="token number">100000000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user2 <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"거니"</span><span class="token punctuation">,</span> <span class="token number">100000000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> savedUser1 <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> savedUser2 <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Product</span> product1 <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"양파"</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> product2 <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"감자"</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> product3 <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"당근"</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        productRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>product1<span class="token punctuation">,</span> product2<span class="token punctuation">,</span> product3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">ProductRequestForOrder</span> request1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>product1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">,</span> product1<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>product2<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">,</span> product2<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request3 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>product3<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">,</span> product3<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">ProductRequestForOrder</span> request4 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>product1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> product3<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request5 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>product2<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">,</span> product3<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request6 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>product3<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">,</span> product3<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">></span></span> requests1 <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request1<span class="token punctuation">,</span> request2<span class="token punctuation">,</span> request3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">></span></span> requests2 <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request4<span class="token punctuation">,</span> request5<span class="token punctuation">,</span> request6<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">OrderPostRequest</span> orderPostRequest1 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>savedUser1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">products</span><span class="token punctuation">(</span>requests1<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderPostRequest</span> orderPostRequest2 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>savedUser2<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">products</span><span class="token punctuation">(</span>requests2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// when</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>
             <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span> orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>orderPostRequest1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span> orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>orderPostRequest2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">></span></span> products <span class="token operator">=</span> productRepository<span class="token punctuation">.</span><span class="token function">findAllById</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>product1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> product2<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> product3<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> findProduct1 <span class="token operator">=</span> products<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> findProduct2 <span class="token operator">=</span> products<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> findProduct3 <span class="token operator">=</span> products<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>findProduct1<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">30L</span><span class="token operator">-</span><span class="token number">5L</span><span class="token operator">-</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>findProduct2<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">30L</span><span class="token operator">-</span><span class="token number">10L</span><span class="token operator">-</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>findProduct3<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">30L</span><span class="token operator">-</span><span class="token number">5L</span><span class="token operator">-</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<ul>
<li>CompletableFuture allOf 메서드 : 여러 작업을 동시에 실행하고, 모든 작업 결과에 콜백을 실행한다.</li>
<li>CompletableFuture runAsync 메서드 : 결과를 반환하는 작업을 비동기적으로 실행</li>
</ul>
<p>결과</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/9cc56873e8f0777bd2c8da78846ecabf/3e86e/image.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 36.45833333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAAA40lEQVR42p2Q23LCMAxE+Q9y891xDG5MAoH+/3dtV5TOtB3aBx52tN5IZxTt8nGGDwlNp9D2Gu1gENMR4yQqyKUi0sd0QKAce7WLUMbffceZ79p9AVVvoAgzlJUq707DiNgomXvkfrBwymL4BfsBrCbg6hJuPuFKbfSF2UY/24jFjrgwW1nlW2U2ao+mV8+BbzrgnY0XNmY2yqAaNPY8RSOnoPb9p2+4tYDavza0BE7cpnKbNUw4mIgTgZq/2D0Z+k93YIiEsJ7WDWVeMMaM8wPYvgL0BKZcMNcznCeIB1/ca8APcWPHgkecgmEAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/9cc56873e8f0777bd2c8da78846ecabf/a59e9/image.webp 192w,
/static/9cc56873e8f0777bd2c8da78846ecabf/0ca9f/image.webp 384w,
/static/9cc56873e8f0777bd2c8da78846ecabf/dc9b9/image.webp 768w,
/static/9cc56873e8f0777bd2c8da78846ecabf/9f8de/image.webp 1062w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/9cc56873e8f0777bd2c8da78846ecabf/3b721/image.png 192w,
/static/9cc56873e8f0777bd2c8da78846ecabf/66595/image.png 384w,
/static/9cc56873e8f0777bd2c8da78846ecabf/fe486/image.png 768w,
/static/9cc56873e8f0777bd2c8da78846ecabf/3e86e/image.png 1062w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/9cc56873e8f0777bd2c8da78846ecabf/fe486/image.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="실패-케이스" style="position:relative;"><a href="#%EC%8B%A4%ED%8C%A8-%EC%BC%80%EC%9D%B4%EC%8A%A4" aria-label="실패 케이스 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>실패 케이스</h3>
<ul>
<li>양파 , 감자, 당근 모두 30개 있다.</li>
<li>“건희” , “거니” 2명의 유저가 동시에 주문을 요청하였다.</li>
<li>“건희” 유저는 양파 5개, 감자 10개 , 당근 5개를 주문, “거니” 유저는 양파 3개 감자 5개 , 당근 5개를 주문하였다.</li>
<li>동시에 주문을 했기 때문에 하나의 주문을 통해 차감된 재고 수량을 가져오는 것이 아니라 2개의 주문 모두 주문이 들어오기 전 재고 수량인 30개를 DB에서 select 했다.</li>
<li>“거니” 유저가 “건희” 유저가 주문을 완료 이후 차감된 재고 25개에서 Select 한 것이 아니라 주문 전 수량 30개에서 select 했기 때문에 양파의 재고가 30개에서 건희 5개 , 거니 3개를 뺀 22개 아닌 27개 결과로 테스트에 실패한다.</li>
</ul>
<p>그러면 동시에 주문을 해도 주문 한 횟수만큼 재고를 차감하려면 어떻게 해야할까?
하나의 주문이 상품 정보를 읽고, 재고 차감 한 이후에 다른 주문이 상품 정보를 읽게 해야 한다.</p>
<p>그러기 위해서는 <code class="language-text">Lock</code> 을 사용해야 한다.</p>
<h3 id="lock" style="position:relative;"><a href="#lock" aria-label="lock permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lock</h3>
<p>낙관적 락 (Optimistic Lock) vs 비관적 락 (Pessimistic Lock)</p>
<h4 id="낙관적-락-optimistic-lock" style="position:relative;"><a href="#%EB%82%99%EA%B4%80%EC%A0%81-%EB%9D%BD-optimistic-lock" aria-label="낙관적 락 optimistic lock permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>낙관적 락 (Optimistic Lock)</h4>
<p>=> Commit 시에 수정이 일어나 version 이 변경되었다면 fail</p>
<ul>
<li>현실적으로 데이터 갱신 시 경합이 발생하지 않을 것이라고 보고 잠금을 거는 기법</li>
<li>낙관적 락은 데이터 베이스에서 제공하는 것이 아니라 어플리케이션 혹은 JPA 에서 제공을 해주는 기능이다.</li>
<li>낙관적은 충돌을 가정하지 않기 때문에 충돌에 대한 예외를 던져준다.</li>
</ul>
<h4 id="비관적-락-pessimistic-lock" style="position:relative;"><a href="#%EB%B9%84%EA%B4%80%EC%A0%81-%EB%9D%BD-pessimistic-lock" aria-label="비관적 락 pessimistic lock permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>비관적 락 (Pessimistic Lock)</h4>
<p>=> 사용중 일 때 Lock 을 걸어 다른 Connection 이 사용 못하도록 함</p>
<ul>
<li>동일한 데이터를 동시에 수정할 가능성이 높다는 관점으로 잠금을 거는 기법</li>
<li>비관적 락은 “데이터베이스 락 알고리즘” 을 통해 구현이 된다.</li>
</ul>
<p>※ DB Lock 이란?</p>
<blockquote>
<ol>
<li>DB 에서 Lock 이란, 무결성을 보장하기 위한 방법이다.</li>
<li>동시에 같은 데이터를 보고 있을 때 업데이트를 방지하기 위해 존재를 하며 락이 풀리기 전까지는 조작할 수 없다. commit 혹은 rollback 후에 풀리게 된다.</li>
<li>종류 로는 공유락, 베타락이 있다. 공유락은 데이터를 읽을 때 사용하는 락이며 베타적인 락은 데이터를 변경 할 때 사용 한다.</li>
</ol>
</blockquote>
<h4 id="pessimistic_read" style="position:relative;"><a href="#pessimistic_read" aria-label="pessimistic_read permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PESSIMISTIC_READ</h4>
<p>다른 트랜잭션에게 읽기만을 허용하는 <code class="language-text">LockModeType</code> 이다. <code class="language-text">Shared Lock</code> 을 이용해 락을 거는데 <code class="language-text">Shared Lock</code> 을 DB가 제공하지 않으면 <code class="language-text">PESSIMISTIC_WRITE</code> 와 동일하게 동작한다.</p>
<h4 id="pessimistic_write" style="position:relative;"><a href="#pessimistic_write" aria-label="pessimistic_write permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PESSIMISTIC_WRITE</h4>
<p>DB 에서 제공하는 행배타잠금(Row Exclusive Lock)을 이용해 잠금을 획득한다.
다른 트랜잭션에서는 쓰지도 읽지도 못한다.</p>
<h4 id="pessimistic_force_increment" style="position:relative;"><a href="#pessimistic_force_increment" aria-label="pessimistic_force_increment permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PESSIMISTIC_FORCE_INCREMENT</h4>
<p>DB 에서 제공하는 행 배타잠금(Row Exclusive Lock)을 이용해 잠금을 걸고 동시에
버전을 증가시킨다. 해당하는 엔티티에 변경은 없지만 하위 엔티티 갱신을 위해 잠금이 필요한 경우 사용할 수 있다.</p>
<h3 id="성공-케이스" style="position:relative;"><a href="#%EC%84%B1%EA%B3%B5-%EC%BC%80%EC%9D%B4%EC%8A%A4" aria-label="성공 케이스 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>성공 케이스</h3>
<p>동시에 주문을 했을 때 재고 차감하는 부분에서 충돌이 발생할 수 있기 때문에
비관적 락을 사용하였다.</p>
<p>재고 차감에 동시성 문제를 해결하려면 Lock 을 어디서 걸어줘야 할까?</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/bd70c95289d8d8f1273824eae93b7d5b/8e375/image-1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 60.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAACToAAAk6AGCYwUcAAAB3klEQVR42m1TW3LjMAzLQTaJbYl6y88m6Wzufx4fAYWYNk1m9wMjWjZBEKQPVgLOnUHNAWONmOcRORf4kNHedVLQuRHGZTifiMx3BdZF/WYwDqfz8MThcWFgBkFIFb5MECaMeUOJCyTNSNMFddowTiumeVO0YsZ69IN9J9SACs88tzjjXq/Y/IglViwssOYRzoW3pCPx59g9cTz1ijfCjrix6qcNuBmPixF89JZxgB88bbEYBkdFgo73rbOGptIYr/dKeNaqRhNCmVGmD6SRLVGh+IIYJmRP5ElbDry3EhFjUU8DT0804qfCNpRGGl3BlFaemQQjPBOE5vdUK99DaEpe231t+7dlVWjgJaEEDsFXrdqqN/MbWWKBFh9fvPwfDqful9DSP0fSnu0/fBJVpLDytiI/iv4hfLx4EOY6I3NtCk/1RhxS5F5ydSr9zYkr5ZKqHczDs5+Wn4QSkg6k6wXrdMNGLMsV1887lvWCpSy4zp+4bXesI5/XG663v7hsFw6Ju1oXFdFzAxrPQbj5hlOzrJypqqnIddVFbkicbqpt+hvyuEK/t5E5AZax40/QYGhV4znQq51T3AfrdhHZxfldfNz5i+0cDOPEOO2csMb0c2853WD1PH1Dnwe7fwHQlFmxD+yREgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/bd70c95289d8d8f1273824eae93b7d5b/a59e9/image-1.webp 192w,
/static/bd70c95289d8d8f1273824eae93b7d5b/0ca9f/image-1.webp 384w,
/static/bd70c95289d8d8f1273824eae93b7d5b/dc9b9/image-1.webp 768w,
/static/bd70c95289d8d8f1273824eae93b7d5b/e2c2f/image-1.webp 1152w,
/static/bd70c95289d8d8f1273824eae93b7d5b/f3efb/image-1.webp 1536w,
/static/bd70c95289d8d8f1273824eae93b7d5b/9ae61/image-1.webp 1757w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/bd70c95289d8d8f1273824eae93b7d5b/3b721/image-1.png 192w,
/static/bd70c95289d8d8f1273824eae93b7d5b/66595/image-1.png 384w,
/static/bd70c95289d8d8f1273824eae93b7d5b/fe486/image-1.png 768w,
/static/bd70c95289d8d8f1273824eae93b7d5b/d2d74/image-1.png 1152w,
/static/bd70c95289d8d8f1273824eae93b7d5b/e8464/image-1.png 1536w,
/static/bd70c95289d8d8f1273824eae93b7d5b/8e375/image-1.png 1757w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/bd70c95289d8d8f1273824eae93b7d5b/fe486/image-1.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>재고 차감하는 코드를 보자</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/508a7b7a62e35470889e9f1ac0b695e9/8ef96/image-3.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 34.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAABKUlEQVR42nWRXZKDIBCEvUj8AVRQRFQU4yZve/8r9TZs1VaSqn34GKgZmmamEFLBzRajHdB2HW6VQFXLTJkiz+ULt7J5o/zIF0IojKbHqHtou5IN1s6wk4cepkzaC9nlC3WjMo1oc/x8oEhFXT9i3SJmHzAvAX49sKw7nFuxhzv8vOVzym/hJBHhuCPsJ4bRQRtLJv7QUJCqrepYvMFR6DwuXPGiU4/ncuB7Cnj2Dk86jawZ6NYyZ3jueoNaqD/XqU2FUBoV7Xvn8YgnLore/Y647Pii60hX07RgMC47mma2hXvZGlQNvy26N4qGSxJdtcWDto92QOQ+9gNOPSKwHamwrBV7mIalMnUWa3/jC0WyKXlBSQOlBgihIfi6ZD8kRQVjnvjHNP/jB8FQzO2zv+9RAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/508a7b7a62e35470889e9f1ac0b695e9/a59e9/image-3.webp 192w,
/static/508a7b7a62e35470889e9f1ac0b695e9/0ca9f/image-3.webp 384w,
/static/508a7b7a62e35470889e9f1ac0b695e9/dc9b9/image-3.webp 768w,
/static/508a7b7a62e35470889e9f1ac0b695e9/e2c2f/image-3.webp 1152w,
/static/508a7b7a62e35470889e9f1ac0b695e9/f3efb/image-3.webp 1536w,
/static/508a7b7a62e35470889e9f1ac0b695e9/f63d8/image-3.webp 1960w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/508a7b7a62e35470889e9f1ac0b695e9/3b721/image-3.png 192w,
/static/508a7b7a62e35470889e9f1ac0b695e9/66595/image-3.png 384w,
/static/508a7b7a62e35470889e9f1ac0b695e9/fe486/image-3.png 768w,
/static/508a7b7a62e35470889e9f1ac0b695e9/d2d74/image-3.png 1152w,
/static/508a7b7a62e35470889e9f1ac0b695e9/e8464/image-3.png 1536w,
/static/508a7b7a62e35470889e9f1ac0b695e9/8ef96/image-3.png 1960w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/508a7b7a62e35470889e9f1ac0b695e9/fe486/image-3.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>재고 차감을 하기 전 상품 정보를 읽은 뒤 재고를 차감한다.
상품 정보를 읽는 부분에 락을 걸어주면 된다.</p>
<p>실제로 데이터에 엑세스 하기 전에 먼저 락을 걸어 충돌을 예방하기 위해 비관적 락을 사용하였다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductReader</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ProductRepository</span> productRepository<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">></span></span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">></span></span> productRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> productRepository<span class="token punctuation">.</span><span class="token function">findAllById</span><span class="token punctuation">(</span>productRequest<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ProductRequestForOrder</span><span class="token operator">::</span><span class="token function">getProductId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>기존 findAllById 메서드 대신</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Lock</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">PESSIMISTIC_WRITE</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">"SELECT p FROM Product p WHERE p.id IN :productIds"</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">></span></span> <span class="token function">findAllByPessimisticLock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"productIds"</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> productIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span></code></pre></div>
<p>비관적 락을 사용하기 위해 @Query 에 직접 sql 문을 작성하고</p>
<p>@Lock(value = LockModeType.PESSIMISTIC_WRITE) 어노테이션을 설정하였다.</p>
<p>결과</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/8a4d37684a8ee3f95989aa1198ae653d/0c0fb/image-10.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 49.479166666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAACToAAAk6AGCYwUcAAABIUlEQVR42p2S2U7DMBBF8x80reNsdrM4adKqEHUJqwQ88P8/c5nrAkK0otCHo3EWn1zPJNiN93h8esHz6xt24wP2wmZ769eb3R3aboluuUYvuKZD5RZo2h5l1aAo3REBXx62I4bNHtfD9ovVekC/ukGSWRhbekFuSsRJDh1niHR6ksAWNcy8AuuB7+saWgRZPvckqfHCVD7CdTiNjggKRv8FJmSlUKkYKooxnWnM1KH+5KxQRYmHR3ZNj3ax9OlOyf4kZF+YppZh1K7zfTS28Pd5xIuEhGtKmXYSqssTKpFxCFYGx0rh5+aJJLwSJv8Rcqq5KbyQvw+Hw99G6ww2MXDSAhtLWz6Of1aYiqCqW5+OG5iQPSWF4OS6khrJs3Cm8Q5c9CjbhUccdAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/8a4d37684a8ee3f95989aa1198ae653d/a59e9/image-10.webp 192w,
/static/8a4d37684a8ee3f95989aa1198ae653d/0ca9f/image-10.webp 384w,
/static/8a4d37684a8ee3f95989aa1198ae653d/dc9b9/image-10.webp 768w,
/static/8a4d37684a8ee3f95989aa1198ae653d/e2c2f/image-10.webp 1152w,
/static/8a4d37684a8ee3f95989aa1198ae653d/f3efb/image-10.webp 1536w,
/static/8a4d37684a8ee3f95989aa1198ae653d/e99cb/image-10.webp 2150w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/8a4d37684a8ee3f95989aa1198ae653d/3b721/image-10.png 192w,
/static/8a4d37684a8ee3f95989aa1198ae653d/66595/image-10.png 384w,
/static/8a4d37684a8ee3f95989aa1198ae653d/fe486/image-10.png 768w,
/static/8a4d37684a8ee3f95989aa1198ae653d/d2d74/image-10.png 1152w,
/static/8a4d37684a8ee3f95989aa1198ae653d/e8464/image-10.png 1536w,
/static/8a4d37684a8ee3f95989aa1198ae653d/0c0fb/image-10.png 2150w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/8a4d37684a8ee3f95989aa1198ae653d/fe486/image-10.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>상품을 조회할 때 쿼리를 보면 select ~ for update 가 실행 되어</p>
<p>행(row) 단위로 동시 접근을 제어한다.</p>
<p>그레서 동일 행에 대한 select .. for update 쿼리 실행시
먼저 락을 구한 커넥션을 실행을 하고, 락을 구하지 못한 커넥션은 락을 구한 커넥션이
트랜잭션을 종료할 때까지 대기한다.</p>
<h2 id="잔액-차감" style="position:relative;"><a href="#%EC%9E%94%EC%95%A1-%EC%B0%A8%EA%B0%90" aria-label="잔액 차감 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>잔액 차감</h2>
<p>한 사용자가 동시에 여러 주문을 할 때
(하나의 아이디를 A와 B가 같이 사용하고 동시에 주문을 함)</p>
<h3 id="테스트-코드-작성-1" style="position:relative;"><a href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1-1" aria-label="테스트 코드 작성 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>테스트 코드 작성</h3>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"> <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"동시에 상품을 주문 하여도 주문한 상품 횟수 만큼 잔액을 차감한다."</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">deductPointWithConcurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"건희"</span><span class="token punctuation">,</span> <span class="token number">50000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> savedUser <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Product</span> productOnion <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"양파"</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productPotato <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"감자"</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productCarrot <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"당근"</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productMushroom <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"버섯"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        productRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">,</span> productPotato<span class="token punctuation">,</span> productCarrot <span class="token punctuation">,</span>productMushroom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">ProductRequestForOrder</span> request1_1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">,</span> productOnion<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request1_2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">,</span> productPotato<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">ProductRequestForOrder</span> request2_1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productCarrot<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">,</span> productCarrot<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request2_2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productMushroom<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">,</span> productMushroom<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">></span></span> requests1 <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request1_1<span class="token punctuation">,</span> request1_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">></span></span> requests2 <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request2_1<span class="token punctuation">,</span> request2_2<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">OrderPostRequest</span> orderPostRequest1 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>savedUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">products</span><span class="token punctuation">(</span>requests1<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderPostRequest</span> orderPostRequest2 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>savedUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">products</span><span class="token punctuation">(</span>requests2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>
                <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span> orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>orderPostRequest1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span> orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>orderPostRequest2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> findUser <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>savedUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//then                현재 잔액 5000L  - (양파 2개 , 감자 2개)  / ( 당근 2개 , 버섯 2개)</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>findUser<span class="token punctuation">.</span><span class="token function">getCurrentPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">50000L</span><span class="token operator">-</span><span class="token number">6000L</span><span class="token operator">-</span><span class="token number">16000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<h3 id="실패-케이스-1" style="position:relative;"><a href="#%EC%8B%A4%ED%8C%A8-%EC%BC%80%EC%9D%B4%EC%8A%A4-1" aria-label="실패 케이스 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>실패 케이스</h3>
<p>“건희” 유저가 (양파 2개 , 감자 2개) , (당근 2개, 버섯 2개) 를 주문했는데</p>
<p>두 개의 주문 요청 모드 현재 잔액 50000L 포인트를 읽어서</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/495d1c76c653e088cd8515f9eb9dbc77/3753e/image-4.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 29.6875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAACToAAAk6AGCYwUcAAABCklEQVR42o2QTXKDMAyFOUjAgM2vMTakFCaUJiQknfb+vQKbsukBmFeZYd8svnnSSH6S7LydBnTE5frA+zihaU947XrULy2OTQdTNxuVzc0RRlcoywpK1xsFxcS6xcrMTk+PPm8PTB9fGK3p5YbzeKcBd9JpYzhf0Q8jjNIwhUapDNJcIZMKPE4RRukaxRm4SGYnp4aCkNRUqGqfaHZoE5tTzdZDHoP7HKlIN5IwhmAcwuerx0Ic3GB25N78L2QskxwtGXVRjpqn1ghJEEEEYmUUuyycnf0PnkJKDU1XNEkBIzIc2GZiIUNByu2GenmGgogytfCsXqLYENUSkHo+Xzzm/3gs+HVZ8P0HEuO1gXSw3YIAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/495d1c76c653e088cd8515f9eb9dbc77/a59e9/image-4.webp 192w,
/static/495d1c76c653e088cd8515f9eb9dbc77/0ca9f/image-4.webp 384w,
/static/495d1c76c653e088cd8515f9eb9dbc77/dc9b9/image-4.webp 768w,
/static/495d1c76c653e088cd8515f9eb9dbc77/e2c2f/image-4.webp 1152w,
/static/495d1c76c653e088cd8515f9eb9dbc77/f3efb/image-4.webp 1536w,
/static/495d1c76c653e088cd8515f9eb9dbc77/92932/image-4.webp 2260w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/495d1c76c653e088cd8515f9eb9dbc77/3b721/image-4.png 192w,
/static/495d1c76c653e088cd8515f9eb9dbc77/66595/image-4.png 384w,
/static/495d1c76c653e088cd8515f9eb9dbc77/fe486/image-4.png 768w,
/static/495d1c76c653e088cd8515f9eb9dbc77/d2d74/image-4.png 1152w,
/static/495d1c76c653e088cd8515f9eb9dbc77/e8464/image-4.png 1536w,
/static/495d1c76c653e088cd8515f9eb9dbc77/3753e/image-4.png 2260w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/495d1c76c653e088cd8515f9eb9dbc77/fe486/image-4.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>잔액은 1번만 차감되었기 때문에 실패 하였다.</p>
<h3 id="성공-케이스-1" style="position:relative;"><a href="#%EC%84%B1%EA%B3%B5-%EC%BC%80%EC%9D%B4%EC%8A%A4-1" aria-label="성공 케이스 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>성공 케이스</h3>
<p>재고 차감과 마찬 가지로 비관적 락을 사용하자</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0626f24961b86d144bd80ae08d7f300f/a4847/image-5.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 67.70833333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAACToAAAk6AGCYwUcAAACAklEQVR42o1T23abMBD0h4SbBLoCBhE7duwmOXnq///QdFaY1G5PevowWt1Y7cwsu0Z3sD6g7Sw649GoDkVRoSwbos4oiKeCsbhFnj3d5mWlHrCLweEw90hpQlpm+H4PEwbUNqJ0Mxqf0LkBPqwIkec2cD4yetRN+5iw5mB5IfZTTrSYiJ8h4dOOOPPjOC7oxxnDMGPcp4y2c1DaZDZVrR8TFhza1mOKCYOf4TgfXI/eRfShR6PXCoSmQOYb3Yyy/trPCWUwnccYJwTTwzFZx4oNK3WkaviAUiZXpVubKSptc4WyFsh6qzQn1DTDUjsbx0y7IhWtPKuN8ERO7ntYPqZbxzkfsre9vB+/tMyUg3a4hBlnUl544cjkMy9ZH6Fak2PgY5rzB7p3eNBwZMJPP+GDeAt7/GCVZye0faYv7koVVf3b0arSf7XMSrlWLFf0CNTCo6RejfTjrSdFO+lP0ezemO+wakhhHR3dhK74kWq4363ib/uik8R71/98ZCfuDGPC5fUdS3rB5fqB4/GMNC04LRdcDm+4Ht9xer6y+V9wPEk85AYXd8Wk7THBTolrdmDvJQTH1ulnNvKCOCREmhEHWacch/0zE025P6WIkev9fMjnjbQSc1FDjZbN640h7fXXEkS6Km0hhshfJLGi3mVJulXzPWURXpJW/4F/mbEl/AVKiJNlkzbvzwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/0626f24961b86d144bd80ae08d7f300f/a59e9/image-5.webp 192w,
/static/0626f24961b86d144bd80ae08d7f300f/0ca9f/image-5.webp 384w,
/static/0626f24961b86d144bd80ae08d7f300f/dc9b9/image-5.webp 768w,
/static/0626f24961b86d144bd80ae08d7f300f/e2c2f/image-5.webp 1152w,
/static/0626f24961b86d144bd80ae08d7f300f/f3efb/image-5.webp 1536w,
/static/0626f24961b86d144bd80ae08d7f300f/a517d/image-5.webp 1685w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/0626f24961b86d144bd80ae08d7f300f/3b721/image-5.png 192w,
/static/0626f24961b86d144bd80ae08d7f300f/66595/image-5.png 384w,
/static/0626f24961b86d144bd80ae08d7f300f/fe486/image-5.png 768w,
/static/0626f24961b86d144bd80ae08d7f300f/d2d74/image-5.png 1152w,
/static/0626f24961b86d144bd80ae08d7f300f/e8464/image-5.png 1536w,
/static/0626f24961b86d144bd80ae08d7f300f/a4847/image-5.png 1685w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/0626f24961b86d144bd80ae08d7f300f/fe486/image-5.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>유저의 잔액 정보를 읽는 로직을</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token keyword">new</span> <span class="token class-name">EntityNotFoundException</span><span class="token punctuation">(</span><span class="token constant">USER_NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<p>비관적 락이 설정된 메서드로 변경하였다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>

    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">findByName</span><span class="token punctuation">(</span><span class="token class-name">String</span>  name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Lock</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">PESSIMISTIC_WRITE</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">"select u from User u where u.id = :userId"</span><span class="token punctuation">)</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">findByIdPessimisticLock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">   <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findByIdPessimisticLock</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token keyword">new</span> <span class="token class-name">EntityNotFoundException</span><span class="token punctuation">(</span><span class="token constant">USER_NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<p>결과</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e9aa85f4434e20e9c4c909f1d1275225/707c8/image-6.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 24.479166666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAACToAAAk6AGCYwUcAAAAz0lEQVR42lWQ646CMBSE+yIu9CIKtFi5iEswkt1o9v1faHZONQF/fJnpaTrTHBXbHuP3jGm+Yxgn9JcJ3XBFiB3q5vxJiKsmH1f/PqvhOuH38Yfl58nQBfNtwYUFXTugJ6dwJhGNPyHUDTzZ6haZqchH8qO2HxPiZeargLr00JmBye1KZmFJmovnzOUuqdyris0lk0WTf2umHYpjDVeU0GYP6w4wtoDdH5PX9Ia6Y/DuS7+UKM+dbJFdSOCBYRWLHAPES0huXAoVpETIWbzlH1wLlk6FumdBAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/e9aa85f4434e20e9c4c909f1d1275225/a59e9/image-6.webp 192w,
/static/e9aa85f4434e20e9c4c909f1d1275225/0ca9f/image-6.webp 384w,
/static/e9aa85f4434e20e9c4c909f1d1275225/dc9b9/image-6.webp 768w,
/static/e9aa85f4434e20e9c4c909f1d1275225/e2c2f/image-6.webp 1152w,
/static/e9aa85f4434e20e9c4c909f1d1275225/f3efb/image-6.webp 1536w,
/static/e9aa85f4434e20e9c4c909f1d1275225/5f914/image-6.webp 3072w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/e9aa85f4434e20e9c4c909f1d1275225/3b721/image-6.png 192w,
/static/e9aa85f4434e20e9c4c909f1d1275225/66595/image-6.png 384w,
/static/e9aa85f4434e20e9c4c909f1d1275225/fe486/image-6.png 768w,
/static/e9aa85f4434e20e9c4c909f1d1275225/d2d74/image-6.png 1152w,
/static/e9aa85f4434e20e9c4c909f1d1275225/e8464/image-6.png 1536w,
/static/e9aa85f4434e20e9c4c909f1d1275225/707c8/image-6.png 3072w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/e9aa85f4434e20e9c4c909f1d1275225/fe486/image-6.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="의문점" style="position:relative;"><a href="#%EC%9D%98%EB%AC%B8%EC%A0%90" aria-label="의문점 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>의문점</h3>
<p>비관적 락을 적용하기 위해 관련 자료를 찾아보던 중 비관적 락을 사용했을 때 데드락 발생 가능성이 있다고 하였다.</p>
<p>하지만 내가 작성한 코드에는 데드락이 발생하지 않아서 왜 데드락이 발생하지 않는지
생각해보았다.</p>
<p>내가 락을 설정한 쿼리를 보면</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@Lock</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">PESSIMISTIC_WRITE</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">"SELECT p FROM Product p WHERE p.id IN :productIds "</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">></span></span> <span class="token function">findAllByPessimisticLock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"productIds"</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> productIds<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>이 코드는 상품 조회 시 where ~ In 절을 사용하여 데이터를 한 번에 가져온다.</p>
<p>예를 들어, A 유저가 상품 1,2,3,4를 조회한 후 락을 설정한다면, B 유저가 상품 2,1,4,5,6을 조회하려 할 때 락이 이미 걸려있어서 B 유저는 락을 기다리게 됩니다. 이러한 상황에서는 B 유저만 락을 기다리므로 데드락이 발생하지 않을 것이라고 유추하였다.</p>
<p>그렇다면 , 데드락이 발생하는 코드는 어떤 것일까?</p>
<p>상품을 조회할 때 where ~ In 절로 한 번에 가져오는 것이 아니라 반복문을 통해 1개씩 조회하는 경우라고 생각하였다.</p>
<p>A 유저가 상품 1,2,3,4를 조회하는데, 우선 상품 1을 조회합니다. 이때, B 유저는 2,1,4,5,6를 조회하는데, 우선 상품 2를 조회합니다. 그 다음 A 유저가 상품 2를 조회하려 하는데 B가 락을 선점했기 때문에 락 해제를 기다리게 됩니다. 그리고 B 유저가 상품 1을 조회하려 하는데 A가 상품 1에 대한 락을 선점했기 때문에 락 해제를 기다리게 됩니다.</p>
<p>A 유저와 B 유저 모두 서로 락이 해제되기만을 기다리기 때문에 데드락이 발생한다.</p>
<p>내가 유추한 것이 맞는지 확인하기 위해 테스트 코드를 작성해보았다.</p>
<h4 id="테스트-코드" style="position:relative;"><a href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C" aria-label="테스트 코드 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>테스트 코드</h4>
<p>재고 차감하는 로직</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct2</span><span class="token punctuation">(</span><span class="token class-name">OrderPostRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">></span></span> requestForOrders <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProductRequestForOrder</span> requestForOrder <span class="token operator">:</span> requestForOrders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Product</span> findProduct <span class="token operator">=</span> productRepository<span class="token punctuation">.</span><span class="token function">findByIdPessimisticLock</span><span class="token punctuation">(</span>requestForOrder<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">EntityNotFoundException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> stock <span class="token operator">=</span> requestForOrder<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            findProduct<span class="token punctuation">.</span><span class="token function">deductQuantity</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre></div>
<p>반복문을 통해 상품을 하나 씩 조회한 뒤, 재고 차감을 진행하는 코드로 변경하였다.</p>
<p>락 설정은 아래와 같이 설정하였다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">  <span class="token annotation punctuation">@Lock</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">PESSIMISTIC_WRITE</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">"SELECT p FROM Product p WHERE p.id = :productId "</span><span class="token punctuation">)</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">></span></span> <span class="token function">findByIdPessimisticLock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"productId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>그리고 테스트 코드를 다음과 같이 작성하였다.</p>
<p>“건희” 유저가 양파 3개, 감자 3개 주문</p>
<p>“거니” 유저가 감자 3개, 양파 3개 주문</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">   <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"동시에 주문을 했을 때 주문에 맞게 재고를 차감한다. 데드락 테스트"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RepeatedTest</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">deductQuantityWithConCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token class-name">Product</span> productOnion <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"양파"</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productPotato <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"감자"</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productCarrot <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"당근"</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productMushroom <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"버섯"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        productRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">,</span>productPotato<span class="token punctuation">,</span>productCarrot<span class="token punctuation">,</span>productMushroom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> geonhee <span class="token operator">=</span> <span class="token class-name">FakeUser</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"건희"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> gunny <span class="token operator">=</span> <span class="token class-name">FakeUser</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"거니"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 양파 3개 , 감자 3개 주문</span>
        <span class="token class-name">ProductRequestForOrder</span> request1_1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productOnion<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request1_2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productPotato<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 감자 3개 , 양파 3개 주문</span>
        <span class="token class-name">ProductRequestForOrder</span> request2_1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productPotato<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request2_2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productOnion<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderPostRequest</span> requests1 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span>
                <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>geonhee<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request1_1<span class="token punctuation">,</span> request1_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderPostRequest</span> requests2 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span>
                <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>gunny<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request2_1<span class="token punctuation">,</span> request2_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>
                <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>  fakeStockManager<span class="token punctuation">.</span><span class="token function">deduct2</span><span class="token punctuation">(</span>requests1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>  fakeStockManager<span class="token punctuation">.</span><span class="token function">deduct2</span><span class="token punctuation">(</span>requests2<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Product</span> findProductPotato <span class="token operator">=</span> productRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//then</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertThat</span><span class="token punctuation">(</span>findProductPotato<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">30L</span><span class="token operator">-</span><span class="token number">3L</span><span class="token operator">-</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<h4 id="결과" style="position:relative;"><a href="#%EA%B2%B0%EA%B3%BC" aria-label="결과 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>결과</h4>
<p>예상한 대로 데드락이 발생한다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c1fe7356b6366d66e1a0934782bb31ca/e4ca2/image-7.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 21.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAACToAAAk6AGCYwUcAAAAf0lEQVR42nWOaxKDIAyEOYhKIAmirb3/7bYLra06449vNvsYhvBcN5gWqM3IRL0iUTvMT3dn94f+sAueHXNyVJrKkYnBRal/lJRkKOz2zDtXrwiFr1erWB8vLMsGYShREWPu+rtbLu3eu3zaNW1dEP5wmATD+GFi0Ri/eufveAMCD2/LR68tbgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/c1fe7356b6366d66e1a0934782bb31ca/a59e9/image-7.webp 192w,
/static/c1fe7356b6366d66e1a0934782bb31ca/0ca9f/image-7.webp 384w,
/static/c1fe7356b6366d66e1a0934782bb31ca/dc9b9/image-7.webp 768w,
/static/c1fe7356b6366d66e1a0934782bb31ca/e2c2f/image-7.webp 1152w,
/static/c1fe7356b6366d66e1a0934782bb31ca/b78e0/image-7.webp 1312w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/c1fe7356b6366d66e1a0934782bb31ca/3b721/image-7.png 192w,
/static/c1fe7356b6366d66e1a0934782bb31ca/66595/image-7.png 384w,
/static/c1fe7356b6366d66e1a0934782bb31ca/fe486/image-7.png 768w,
/static/c1fe7356b6366d66e1a0934782bb31ca/d2d74/image-7.png 1152w,
/static/c1fe7356b6366d66e1a0934782bb31ca/e4ca2/image-7.png 1312w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/c1fe7356b6366d66e1a0934782bb31ca/fe486/image-7.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>만약에</p>
<p>주문을 “건희” , “거니” 유저 모두 양파 3개, 감자 3개 순서대로 주문한다면??</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">        <span class="token class-name">User</span> geonhee <span class="token operator">=</span> <span class="token class-name">FakeUser</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"건희"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> gunny <span class="token operator">=</span> <span class="token class-name">FakeUser</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"거니"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 양파 3개 , 감자 3개 주문</span>
        <span class="token class-name">ProductRequestForOrder</span> request1_1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productOnion<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request1_2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productPotato<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 양파 3개 , 감자 3개 주문</span>
        <span class="token class-name">ProductRequestForOrder</span> request2_1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productOnion<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request2_2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productPotato<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderPostRequest</span> requests1 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span>
                <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>geonhee<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request1_1<span class="token punctuation">,</span> request1_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderPostRequest</span> requests2 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span>
                <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>gunny<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request2_1<span class="token punctuation">,</span> request2_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>
                <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>  fakeStockManager<span class="token punctuation">.</span><span class="token function">deduct4</span><span class="token punctuation">(</span>requests1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>  fakeStockManager<span class="token punctuation">.</span><span class="token function">deduct4</span><span class="token punctuation">(</span>requests2<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>운 좋게 데드락이 발생하지 않을 수 있으니 테스트를 100번 수행하게 했지만</p>
<p>데드락이 발생하지 않았다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/b2a21/image-8.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 59.895833333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAACToAAAk6AGCYwUcAAABiklEQVR42o2T63KCMBCFeY8KCCrKHQ3IxQuKqB3bmb7/05zuLjKVqU7740xgk3zZPdlo8TJFtq6w2R2R5RVWaY4oUQjjFYJo+SP6D+96jPthMpCm1gUOpwvay03UtO+ojy2OFNvWDYrNHiorOtFhCzfAfEGikb+njjsQAUvUTYvb5xcu1w/sDy129UnGalvLqNIClu3A8yOMrSl0w8JIH0PXLfl+lOb6IdQ6J0iDvNxJ2nK6F4q4RF7DiwOai8kOl8CWPYNh2DDMoTQviJEWJQ7NWTJiTxna+5OsMgFzRgyfUVm80RxPfsEGQPatJL8i2uTdDea5eJmJV1wqlzybu09BL4C13DDH+lvjjLlEztIlSalm59efwL7kHthlmAqMQRyTtqHRnsz+B0x+ATsP30YmwRRWqmsd9vKZjwPgZneQS3gG5MWuF8EPEvFz9Kpk9kflBfXbCeW285BjDOuB3Eb2xBEPOTMGvryUpVqj2tc4X2/yOvJiA47xy2C/eg8Nc0IvxBdNncVL4Dff62wYWN9tPwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/a59e9/image-8.webp 192w,
/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/0ca9f/image-8.webp 384w,
/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/dc9b9/image-8.webp 768w,
/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/2bb8d/image-8.webp 987w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/3b721/image-8.png 192w,
/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/66595/image-8.png 384w,
/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/fe486/image-8.png 768w,
/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/b2a21/image-8.png 987w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/fe486/image-8.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>그렇다면, 제일 처음 유추 한대로</p>
<p>where ~ In 절에 락을 걸었을 때도 테스트를 진행 해보면</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token class-name">OrderPostRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">></span></span> requestForOrders <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> productIdQuntitiyMap <span class="token operator">=</span> <span class="token function">convertToProductIdQuantityMap</span><span class="token punctuation">(</span>requestForOrders<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">></span></span> products <span class="token operator">=</span> fakeProductReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Product</span> product <span class="token operator">:</span> products<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> quantity <span class="token operator">=</span> productIdQuntitiyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            product<span class="token punctuation">.</span><span class="token function">deductQuantity</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        productRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>products<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">   <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">></span></span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">></span></span> productRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> productRepository<span class="token punctuation">.</span><span class="token function">findAllByPessimisticLock</span><span class="token punctuation">(</span>productRequest<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ProductRequestForOrder</span><span class="token operator">::</span><span class="token function">getProductId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"동시에 주문을 했을 때 주문에 맞게 재고를 차감한다. 데드락 테스트"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RepeatedTest</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">deductQuantityWithConCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token class-name">Product</span> productOnion <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"양파"</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productPotato <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"감자"</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productCarrot <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"당근"</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> productMushroom <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"버섯"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        productRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">,</span>productPotato<span class="token punctuation">,</span>productCarrot<span class="token punctuation">,</span>productMushroom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> geonhee <span class="token operator">=</span> <span class="token class-name">FakeUser</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"건희"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> gunny <span class="token operator">=</span> <span class="token class-name">FakeUser</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"거니"</span><span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 양파 3개 , 감자 3개 주문</span>
        <span class="token class-name">ProductRequestForOrder</span> request1_1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productOnion<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request1_2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productPotato<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 감자 3개 , 양파 3개 주문</span>
        <span class="token class-name">ProductRequestForOrder</span> request2_1 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productOnion<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productOnion<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductRequestForOrder</span> request2_2 <span class="token operator">=</span> <span class="token class-name">ProductRequestForOrder</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> productPotato<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderPostRequest</span> requests1 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span>
                <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>geonhee<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request1_1<span class="token punctuation">,</span> request1_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderPostRequest</span> requests2 <span class="token operator">=</span> <span class="token class-name">OrderPostRequest</span>
                <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>gunny<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>request2_1<span class="token punctuation">,</span> request2_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>
                <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>  fakeStockManager<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>requests1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>  fakeStockManager<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>requests2<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Product</span> findProductPotato <span class="token operator">=</span> productRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>productPotato<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//then</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertThat</span><span class="token punctuation">(</span>findProductPotato<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">30L</span><span class="token operator">-</span><span class="token number">3L</span><span class="token operator">-</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<h4 id="결과-1" style="position:relative;"><a href="#%EA%B2%B0%EA%B3%BC-1" aria-label="결과 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>결과</h4>
<p>상품들의 한 번에 조회하기 때문에</p>
<p>데드락이 발생하지 않는다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/06cc84f16b9343dc090abe68c8799d4e/9708d/image-9.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 35.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAABK0lEQVR42m2RWY6DMBBEuUjYQ8IOwYkJSwTZpbn/afio6W5nNIw0H08uW3S5ylhK97g+3ni8vvAkbqRv9zem6xPD5Qp9PENXCk1Ro0xLHLIKFa1FnBE5SkJ0IutiZWWNdhgx314YxglH3eHU9mhUi1ppxPRhSkOu48PeuAab8eB8WOnF2qc5Tl1Phk+o0xk7ui1OCyQZpaBkXhAhjGIkdBaEO2x3Cba0D7Z7Ifwh2sNxg8XiwYaMhnGGOrZilOaVUFSNXMBmnhfC8yMyS3jwX2zHZ8MCuh/l3TRVXRuWtZI0bMrpeMglY0ZMvM/eNWdiyPWU/ptQ4IRk6IcmFb8lm0ZUmSuyZow2taVyWlTQ3YBpvuPcXZCXByGjv7qubGqFYrKhH8BQol9tWL4BSk3S5xy7UKYAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/06cc84f16b9343dc090abe68c8799d4e/a59e9/image-9.webp 192w,
/static/06cc84f16b9343dc090abe68c8799d4e/0ca9f/image-9.webp 384w,
/static/06cc84f16b9343dc090abe68c8799d4e/dc9b9/image-9.webp 768w,
/static/06cc84f16b9343dc090abe68c8799d4e/e2c2f/image-9.webp 1152w,
/static/06cc84f16b9343dc090abe68c8799d4e/9ac9d/image-9.webp 1160w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/06cc84f16b9343dc090abe68c8799d4e/3b721/image-9.png 192w,
/static/06cc84f16b9343dc090abe68c8799d4e/66595/image-9.png 384w,
/static/06cc84f16b9343dc090abe68c8799d4e/fe486/image-9.png 768w,
/static/06cc84f16b9343dc090abe68c8799d4e/d2d74/image-9.png 1152w,
/static/06cc84f16b9343dc090abe68c8799d4e/9708d/image-9.png 1160w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/06cc84f16b9343dc090abe68c8799d4e/fe486/image-9.png"
            alt="Alt text"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p></div><style data-emotion="css hx9xpc">@media (max-width: 768px){.css-hx9xpc{padding:0 20px;}}</style><div class="css-hx9xpc e12j4d8y0"></div><style data-emotion="css fmunkh">.css-fmunkh{position:absolute;top:0;left:768px;height:100%;padding-left:4rem;}@media (max-width: 1400px){.css-fmunkh{display:none;}}</style><aside class="css-fmunkh ek4ynda1"><style data-emotion="css 1s5ilwz">.css-1s5ilwz{position:-webkit-sticky;position:sticky;top:6rem;width:240px;overflow:hidden;font-size:0.8rem;}.css-1s5ilwz p{margin:0;}.css-1s5ilwz a{display:block;padding:0.5rem;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;border-radius:4px;-webkit-transition:all 0.1s ease-out;transition:all 0.1s ease-out;}.css-1s5ilwz a:hover{background-color:#badcff;}.css-1s5ilwz ul:first-child{border-left:none;}.css-1s5ilwz ul{margin-left:0.5rem;padding:0 0.5rem;list-style:none;border-left:2px solid #e2e5e6;}</style><nav class="css-1s5ilwz ek4ynda0"><ul>
<li>
<p><a href="#tdd-%EA%B8%B0%EB%B0%98-%EA%B8%B0%EB%8A%A5-%EA%B5%AC%ED%98%84-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C">TDD 기반 기능 구현 동시성 문제</a></p>
<ul>
<li>
<p><a href="#%EC%9E%AC%EA%B3%A0-%EC%B0%A8%EA%B0%90">재고 차감</a></p>
<ul>
<li>
<p><a href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1">테스트 코드 작성</a></p>
</li>
<li>
<p><a href="#%EC%8B%A4%ED%8C%A8-%EC%BC%80%EC%9D%B4%EC%8A%A4">실패 케이스</a></p>
</li>
<li>
<p><a href="#lock">Lock</a></p>
<ul>
<li><a href="#%EB%82%99%EA%B4%80%EC%A0%81-%EB%9D%BD-optimistic-lock">낙관적 락 (Optimistic Lock)</a></li>
<li><a href="#%EB%B9%84%EA%B4%80%EC%A0%81-%EB%9D%BD-pessimistic-lock">비관적 락 (Pessimistic Lock)</a></li>
<li><a href="#pessimistic_read">PESSIMISTIC_READ</a></li>
<li><a href="#pessimistic_write">PESSIMISTIC_WRITE</a></li>
<li><a href="#pessimistic_force_increment">PESSIMISTIC_FORCE_INCREMENT</a></li>
</ul>
</li>
<li>
<p><a href="#%EC%84%B1%EA%B3%B5-%EC%BC%80%EC%9D%B4%EC%8A%A4">성공 케이스</a></p>
</li>
</ul>
</li>
<li>
<p><a href="#%EC%9E%94%EC%95%A1-%EC%B0%A8%EA%B0%90">잔액 차감</a></p>
<ul>
<li>
<p><a href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1-1">테스트 코드 작성</a></p>
</li>
<li>
<p><a href="#%EC%8B%A4%ED%8C%A8-%EC%BC%80%EC%9D%B4%EC%8A%A4-1">실패 케이스</a></p>
</li>
<li>
<p><a href="#%EC%84%B1%EA%B3%B5-%EC%BC%80%EC%9D%B4%EC%8A%A4-1">성공 케이스</a></p>
</li>
<li>
<p><a href="#%EC%9D%98%EB%AC%B8%EC%A0%90">의문점</a></p>
<ul>
<li><a href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C">테스트 코드</a></li>
<li><a href="#%EA%B2%B0%EA%B3%BC">결과</a></li>
<li><a href="#%EA%B2%B0%EA%B3%BC-1">결과</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></nav></aside></div><style data-emotion="css 3xgn3f">.css-3xgn3f{display:grid;place-items:center;margin-top:auto;padding:50px 0;font-size:15px;color:#aaa;font-weight:bold;text-align:center;line-height:1.5;background-color:#f0f0f0;}@media (max-width: 768px){.css-3xgn3f{font-size:13px;}}</style><div class="css-3xgn3f ehmnl590"><br/>© 2023 박건희 Powered By Gatsby.</div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/항해플러스/동시성문제/pessimistic-lock/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-11e3db64e010c7ace7b9.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-e0c32f7568409678d965.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-5d7d9b297e49292a0605.js\"],\"component---src-templates-post-template-tsx\":[\"/component---src-templates-post-template-tsx-cb73f70df489f33d96a5.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="e22d7df6bab760474b53";</script><script src="/webpack-runtime-e4e282c4b34170b3f4c3.js" async></script><script src="/framework-3fd3aa0b19c33d97812d.js" async></script><script src="/app-11e3db64e010c7ace7b9.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>