{"componentChunkName":"component---src-templates-post-template-tsx","path":"/항해플러스/e-commerce/상위상품조회/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EC%83%81%EC%9C%84-%EC%83%81%ED%92%88-%EC%A1%B0%ED%9A%8C-%EA%B8%B0%EB%8A%A5-%EC%B6%94%EA%B0%80--%EC%BD%94%EB%93%9C-%EC%A0%90%EC%A7%84%EC%A0%81%EC%9C%BC%EB%A1%9C-%EA%B0%9C%EC%84%A0%ED%95%98%EA%B8%B0\">상위 상품 조회 기능 추가 , 코드 점진적으로 개선하기</a></p>\n<ul>\n<li>\n<p><a href=\"#%EC%83%81%EC%9C%84-%EC%83%81%ED%92%88-%EC%A1%B0%ED%9A%8C-%EA%B8%B0%EB%8A%A5-%EC%B6%94%EA%B0%80\">상위 상품 조회 기능 추가</a></p>\n<ul>\n<li>\n<p><a href=\"#orderproductrepository-%EC%97%90-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%B6%94%EA%B0%80\">OrderProductRepository 에 메서드 추가</a></p>\n<ul>\n<li><a href=\"#%EC%8B%9C%EA%B0%84-%EC%9D%98%EC%A1%B4%EC%84%B1-%EC%A3%BC%EC%9E%85%ED%95%98%EA%B8%B0\">시간 의존성 주입하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1\">테스트 코드 작성</a></p>\n<ul>\n<li><a href=\"#test-fixture\">Test Fixture</a></li>\n<li><a href=\"#beforeall-vs-beforeeach\">@BeforeAll vs @BeforeEach</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%83%81%EC%9C%84-%EC%83%81%ED%92%88-%EB%B9%84%EC%A6%88%EB%8B%88%EC%8A%A4-%EB%A1%9C%EC%A7%81\">상위 상품 비즈니스 로직</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C\">테스트 코드</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#%EA%B2%B0%EA%B3%BC\">결과</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%BA%90%EC%8B%B1-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\">캐싱 적용하기</a></p>\n<ul>\n<li><a href=\"#%EC%8A%A4%ED%94%84%EB%A7%81-%EB%B6%80%ED%8A%B8-cache-%EC%A0%81%EC%9A%A9\">스프링 부트 Cache 적용</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%BD%94%EB%93%9C-%EC%A0%90%EC%A7%84%EC%A0%81%EC%9C%BC%EB%A1%9C-%EA%B0%9C%EC%84%A0%ED%95%98%EA%B8%B0\">코드 점진적으로 개선하기</a></p>\n<ul>\n<li><a href=\"#%EC%A3%BC%EB%AC%B8%ED%95%98%EA%B8%B0-%EB%A1%9C%EC%A7%81-%EA%B4%80%EC%8B%AC%EC%82%AC-%EB%B6%84%EB%A6%AC-%EC%9D%91%EC%A7%91%EB%8F%84-%EB%86%92%EC%9D%B4%EA%B8%B0\">주문하기 로직 관심사 분리, 응집도 높이기</a></li>\n<li><a href=\"#%EC%9E%94%EC%95%A1%EA%B3%BC-%EC%B4%9D-%EA%B0%80%EA%B2%A9-%EB%B9%84%EA%B5%90--%EC%9E%94%EC%95%A1-%EC%B0%A8%EA%B0%90-%ED%86%B5%ED%95%A9%ED%95%98%EA%B8%B0\">잔액과 총 가격 비교 , 잔액 차감 통합하기</a></li>\n<li><a href=\"#%EA%B0%9C%EC%84%A0-%ED%95%B4%EC%95%BC-%ED%95%A0-%EC%A0%90\">개선 해야 할 점</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>\n</li>\n</ul>","html":"<h1 id=\"상위-상품-조회-기능-추가--코드-점진적으로-개선하기\" style=\"position:relative;\"><a href=\"#%EC%83%81%EC%9C%84-%EC%83%81%ED%92%88-%EC%A1%B0%ED%9A%8C-%EA%B8%B0%EB%8A%A5-%EC%B6%94%EA%B0%80--%EC%BD%94%EB%93%9C-%EC%A0%90%EC%A7%84%EC%A0%81%EC%9C%BC%EB%A1%9C-%EA%B0%9C%EC%84%A0%ED%95%98%EA%B8%B0\" aria-label=\"상위 상품 조회 기능 추가  코드 점진적으로 개선하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>상위 상품 조회 기능 추가 , 코드 점진적으로 개선하기</h1>\n<ul>\n<li>최근 3일간 가장 많이 팔린 상위 상품 정보를 제공하는 기능 추가하기</li>\n<li>테스트하기 좋은 코드,설계를 고민하고 개선하기</li>\n</ul>\n<h2 id=\"상위-상품-조회-기능-추가\" style=\"position:relative;\"><a href=\"#%EC%83%81%EC%9C%84-%EC%83%81%ED%92%88-%EC%A1%B0%ED%9A%8C-%EA%B8%B0%EB%8A%A5-%EC%B6%94%EA%B0%80\" aria-label=\"상위 상품 조회 기능 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>상위 상품 조회 기능 추가</h2>\n<p>최근 3일간 가장 많이 팔린 상품 정보는</p>\n<p>주문한 상품 내역 정보가 있는 OrderProduct 엔티티에서 구하면 된다.</p>\n<p>주문 번호와 상품 식별 번호 , 주문 한 상품 개수 , 주문 당시 상품 가격이\n저장되어 있는 OrderProduct 엔티티</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> count<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> price<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@CreatedDate</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createdDate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@LastModifiedDate</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> lastModifiedDate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> count<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> price<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>order <span class=\"token operator\">=</span> order<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>productId <span class=\"token operator\">=</span> productId<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count <span class=\"token operator\">=</span> count<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>price <span class=\"token operator\">=</span> price<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>가장 많이 팔린 상품을 구하기 위해 productId 의 개수를 카운트해서 select 하기</p>\n<p>최근 3일이라는 기준은 OrderProduct 에 있는 createdDate 를 기준으로 3일이라는 구간을 지정한다.</p>\n<h3 id=\"orderproductrepository-에-메서드-추가\" style=\"position:relative;\"><a href=\"#orderproductrepository-%EC%97%90-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%B6%94%EA%B0%80\" aria-label=\"orderproductrepository 에 메서드 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OrderProductRepository 에 메서드 추가</h3>\n<p>가장 많이 팔린 상품 3개 조회</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">OrderProductRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select new com.example.hanghaeplus.dto.orderproduct.OrderProductRankResponse(o.productId,p.name,count(o.productId)) \"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"from OrderProduct o inner join Product p \"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"on o.productId = p.id \"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"where o.createdDate >= :startDate and o.createdDate &lt; :endDate \"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"group by o.productId  \"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"order by count(o.productId) desc limit 3\"</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProductRankResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findTop3RankProductsInLast3Days</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"startDate\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">LocalDateTime</span> startDate <span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"endDate\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">LocalDateTime</span> endDate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"시간-의존성-주입하기\" style=\"position:relative;\"><a href=\"#%EC%8B%9C%EA%B0%84-%EC%9D%98%EC%A1%B4%EC%84%B1-%EC%A3%BC%EC%9E%85%ED%95%98%EA%B8%B0\" aria-label=\"시간 의존성 주입하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>시간 의존성 주입하기</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"orders\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Order</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseEntity</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">User</span> user<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> totalPrice<span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"order\"</span> <span class=\"token punctuation\">,</span>cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ALL</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> product<span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token annotation punctuation\">@Builder</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Order</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> user<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>product <span class=\"token operator\">=</span> <span class=\"token function\">getOrderProducts</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>totalPrice <span class=\"token operator\">=</span> <span class=\"token function\">calculateTotalPrice</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getOrderProducts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>product <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">long</span> <span class=\"token function\">calculateTotalPrice</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">mapToLong</span><span class=\"token punctuation\">(</span>product <span class=\"token operator\">-></span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Order</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Order</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Order 객체를 생성할 때 , OrderProduct 객체를 생성해서 DB 에 함께 영속화 시킨다.</p>\n<p>createdDate 는 생성할 때 자동으로 생성된다. 그런데, ‘최근 3일’ 이라는 기준이 있기 때문에</p>\n<p>테스트를 위해서</p>\n<p>FakeOrder 객체를 생성하였고,</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FakeOrder</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Order</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user <span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products <span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span> dateTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Order</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span>products<span class=\"token punctuation\">,</span>dateTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Order 엔티티에 아래 코드를 추가하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"> <span class=\"token keyword\">public</span> <span class=\"token class-name\">Order</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span> dateTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> user<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>product <span class=\"token operator\">=</span> <span class=\"token function\">getOrderProducts</span><span class=\"token punctuation\">(</span>products <span class=\"token punctuation\">,</span>dateTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>totalPrice <span class=\"token operator\">=</span> <span class=\"token function\">calculateTotalPrice</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getOrderProducts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDateTime</span> dateTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>product <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span>dateTime<span class=\"token punctuation\">,</span>dateTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3 id=\"테스트-코드-작성\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1\" aria-label=\"테스트 코드 작성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트 코드 작성</h3>\n<p>상위 상품 조회를 위해 Test Fixture 를 사용하였다.</p>\n<h4 id=\"test-fixture\" style=\"position:relative;\"><a href=\"#test-fixture\" aria-label=\"test fixture permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Fixture</h4>\n<blockquote>\n<p>테스트를 위해 원하는 상태로 고정시킨 일련의 객체</p>\n</blockquote>\n<p>주문을 위한 상품을 등록하고 , 주문을 하는 사용자와 주문 하는 상품 수량을 통해 여러 개의 주문을 미리 만들었다.</p>\n<p>이렇게 테스트를 위한 객체를 미리 만들어두면 각 테스트 메서드마다 사용할 수 있어\n중복을 방지할 수 있다.</p>\n<h4 id=\"beforeall-vs-beforeeach\" style=\"position:relative;\"><a href=\"#beforeall-vs-beforeeach\" aria-label=\"beforeall vs beforeeach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@BeforeAll vs @BeforeEach</h4>\n<ul>\n<li>@BeforeAll : 테스트 클래스 전체 실행 전에 작업을 수행</li>\n<li>@BeforeEach : 테스트 메서드 실행 전에 작업을 수행</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderProductRepositoryTest</span> <span class=\"token punctuation\">{</span>\n\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">OrderRepository</span> orderRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserRepository</span> userRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ProductRepository</span> productRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">OrderProductRepository</span> orderProductRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Product</span> productOnion<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Product</span> productPotato<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Product</span> productCarrot<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Product</span> productMushroom<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Product</span> productSweetPotato<span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"건희\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10000000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        productOnion <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"양파\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        productPotato <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"감자\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        productCarrot <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        productMushroom <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"버섯\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        productSweetPotato <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"고구마\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">,</span> productCarrot<span class=\"token punctuation\">,</span> productMushroom<span class=\"token punctuation\">,</span> productSweetPotato<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 주문 1</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_3 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requests1 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request1_1<span class=\"token punctuation\">,</span> request1_2<span class=\"token punctuation\">,</span> request1_3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token comment\">// 주문 2</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requests2 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request2_1<span class=\"token punctuation\">,</span> request2_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token comment\">// 주문 3</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request3_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request3_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requests3 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request3_1<span class=\"token punctuation\">,</span> request3_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 주문 4</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request4_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productMushroom<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productMushroom<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request4_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request4_3 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requests4 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request4_1<span class=\"token punctuation\">,</span> request4_2<span class=\"token punctuation\">,</span> request4_3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">LocalDate</span> today <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDate</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 주문 1  : 양파 ,감자 ,당근</span>\n        <span class=\"token class-name\">Order</span> order1 <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> requests1<span class=\"token punctuation\">,</span> today<span class=\"token punctuation\">.</span><span class=\"token function\">minusDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1일 전에 주문</span>\n        <span class=\"token comment\">// 주문 2 : 당근 ,감자</span>\n        <span class=\"token class-name\">Order</span> order2 <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> requests2<span class=\"token punctuation\">,</span> today<span class=\"token punctuation\">.</span><span class=\"token function\">minusDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2일 전에 주문</span>\n        <span class=\"token comment\">// 주문 3 : 당근 ,양파</span>\n        <span class=\"token class-name\">Order</span> order3 <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> requests3<span class=\"token punctuation\">,</span> today<span class=\"token punctuation\">.</span><span class=\"token function\">minusDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2일 전에 주문</span>\n        <span class=\"token comment\">// 주문 4 : 버섯 , 양파 ,당근</span>\n        <span class=\"token class-name\">Order</span> order4 <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> requests4<span class=\"token punctuation\">,</span> today<span class=\"token punctuation\">.</span><span class=\"token function\">minusDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 3일 전에 주문</span>\n\n\n        orderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>order1<span class=\"token punctuation\">,</span> order2<span class=\"token punctuation\">,</span> order3<span class=\"token punctuation\">,</span> order4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"최근 3일간 상위 상품 3개를 조회 한다.\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">findTop3ProductsInLast3Days</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given   // when</span>\n        <span class=\"token class-name\">LocalDate</span> today <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDate</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProductRankResponse</span><span class=\"token punctuation\">></span></span> top3RankProductsInLast3Days <span class=\"token operator\">=</span> orderProductRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findTop3RankProductsInLast3Days</span><span class=\"token punctuation\">(</span>today<span class=\"token punctuation\">.</span><span class=\"token function\">minusDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> today<span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token comment\">// 주문 4 제외 =>  주문 1 , 주문 2,  주문 3 :  당근 3 , 양파 2,  감자 2</span>\n        <span class=\"token comment\">//then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>top3RankProductsInLast3Days<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>top3RankProductsInLast3Days<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getOrderCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>top3RankProductsInLast3Days<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">3L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>test fixture 를 사용하면 여러 테스트를 진행 한다고 했을 때, 객체를 매번 생성할 필요 없이 @BeforeEach 를 사용하여 생성 한 뒤 모든 테스트에 적용할 수 있다.</p>\n<p>하지만 test fixture 의 단점도 존재한다.</p>\n<ol>\n<li>한 눈에 보기 힘들다.\n<ul>\n<li>여러 테스트 코드를 작성 했을 때 생성한 객체를 보기 위해 화면을 위로 이동해야 한다.</li>\n</ul>\n</li>\n<li>클래스안에서 모든 테스트가 서로 결합되어 버린다.\n<ul>\n<li>모든 테스트에 공통으로 영향을 주기 때문에 test fixture 의 코드 하나만 변경해도 모든 테스트에 영향을 미친다.</li>\n</ul>\n</li>\n</ol>\n<p>그래서 test fixture 를 사용할 때는</p>\n<ul>\n<li>각 테스트 입장에서 , 테스트 내용을 이해하는 데 문제가 없는가?</li>\n<li>test fixture 를 수정해도 모든 테스트에 영향을 주지 않는가?</li>\n</ul>\n<p>위 2가지를 고려하는 것이 좋겠다.</p>\n<h2 id=\"상위-상품-비즈니스-로직\" style=\"position:relative;\"><a href=\"#%EC%83%81%EC%9C%84-%EC%83%81%ED%92%88-%EB%B9%84%EC%A6%88%EB%8B%88%EC%8A%A4-%EB%A1%9C%EC%A7%81\" aria-label=\"상위 상품 비즈니스 로직 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>상위 상품 비즈니스 로직</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProductRankResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getRankProduct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">LocalDate</span> today <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDate</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> orderLineRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findTop3RankProductsInLast3Days</span><span class=\"token punctuation\">(</span>today<span class=\"token punctuation\">.</span><span class=\"token function\">minusDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> today<span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>최근 3일간 상위 상품을 조회하기 위해</p>\n<p>파라미터로 3일 전 오전 12시 와 오늘 오전 12시 시간을 넘겨 주었다.</p>\n<h2 id=\"테스트-코드\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C\" aria-label=\"테스트 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트 코드</h2>\n<p>상위 상품 조회 테스트를 위해 given 절이나 또는 @BeforeEach 로\n테스트 실행 전에 상품과 주문 상품 목록 등록 해줘야 한다.</p>\n<p>그리고 최근 3일이라는 기준을 테스트 하기 위해 시간도 직접 넣어줘야 한다.</p>\n<p>주입을 위해 코드가 길어지고 시간을 넣어주기 위해 일부 코드를 수정 해야한다. (시간 주입을 위해 TimeProvider 와 같은 인터페이스를 만들고 주문을 생성할 때 TimeProvider 를 구현한 클래스를 주입해줘야 한다.)</p>\n<p>이번에는 테스트 전에 sql 를 통해 미리 값을 준비해보자</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b01e03e170842e94209bf15af7fbeff1/4d2c8/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.9375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAABDElEQVR42pWOWW6DQBBEOUvCsDteGBiYYR1jsA3JAXJ4boIqzRLnJ5GVj6fXqi612nBOPnzBETUlEi2xT0McVYSD5Asu38GmzhMmJwzI3mgwYWEhtaCGHMV7heSmEHcJWcLLfJgxw6P3O5OV2DAFGw0zsuBKH04e0JEU++KIl9DEK2eL5z2L7WdMlnCoa9OHFFjCxaneIb0KiFZB3XME+dtaFvb/Dm4DfPpSdTmyvoAnA5jcXnK2eYH/wKI/Dma1hqpqQqPQDT6GT+i+QzU0qG4N6p58X13PHlbKtqH+GcV5Yaoul9mjUVYX6OYKfe5QE0XWIk4zCJUhljNqM2XfzLtEIRIPpjjJwYUcvwCVW98c0t6/WwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b01e03e170842e94209bf15af7fbeff1/a59e9/image.webp 192w,\n/static/b01e03e170842e94209bf15af7fbeff1/0ca9f/image.webp 384w,\n/static/b01e03e170842e94209bf15af7fbeff1/dc9b9/image.webp 768w,\n/static/b01e03e170842e94209bf15af7fbeff1/5599d/image.webp 1015w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b01e03e170842e94209bf15af7fbeff1/3b721/image.png 192w,\n/static/b01e03e170842e94209bf15af7fbeff1/66595/image.png 384w,\n/static/b01e03e170842e94209bf15af7fbeff1/fe486/image.png 768w,\n/static/b01e03e170842e94209bf15af7fbeff1/4d2c8/image.png 1015w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b01e03e170842e94209bf15af7fbeff1/fe486/image.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>resources > sql 폴더 아래에 sql 파일을 생성한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> users<span class=\"token punctuation\">(</span>user_id <span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">,</span> current_point<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"건희\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">100000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> orders<span class=\"token punctuation\">(</span>order_id <span class=\"token punctuation\">,</span>total_price<span class=\"token punctuation\">,</span>user_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">40000</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">25000</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">20000</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">45000</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> product<span class=\"token punctuation\">(</span>product_id <span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> price <span class=\"token punctuation\">,</span>quantity<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"양파\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"감자\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">2000</span><span class=\"token punctuation\">,</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"버섯\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">5000</span><span class=\"token punctuation\">,</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"고구마\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">2000</span><span class=\"token punctuation\">,</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> order_product <span class=\"token punctuation\">(</span>created_date<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> last_modified_date<span class=\"token punctuation\">,</span> order_id<span class=\"token punctuation\">,</span> price<span class=\"token punctuation\">,</span> product_id<span class=\"token punctuation\">,</span> quantity<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">1</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">1</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">1</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">1</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">1</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">1</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">2</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">2</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">2</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">2</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">3</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">3</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">3</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">3</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">4</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">4</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">4</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">4</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">4</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> CURDATE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">4</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>양파, 감자 ,당근 ,버섯 ,고구마 상품을 등록</li>\n<li>주문 1은 1일 전 양파, 감자,당근</li>\n<li>주문 2는 2일 전 딩근, 감자</li>\n<li>주문 3은 3일 전 당근,양파,버섯</li>\n<li>주문 4는 4일 전 양파 ,당근</li>\n<li>4일 전인 주문 4을 제외하면 당근 3번 , 양파 2번, 감자 2번,버섯 1번으로 상위 3개 상품은 당근,양파, 감자이다</li>\n</ul>\n<p>테스트 파일 위에 @Sql 어노테이션에 경로를 지정해주면</p>\n<p>테스트 실행 전에 sql 쿼리가 실행 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token annotation punctuation\">@Sql</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sql/product-rank-service-data.sql\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProductRankServiceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ProductService</span> productService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"최근 3일간 상위 상품 3개를 조회 한다.\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">findTop3ProductsInLast3Days</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given   // when</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProductRankResponse</span><span class=\"token punctuation\">></span></span> rankProduct <span class=\"token operator\">=</span> productService<span class=\"token punctuation\">.</span><span class=\"token function\">getRankProduct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//최근 3일 동안 product_id 3 당근 - 3번 , product_id 1 양파 - 2번  , product_id  2 감자 - 2번</span>\n\n        <span class=\"token comment\">// 제일 많이 주문한 상위 상품</span>\n        <span class=\"token class-name\">OrderProductRankResponse</span> orderProductRankResponse <span class=\"token operator\">=</span> rankProduct<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>orderProductRankResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>orderProductRankResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>orderProductRankResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getOrderCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>rankProduct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">extracting</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"productId\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"orderCount\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">containsExactlyInAnyOrder</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token function\">tuple</span><span class=\"token punctuation\">(</span><span class=\"token number\">3L</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">3L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">tuple</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"양파\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">2L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token function\">tuple</span><span class=\"token punctuation\">(</span><span class=\"token number\">2L</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"감자\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">2L</span><span class=\"token punctuation\">)</span>\n\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h4 id=\"결과\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EA%B3%BC\" aria-label=\"결과 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결과</h4>\n<p>성공</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/71fc14a2eeb86bff3cb0b02b7b00b805/73737/image-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.29166666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAACToAAAk6AGCYwUcAAAAx0lEQVR42p2R6w6CMAxGeRFgA8ZgbAPUKN6Nt+j7P9BnS4JBo4nxx0m3Zj3ttqBb73A833C63HE4XrHdn9Cttlh0GyzXe0zaGeZEbWu40sEbT9HCElVhn+se2geunsI3r3BuyGtdwdBhlWlIkUFECUScQMafY2Co8zcq1yBJc8hEoSa5qTxUXiIWKSIqZsK3GHDRN6xvkaqil+TaIKUphcwQRrJnkI75ScgTlsahoKuzlMkoz/K/hFxc0odYyvFTcAOWja8+CB9QVrHYm5qOSgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/71fc14a2eeb86bff3cb0b02b7b00b805/a59e9/image-1.webp 192w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/0ca9f/image-1.webp 384w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/dc9b9/image-1.webp 768w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/e2c2f/image-1.webp 1152w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/f3efb/image-1.webp 1536w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/311cf/image-1.webp 2777w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/71fc14a2eeb86bff3cb0b02b7b00b805/3b721/image-1.png 192w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/66595/image-1.png 384w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/fe486/image-1.png 768w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/d2d74/image-1.png 1152w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/e8464/image-1.png 1536w,\n/static/71fc14a2eeb86bff3cb0b02b7b00b805/73737/image-1.png 2777w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/71fc14a2eeb86bff3cb0b02b7b00b805/fe486/image-1.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"캐싱-적용하기\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%B1-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"캐싱 적용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐싱 적용하기</h3>\n<p>상위 상품 조회 요청 시, 해당 상품은 최근 3일 간 제일 많인 팔린 상품으로 설정되어 있다. 현재 API는 요청이 올 때마다 데이터베이스에서 오늘 날짜로부터 3일 전까지의 정보를 조회하여 반환한다.</p>\n<p>즉 하루가 지나기 전에는 같은 데이터를 반환한다. 그렇기 때문에 매번 데이터베이스에서 조회할 필요 없이 미리 캐싱해놓은 데이터를 가져오면 응답 속도를 높일 수 있다.</p>\n<h4 id=\"스프링-부트-cache-적용\" style=\"position:relative;\"><a href=\"#%EC%8A%A4%ED%94%84%EB%A7%81-%EB%B6%80%ED%8A%B8-cache-%EC%A0%81%EC%9A%A9\" aria-label=\"스프링 부트 cache 적용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>스프링 부트 Cache 적용</h4>\n<p>스프링 부트에서 기본 캐시 기능을 제공 해주는데,</p>\n<p>스프링 부트 애플리케이션에 @EnableCaching 어노테이션을 붙여주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token annotation punctuation\">@EnableJpaAuditing</span>\n<span class=\"token annotation punctuation\">@EnableCaching</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HanghaePlusApplication</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HanghaePlusApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>캐시 정보 저장하기</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rank_product\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProductRankResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getRankProduct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"상위 상품 조회\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">LocalDate</span> today <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDate</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> orderLineRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findTop3RankProductsInLast3Days</span><span class=\"token punctuation\">(</span>today<span class=\"token punctuation\">.</span><span class=\"token function\">minusDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> today<span class=\"token punctuation\">.</span><span class=\"token function\">atStartOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>@Cacheable 어노테이션</p>\n<ul>\n<li>캐시 정보를 메모리 상에 ‘저장’ 하거나 ‘조회’ 해오는 기능을 수행할 때 사용한다.</li>\n<li>케시의 속성 값인 ‘값(value)’ 과 ‘키(key)’ 를 기반으로 수행이 된다.</li>\n<li>최초 호출이 된 경우에는 메서드가 호출되어 ‘캐시 정보를 저장’ 하며, 동일하게 재 호출이 된 경우는 메서드의 호출 없이 ‘저장된 캐시의 정보를 조회하여 반환’한다.</li>\n</ul>\n<p>캐시 정보 삭제하기</p>\n<p>하루가 지나면 메모리에 캐싱된 데이터를 삭제하고, 새로운 데이터를 캐싱 해야하기 때문에</p>\n<p>스프링 스케줄러를 사용하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Scheduled</span><span class=\"token punctuation\">(</span>cron <span class=\"token operator\">=</span> <span class=\"token string\">\"0 0 0 * * *\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@CacheEvict</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rank_product\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">evictRankProduct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>@CacheEvict</p>\n<ul>\n<li>캐시 정보를 메모리상에 ‘삭제’하는 기능을 수행할 때 사용한다.</li>\n<li>@CacheEvict 에 캐시 이름을 넣어주면 메소드가 실행될 때 캐시의 내용이 제거 된다.</li>\n</ul>\n<h2 id=\"코드-점진적으로-개선하기\" style=\"position:relative;\"><a href=\"#%EC%BD%94%EB%93%9C-%EC%A0%90%EC%A7%84%EC%A0%81%EC%9C%BC%EB%A1%9C-%EA%B0%9C%EC%84%A0%ED%95%98%EA%B8%B0\" aria-label=\"코드 점진적으로 개선하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>코드 점진적으로 개선하기</h2>\n<h3 id=\"주문하기-로직-관심사-분리-응집도-높이기\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EB%AC%B8%ED%95%98%EA%B8%B0-%EB%A1%9C%EC%A7%81-%EA%B4%80%EC%8B%AC%EC%82%AC-%EB%B6%84%EB%A6%AC-%EC%9D%91%EC%A7%91%EB%8F%84-%EB%86%92%EC%9D%B4%EA%B8%B0\" aria-label=\"주문하기 로직 관심사 분리 응집도 높이기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주문하기 로직 관심사 분리, 응집도 높이기</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">UserReader</span> userReader<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ProductReader</span> productReader<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OrderAppender</span> orderAppender<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PointManager</span> pointManager<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">StockManager</span> stockManager<span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> userReader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 상품 목록 가져 오기</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token operator\">=</span> productReader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// key : 상품 id , value : 주문 수량</span>\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> productIdQuntitiyMap <span class=\"token operator\">=</span> productReader<span class=\"token punctuation\">.</span><span class=\"token function\">convertToProductIdQuantityMap</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 재고 차감</span>\n        stockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">,</span>stockMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 주문</span>\n        <span class=\"token class-name\">Order</span> savedOrder <span class=\"token operator\">=</span> orderAppender<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 포인트 내역 저장</span>\n        pointManager<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span>savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>상품 목록 가져오는 것과 상품 주문 수량 map 으로 변환해주는 부분이 createOrder 비즈니스 로직에 있는 것이\n맞을까??</p>\n<p>또한 map으로 변환 해주는 convertToProductIdQuantityMap 메서드는 ProductReader 클래스에서 하는 것이 적절해 보이지 않는다. ProductReader 는 product 관련 정보를 repoitory에서 가져오는 클래스다.</p>\n<p>위의 2개 기능은 StockManager 에서 사용하면 될 것 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StockManager</span> <span class=\"token punctuation\">{</span>\n\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token punctuation\">,</span>  <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> stockMap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Product</span> product <span class=\"token operator\">:</span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Long</span> quantity <span class=\"token operator\">=</span> stockMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">isLessThanQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InsufficientStockException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INSUFFICIENT_STOCK</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            product<span class=\"token punctuation\">.</span><span class=\"token function\">deductQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기존에 변환된 파라미터 2개를 받아서 작업 하던 것을</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StockManager</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ProductReader</span> productReader<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token punctuation\">,</span>  <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> stockMap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Product</span> product <span class=\"token operator\">:</span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Long</span> quantity <span class=\"token operator\">=</span> stockMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">isLessThanQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InsufficientStockException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INSUFFICIENT_STOCK</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            product<span class=\"token punctuation\">.</span><span class=\"token function\">deductQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requestForOrders <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> productIdQuntitiyMap <span class=\"token operator\">=</span> <span class=\"token function\">convertToProductIdQuantityMap</span><span class=\"token punctuation\">(</span>requestForOrders<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token operator\">=</span>   productReader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Product</span> product <span class=\"token operator\">:</span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Long</span> quantity <span class=\"token operator\">=</span> productIdQuntitiyMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">isLessThanQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InsufficientStockException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INSUFFICIENT_STOCK</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            product<span class=\"token punctuation\">.</span><span class=\"token function\">deductQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">convertToProductIdQuantityMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ProductReader 클래스를 의존하여 Product 정보를 가져오고</p>\n<p>map 으로 변환하는 기능은 private 메서드로 수정하였다.</p>\n<h3 id=\"잔액과-총-가격-비교--잔액-차감-통합하기\" style=\"position:relative;\"><a href=\"#%EC%9E%94%EC%95%A1%EA%B3%BC-%EC%B4%9D-%EA%B0%80%EA%B2%A9-%EB%B9%84%EA%B5%90--%EC%9E%94%EC%95%A1-%EC%B0%A8%EA%B0%90-%ED%86%B5%ED%95%A9%ED%95%98%EA%B8%B0\" aria-label=\"잔액과 총 가격 비교  잔액 차감 통합하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>잔액과 총 가격 비교 , 잔액 차감 통합하기</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deductPoint</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Long</span> totalPrice <span class=\"token operator\">=</span> order<span class=\"token punctuation\">.</span><span class=\"token function\">getTotalPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> totalPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InsufficientPointsException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INSUFFICIENT_POINT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        user<span class=\"token punctuation\">.</span><span class=\"token function\">deductPoints</span><span class=\"token punctuation\">(</span>totalPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>사용자의 현재 잔액과 주문 한 총 가격을 비교한 뒤에 사용자의 잔액을 차감한다.\n하지만 요구사항이 추가되어 여러 기능을 추가적으로 개발했을 때</p>\n<p>잔액 차감이라는 메서드를 사용한다고 했을 때, 비교하는 로직을 다시 사용해야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"> <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deductPoints</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> totalPrice<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentPoint <span class=\"token operator\">-=</span> totalPrice<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deductPoints</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> totalPrice<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentPoint <span class=\"token operator\">&lt;</span> totalPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InsufficientPointsException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INSUFFICIENT_POINT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentPoint <span class=\"token operator\">-=</span> totalPrice<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>잔액 차감하는 메서드 안에서 잔액과 가격을 비교하면 되지 않을까?</p>\n<p>잔액 차감과 비교하는 로직을 통합하여 다른 기능에서 잔액 차감 메서드를 사용했을 때</p>\n<p>코드의 중복을 줄일 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deductPoint</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Long</span> totalPrice <span class=\"token operator\">=</span> order<span class=\"token punctuation\">.</span><span class=\"token function\">getTotalPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        user<span class=\"token punctuation\">.</span><span class=\"token function\">deductPoints</span><span class=\"token punctuation\">(</span>totalPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>정리 하면,</p>\n<ul>\n<li>주문 가격 보다 잔액이 부족하지 않는지 확인하는 것은 도메인의 핵심 로직이다.</li>\n<li>비즈니스 로직에서는 도메인 로직을 구현하면 안된다.</li>\n<li>응집도가 떨어지기 때문이다. 도메인 로직을 파악하기 위해 여러 영역을 분석해야 한다.</li>\n<li>여러 비즈니스 로직에서 동일한 도메인 로직을 구현할 수 있기 때문에 코드가 중복 될 수 있다.</li>\n</ul>\n<h3 id=\"개선-해야-할-점\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%84%A0-%ED%95%B4%EC%95%BC-%ED%95%A0-%EC%A0%90\" aria-label=\"개선 해야 할 점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개선 해야 할 점</h3>\n<ul>\n<li>테스트 하기 좋은 설계에 대해 고민하기</li>\n<li>단위 테스트 비중을 높이기</li>\n<li>Mockito 에 대해서 공부하기</li>\n</ul>\n<h2 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h2>\n<p><a href=\"https://adjh54.tistory.com/165\" target=\"_blank\" rel=\"nofollow\">https://adjh54.tistory.com/165</a> <br/></p>","frontmatter":{"title":"e-커머스 주문 서비스 상위 상품 조회 기능 ,코드 리팩토링 하기  ","summary":"e-커머스 상품 주문 서비스의 기능을 추가하고 코드를 클린 코드, 객체지향적인 코드로 점진적으로 개선하기","date":"2023.12.23.","categories":["항해플러스"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAABDElEQVR42pWOWW6DQBBEOUvCsDteGBiYYR1jsA3JAXJ4boIqzRLnJ5GVj6fXqi612nBOPnzBETUlEi2xT0McVYSD5Asu38GmzhMmJwzI3mgwYWEhtaCGHMV7heSmEHcJWcLLfJgxw6P3O5OV2DAFGw0zsuBKH04e0JEU++KIl9DEK2eL5z2L7WdMlnCoa9OHFFjCxaneIb0KiFZB3XME+dtaFvb/Dm4DfPpSdTmyvoAnA5jcXnK2eYH/wKI/Dma1hqpqQqPQDT6GT+i+QzU0qG4N6p58X13PHlbKtqH+GcV5Yaoul9mjUVYX6OYKfe5QE0XWIk4zCJUhljNqM2XfzLtEIRIPpjjJwYUcvwCVW98c0t6/WwAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/b01e03e170842e94209bf15af7fbeff1/7cd54/image.png","srcSet":"/static/b01e03e170842e94209bf15af7fbeff1/3929d/image.png 254w,\n/static/b01e03e170842e94209bf15af7fbeff1/e3c17/image.png 508w,\n/static/b01e03e170842e94209bf15af7fbeff1/7cd54/image.png 1015w","sizes":"(min-width: 1015px) 1015px, 100vw"},"sources":[{"srcSet":"/static/b01e03e170842e94209bf15af7fbeff1/1e073/image.webp 254w,\n/static/b01e03e170842e94209bf15af7fbeff1/74c28/image.webp 508w,\n/static/b01e03e170842e94209bf15af7fbeff1/56d22/image.webp 1015w","type":"image/webp","sizes":"(min-width: 1015px) 1015px, 100vw"}]},"width":1015,"height":365}},"publicURL":"/static/b01e03e170842e94209bf15af7fbeff1/image.png"}}}}]}},"pageContext":{"slug":"/항해플러스/e-commerce/상위상품조회/"}},"staticQueryHashes":[],"slicesMap":{}}