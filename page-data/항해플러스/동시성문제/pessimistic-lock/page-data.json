{"componentChunkName":"component---src-templates-post-template-tsx","path":"/항해플러스/동시성문제/pessimistic-lock/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C\">동시성 문제</a></p>\n<ul>\n<li>\n<p><a href=\"#%EC%9E%AC%EA%B3%A0-%EC%B0%A8%EA%B0%90\">재고 차감</a></p>\n<ul>\n<li>\n<p><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1\">테스트 코드 작성</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%8B%A4%ED%8C%A8-%EC%BC%80%EC%9D%B4%EC%8A%A4\">실패 케이스</a></p>\n</li>\n<li>\n<p><a href=\"#lock\">Lock</a></p>\n<ul>\n<li><a href=\"#%EB%82%99%EA%B4%80%EC%A0%81-%EB%9D%BD-optimistic-lock\">낙관적 락 (Optimistic Lock)</a></li>\n<li><a href=\"#%EB%B9%84%EA%B4%80%EC%A0%81-%EB%9D%BD-pessimistic-lock\">비관적 락 (Pessimistic Lock)</a></li>\n<li><a href=\"#pessimistic_read\">PESSIMISTIC_READ</a></li>\n<li><a href=\"#pessimistic_write\">PESSIMISTIC_WRITE</a></li>\n<li><a href=\"#pessimistic_force_increment\">PESSIMISTIC_FORCE_INCREMENT</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%84%B1%EA%B3%B5-%EC%BC%80%EC%9D%B4%EC%8A%A4\">성공 케이스</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9E%94%EC%95%A1-%EC%B0%A8%EA%B0%90\">잔액 차감</a></p>\n<ul>\n<li>\n<p><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1-1\">테스트 코드 작성</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%8B%A4%ED%8C%A8-%EC%BC%80%EC%9D%B4%EC%8A%A4-1\">실패 케이스</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%84%B1%EA%B3%B5-%EC%BC%80%EC%9D%B4%EC%8A%A4-1\">성공 케이스</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%9D%98%EB%AC%B8%EC%A0%90\">의문점</a></p>\n<ul>\n<li><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C\">테스트 코드</a></li>\n<li><a href=\"#%EA%B2%B0%EA%B3%BC\">결과</a></li>\n<li><a href=\"#%EA%B2%B0%EA%B3%BC-1\">결과</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","html":"<h1 id=\"동시성-문제\" style=\"position:relative;\"><a href=\"#%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C\" aria-label=\"동시성 문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>동시성 문제</h1>\n<p>e-커머스 상품 주문 서비스 기능에서 동시에 요청이 발생 했을 때 야기되는 문제를 생각해보고 테스트 코드를 작성 해본다.</p>\n<h2 id=\"재고-차감\" style=\"position:relative;\"><a href=\"#%EC%9E%AC%EA%B3%A0-%EC%B0%A8%EA%B0%90\" aria-label=\"재고 차감 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>재고 차감</h2>\n<p>주문 비즈니스 로직</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OrderPostResponse</span> <span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> userReader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 재고 차감</span>\n        stockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 주문</span>\n        <span class=\"token class-name\">Order</span> savedOrder <span class=\"token operator\">=</span> orderAppender<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 잔액 차감</span>\n        userManager<span class=\"token punctuation\">.</span><span class=\"token function\">deductPoint</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 포인트 내역 저장</span>\n        pointManager<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 결제</span>\n        <span class=\"token class-name\">Payment</span> payment <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Payment</span><span class=\"token punctuation\">(</span>savedOrder<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Payment</span> savedPayment <span class=\"token operator\">=</span> paymentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>payment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        publisher<span class=\"token punctuation\">.</span><span class=\"token function\">publishEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PaymentEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span>savedPayment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">OrderPostResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>여러 사용자가 동시에 주문을 요청할 때 , 상품의 재고 수량이 요청된 주문 만큼\n잘 차감 되는지 확인을 해야 한다.</p>\n<h3 id=\"테스트-코드-작성\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1\" aria-label=\"테스트 코드 작성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트 코드 작성</h3>\n<p>주문 요청을 동시에 처리하는 코드를 작성 하기 위해 <code class=\"language-text\">CompletableFuture</code> 클래스를 사용하였다.</p>\n<p><a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html\" target=\"_blank\" rel=\"nofollow\">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html</a></p>\n<p><code class=\"language-text\">CompletableFuture</code> 클래스는 Java 에서 비동기적 및 동시성 작업을 처리하기 위한 클래스로 Future 와 CompletionStage 인터페이스를 구현하여 미래에 완료될\n작업을 나타낸다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">void</span> <span class=\"token function\">deductQuantityWithConcurrency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">User</span> user1 <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"건희\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100000000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">User</span> user2 <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"거니\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100000000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">User</span> savedUser1 <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">User</span> savedUser2 <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Product</span> product1 <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"양파\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> product2 <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"감자\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> product3 <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>product1<span class=\"token punctuation\">,</span> product2<span class=\"token punctuation\">,</span> product3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>product1<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> product1<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>product2<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10L</span><span class=\"token punctuation\">,</span> product2<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request3 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>product3<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> product3<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token class-name\">ProductRequestForOrder</span> request4 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>product1<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> product3<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request5 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>product2<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> product3<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request6 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>product3<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5L</span><span class=\"token punctuation\">,</span> product3<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requests1 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request1<span class=\"token punctuation\">,</span> request2<span class=\"token punctuation\">,</span> request3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requests2 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request4<span class=\"token punctuation\">,</span> request5<span class=\"token punctuation\">,</span> request6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token class-name\">OrderPostRequest</span> orderPostRequest1 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">userId</span><span class=\"token punctuation\">(</span>savedUser1<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">products</span><span class=\"token punctuation\">(</span>requests1<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">OrderPostRequest</span> orderPostRequest2 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">userId</span><span class=\"token punctuation\">(</span>savedUser2<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">products</span><span class=\"token punctuation\">(</span>requests2<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">allOf</span><span class=\"token punctuation\">(</span>\n             <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span> orderService<span class=\"token punctuation\">.</span><span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span>orderPostRequest1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n             <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span> orderService<span class=\"token punctuation\">.</span><span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span>orderPostRequest2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token operator\">=</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>product1<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> product2<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> product3<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> findProduct1 <span class=\"token operator\">=</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> findProduct2 <span class=\"token operator\">=</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> findProduct3 <span class=\"token operator\">=</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>findProduct1<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">30L</span><span class=\"token operator\">-</span><span class=\"token number\">5L</span><span class=\"token operator\">-</span><span class=\"token number\">3L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>findProduct2<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">30L</span><span class=\"token operator\">-</span><span class=\"token number\">10L</span><span class=\"token operator\">-</span><span class=\"token number\">5L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>findProduct3<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">30L</span><span class=\"token operator\">-</span><span class=\"token number\">5L</span><span class=\"token operator\">-</span><span class=\"token number\">5L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>CompletableFuture allOf 메서드 : 여러 작업을 동시에 실행하고, 모든 작업 결과에 콜백을 실행한다.</li>\n<li>CompletableFuture runAsync 메서드 : 결과를 반환하는 작업을 비동기적으로 실행</li>\n</ul>\n<p>결과</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9cc56873e8f0777bd2c8da78846ecabf/3e86e/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.45833333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAAA40lEQVR42p2QyXLCMBBE+Q+8aZflRbEQ2EX+/7s6LSVUcYAcOHRNqz3zajyned1gXUDTCbS9RDso+LBinBYqYo4JflrhwlJl2CuNh1C2+o4zzzo9gKJXEITpQVMKim/ZSWg2qZorWH4realGaM7I98CkHA4bcKdKPUxAZLazbtoj67H6TL+bsWajtGh68Rr4JR2+ObCzcWbjlQAxSJx5iqacgjr3v77h5gXUvttQEzhxm8TNrm7CojwuBEr+Zvdi6D9VoPOEsF7ygbhljH7G7Q/YfgK0BE5zREo3GEsQD57NZ8Afc3vHg0a8i8sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9cc56873e8f0777bd2c8da78846ecabf/a59e9/image.webp 192w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/0ca9f/image.webp 384w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/dc9b9/image.webp 768w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/9f8de/image.webp 1062w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9cc56873e8f0777bd2c8da78846ecabf/3b721/image.png 192w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/66595/image.png 384w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/fe486/image.png 768w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/3e86e/image.png 1062w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9cc56873e8f0777bd2c8da78846ecabf/fe486/image.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"실패-케이스\" style=\"position:relative;\"><a href=\"#%EC%8B%A4%ED%8C%A8-%EC%BC%80%EC%9D%B4%EC%8A%A4\" aria-label=\"실패 케이스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>실패 케이스</h3>\n<ul>\n<li>양파 , 감자, 당근 모두 30개 있다.</li>\n<li>“건희” , “거니” 2명의 유저가 동시에 주문을 요청하였다.</li>\n<li>“건희” 유저는 양파 5개, 감자 10개 , 당근 5개를 주문, “거니” 유저는 양파 3개 감자 5개 , 당근 5개를 주문하였다.</li>\n<li>동시에 주문을 했기 때문에 하나의 주문을 통해 차감된 재고 수량을 가져오는 것이 아니라 2개의 주문 모두 주문이 들어오기 전 재고 수량인 30개를 DB에서 select 했다.</li>\n<li>“거니” 유저가 “건희” 유저가 주문을 완료 이후 차감된 재고 25개에서 Select 한 것이 아니라 주문 전 수량 30개에서 select 했기 때문에 양파의 재고가 30개에서 건희 5개 , 거니 3개를 뺀 22개 아닌 27개 결과로 테스트에 실패한다.</li>\n</ul>\n<p>그러면 동시에 주문을 해도 주문 한 횟수만큼 재고를 차감하려면 어떻게 해야할까?\n하나의 주문이 상품 정보를 읽고, 재고 차감 한 이후에 다른 주문이 상품 정보를 읽게 해야 한다.</p>\n<p>그러기 위해서는 <code class=\"language-text\">Lock</code> 을 사용해야 한다.</p>\n<h3 id=\"lock\" style=\"position:relative;\"><a href=\"#lock\" aria-label=\"lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lock</h3>\n<p>낙관적 락 (Optimistic Lock) vs 비관적 락 (Pessimistic Lock)</p>\n<h4 id=\"낙관적-락-optimistic-lock\" style=\"position:relative;\"><a href=\"#%EB%82%99%EA%B4%80%EC%A0%81-%EB%9D%BD-optimistic-lock\" aria-label=\"낙관적 락 optimistic lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>낙관적 락 (Optimistic Lock)</h4>\n<p>=> Commit 시에 수정이 일어나 version 이 변경되었다면 fail</p>\n<ul>\n<li>현실적으로 데이터 갱신 시 경합이 발생하지 않을 것이라고 보고 잠금을 거는 기법</li>\n<li>낙관적 락은 데이터 베이스에서 제공하는 것이 아니라 어플리케이션 혹은 JPA 에서 제공을 해주는 기능이다.</li>\n<li>낙관적은 충돌을 가정하지 않기 때문에 충돌에 대한 예외를 던져준다.</li>\n</ul>\n<h4 id=\"비관적-락-pessimistic-lock\" style=\"position:relative;\"><a href=\"#%EB%B9%84%EA%B4%80%EC%A0%81-%EB%9D%BD-pessimistic-lock\" aria-label=\"비관적 락 pessimistic lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>비관적 락 (Pessimistic Lock)</h4>\n<p>=> 사용중 일 때 Lock 을 걸어 다른 Connection 이 사용 못하도록 함</p>\n<ul>\n<li>동일한 데이터를 동시에 수정할 가능성이 높다는 관점으로 잠금을 거는 기법</li>\n<li>비관적 락은 “데이터베이스 락 알고리즘” 을 통해 구현이 된다.</li>\n</ul>\n<p>※ DB Lock 이란?</p>\n<blockquote>\n<ol>\n<li>DB 에서 Lock 이란, 무결성을 보장하기 위한 방법이다.</li>\n<li>동시에 같은 데이터를 보고 있을 때 업데이트를 방지하기 위해 존재를 하며 락이 풀리기 전까지는 조작할 수 없다. commit 혹은 rollback 후에 풀리게 된다.</li>\n<li>종류 로는 공유락, 베타락이 있다. 공유락은 데이터를 읽을 때 사용하는 락이며 베타적인 락은 데이터를 변경 할 때 사용 한다.</li>\n</ol>\n</blockquote>\n<h4 id=\"pessimistic_read\" style=\"position:relative;\"><a href=\"#pessimistic_read\" aria-label=\"pessimistic_read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PESSIMISTIC_READ</h4>\n<p>다른 트랜잭션에게 읽기만을 허용하는 <code class=\"language-text\">LockModeType</code> 이다. <code class=\"language-text\">Shared Lock</code> 을 이용해 락을 거는데 <code class=\"language-text\">Shared Lock</code> 을 DB가 제공하지 않으면 <code class=\"language-text\">PESSIMISTIC_WRITE</code> 와 동일하게 동작한다.</p>\n<h4 id=\"pessimistic_write\" style=\"position:relative;\"><a href=\"#pessimistic_write\" aria-label=\"pessimistic_write permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PESSIMISTIC_WRITE</h4>\n<p>DB 에서 제공하는 행배타잠금(Row Exclusive Lock)을 이용해 잠금을 획득한다.\n다른 트랜잭션에서는 쓰지도 읽지도 못한다.</p>\n<h4 id=\"pessimistic_force_increment\" style=\"position:relative;\"><a href=\"#pessimistic_force_increment\" aria-label=\"pessimistic_force_increment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PESSIMISTIC_FORCE_INCREMENT</h4>\n<p>DB 에서 제공하는 행 배타잠금(Row Exclusive Lock)을 이용해 잠금을 걸고 동시에\n버전을 증가시킨다. 해당하는 엔티티에 변경은 없지만 하위 엔티티 갱신을 위해 잠금이 필요한 경우 사용할 수 있다.</p>\n<h3 id=\"성공-케이스\" style=\"position:relative;\"><a href=\"#%EC%84%B1%EA%B3%B5-%EC%BC%80%EC%9D%B4%EC%8A%A4\" aria-label=\"성공 케이스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>성공 케이스</h3>\n<p>동시에 주문을 했을 때 재고 차감하는 부분에서 충돌이 발생할 수 있기 때문에\n비관적 락을 사용하였다.</p>\n<p>재고 차감에 동시성 문제를 해결하려면 Lock 을 어디서 걸어줘야 할까?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bd70c95289d8d8f1273824eae93b7d5b/8e375/image-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAACToAAAk6AGCYwUcAAAB6klEQVR42mVTWXbjMAzLQaaJbe2b5aWOZ17ufx7fQCgkJ+lr5wNPlGSCIChfpLK4dQIpWOTkME0jQojQNkDwrlMRnR4ZB2jjiQDDu5pX94PQuN0GXJ+41IPrTUAIBesTTMwkixjDiuhmKD/B5w1pXDHmGXlaGyqhkAZ9L99kjbAFVFirrC7jke5YzYjZJcwssIQErc13Uneufz66Nz6ufcMPwo7YWfUvsQuDjYo3Vt+FhRkM72Vrrx8Uuv6MK6rKgd/X80Z49k+FTLBhQsyfCGxPUZ0yEc5mRJPpa2bLCyyVS+XgXGweGq6WFlXit8I6lErqdET2CxyJQhhhmKC0Q08lda3DqErerX70P9r+brkpFDDKI1kOwaSzMlHNV9rDU2GNf3v5G5db9yQkpORTYHKdXPOJavoXpGpKX4kvRf8RnhenwpAyfOQ7TFNTZ5SBp5eBTyfR3+Bza93TjuFJ/mr5TaisLxxI6XpV5nwvKzHPW9n2R5mWrcxxKtu0l319lGXkft7L/f6vbMtn4ZBKTFPxMZd+0I3novjyhXT0hz5xWsGPVDkjctIV1TufuM8rlc+Quv5Bjjm2xZoDrK/hPHO40KujF+oYpD6UUofS5lDGHfzFDg6GsWfsD064xfTzqDndc70+0Q0nvgCi1Fl3jOchUgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bd70c95289d8d8f1273824eae93b7d5b/a59e9/image-1.webp 192w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/0ca9f/image-1.webp 384w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/dc9b9/image-1.webp 768w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/e2c2f/image-1.webp 1152w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/f3efb/image-1.webp 1536w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/9ae61/image-1.webp 1757w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bd70c95289d8d8f1273824eae93b7d5b/3b721/image-1.png 192w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/66595/image-1.png 384w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/fe486/image-1.png 768w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/d2d74/image-1.png 1152w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/e8464/image-1.png 1536w,\n/static/bd70c95289d8d8f1273824eae93b7d5b/8e375/image-1.png 1757w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bd70c95289d8d8f1273824eae93b7d5b/fe486/image-1.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>재고 차감하는 코드를 보자</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/508a7b7a62e35470889e9f1ac0b695e9/8ef96/image-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAABJklEQVR42m2RWXrDIAyEfZF6wTZm94aXpEmfev8rTQfadH/4keATw0gUou0QgoN1BlIOKKsWVf2XshKZp7L5ih/5dwohOlitYJWCcjNZ4dwI5yco4zMpF63MF+qmzzTinYf4gyIdyMFiWQ+MU8Q4R0zLjnnZMIYFW7xgCjHvw7RijSc5ELdLzo0NGLSDIr3UFKRq30lMLA4UOvcrrscVmi5f5h2vPuJl8LjT6cEaw3NrR2juJQXqpiNtjlWdWu4UKlqfw4T7ceKZolc6PecNN7o+6Nj7GUYHxP2EH1eOIaDtNarcuvxBkZYkuiqHm/bYe4OT+TEYXJRFJDVrSjoo8wfRSXbFWYr+c6YPimSz5YWu1cRACAXB1wXbaSmaYqopq98/2vzLG+jEzP80t77mAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/508a7b7a62e35470889e9f1ac0b695e9/a59e9/image-3.webp 192w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/0ca9f/image-3.webp 384w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/dc9b9/image-3.webp 768w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/e2c2f/image-3.webp 1152w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/f3efb/image-3.webp 1536w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/f63d8/image-3.webp 1960w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/508a7b7a62e35470889e9f1ac0b695e9/3b721/image-3.png 192w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/66595/image-3.png 384w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/fe486/image-3.png 768w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/d2d74/image-3.png 1152w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/e8464/image-3.png 1536w,\n/static/508a7b7a62e35470889e9f1ac0b695e9/8ef96/image-3.png 1960w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/508a7b7a62e35470889e9f1ac0b695e9/fe486/image-3.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>재고 차감을 하기 전 상품 정보를 읽은 뒤 재고를 차감한다.\n상품 정보를 읽는 부분에 락을 걸어주면 된다.</p>\n<p>실제로 데이터에 엑세스 하기 전에 먼저 락을 걸어 충돌을 예방하기 위해 비관적 락을 사용하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProductReader</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ProductRepository</span> productRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> productRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllById</span><span class=\"token punctuation\">(</span>productRequest<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기존 findAllById 메서드 대신</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Repository</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ProductRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Lock</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">LockModeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PESSIMISTIC_WRITE</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT p FROM Product p WHERE p.id IN :productIds\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllByPessimisticLock</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"productIds\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> productIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>비관적 락을 사용하기 위해 @Query 에 직접 sql 문을 작성하고</p>\n<p>@Lock(value = LockModeType.PESSIMISTIC_WRITE) 어노테이션을 설정하였다.</p>\n<p>결과</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8a4d37684a8ee3f95989aa1198ae653d/0c0fb/image-10.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.479166666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAACToAAAk6AGCYwUcAAABHElEQVR42p2S2VKDQBBF+Q8hwLAN60CAiCYBiVuV+uD//0zbt03yYFJG83CqGabmcLsHa9o90cvrO719fNLD/EwTsx1333V6pKbtqesHoapbqsyS6qajoqwpL8wJVns70Gacab2d6W49HlkNG+pW9xTGKem0EEGiCwrCRPBVdBYrzSvSWSkcnlEPKD4cJ5kQRlpkEX8Ez87CP8HKEf0XkDAvahF6fsCEtHAVuV4g9ScXhRAAtGx4ds2yl3TnZH8SYi5Ig8uoTCtzTHQu79HiVUKAtiFFWtvxrk/osSza33QUZ8cZApsT3jD2f4S4VbSY4k9gKS5HBTEpFVMaajLY47W7b/+iMGJBWTWSEgeQEDMFGWN4XXL1ec9xFX0Bat0o3MMPGpwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8a4d37684a8ee3f95989aa1198ae653d/a59e9/image-10.webp 192w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/0ca9f/image-10.webp 384w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/dc9b9/image-10.webp 768w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/e2c2f/image-10.webp 1152w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/f3efb/image-10.webp 1536w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/e99cb/image-10.webp 2150w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8a4d37684a8ee3f95989aa1198ae653d/3b721/image-10.png 192w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/66595/image-10.png 384w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/fe486/image-10.png 768w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/d2d74/image-10.png 1152w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/e8464/image-10.png 1536w,\n/static/8a4d37684a8ee3f95989aa1198ae653d/0c0fb/image-10.png 2150w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8a4d37684a8ee3f95989aa1198ae653d/fe486/image-10.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>상품을 조회할 때 쿼리를 보면 select ~ for update 가 실행 되어</p>\n<p>행(row) 단위로 동시 접근을 제어한다.</p>\n<p>그레서 동일 행에 대한 select .. for update 쿼리 실행시\n먼저 락을 구한 커넥션을 실행을 하고, 락을 구하지 못한 커넥션은 락을 구한 커넥션이\n트랜잭션을 종료할 때까지 대기한다.</p>\n<h2 id=\"잔액-차감\" style=\"position:relative;\"><a href=\"#%EC%9E%94%EC%95%A1-%EC%B0%A8%EA%B0%90\" aria-label=\"잔액 차감 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>잔액 차감</h2>\n<p>한 사용자가 동시에 여러 주문을 할 때\n(하나의 아이디를 A와 B가 같이 사용하고 동시에 주문을 함)</p>\n<h3 id=\"테스트-코드-작성-1\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1-1\" aria-label=\"테스트 코드 작성 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트 코드 작성</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"> <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"동시에 상품을 주문 하여도 주문한 상품 횟수 만큼 잔액을 차감한다.\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">deductPointWithConcurrency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"건희\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">User</span> savedUser <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Product</span> productOnion <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"양파\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productPotato <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"감자\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productCarrot <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productMushroom <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"버섯\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">,</span> productCarrot <span class=\"token punctuation\">,</span>productMushroom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">,</span> productCarrot<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productMushroom<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">,</span> productMushroom<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requests1 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request1_1<span class=\"token punctuation\">,</span> request1_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requests2 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request2_1<span class=\"token punctuation\">,</span> request2_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token class-name\">OrderPostRequest</span> orderPostRequest1 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">userId</span><span class=\"token punctuation\">(</span>savedUser<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">products</span><span class=\"token punctuation\">(</span>requests1<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">OrderPostRequest</span> orderPostRequest2 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">userId</span><span class=\"token punctuation\">(</span>savedUser<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">products</span><span class=\"token punctuation\">(</span>requests2<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">allOf</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span> orderService<span class=\"token punctuation\">.</span><span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span>orderPostRequest1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span> orderService<span class=\"token punctuation\">.</span><span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span>orderPostRequest2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> findUser <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>savedUser<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token comment\">//then                현재 잔액 5000L  - (양파 2개 , 감자 2개)  / ( 당근 2개 , 버섯 2개)</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>findUser<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">50000L</span><span class=\"token operator\">-</span><span class=\"token number\">6000L</span><span class=\"token operator\">-</span><span class=\"token number\">16000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"실패-케이스-1\" style=\"position:relative;\"><a href=\"#%EC%8B%A4%ED%8C%A8-%EC%BC%80%EC%9D%B4%EC%8A%A4-1\" aria-label=\"실패 케이스 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>실패 케이스</h3>\n<p>“건희” 유저가 (양파 2개 , 감자 2개) , (당근 2개, 버섯 2개) 를 주문했는데</p>\n<p>두 개의 주문 요청 모드 현재 잔액 50000L 포인트를 읽어서</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/495d1c76c653e088cd8515f9eb9dbc77/3753e/image-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.6875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAACToAAAk6AGCYwUcAAABH0lEQVR42o2PS1ODMBSF+R/aAkkgPEIe1FqmtSJ9Ofr/x39gd7JxKzleaF24cVx8c04yN+eeBA/rLRqi3Z3w2B2wXK1x32xQ362wWDaw9XLCjWe3gNMOhqhMPaHIE8PkK3sONvToZX/C4fkV3Rja7tF2RzztjqSHiW27w2bbwVYWVhlo0qzQyEsNnuZgSTYkpFzIc1AoDUVDJQ2N28rLxiuWWly0rAwYT8EijkxkE5KlECGHiPgwDxluZ/E5oCD/Q6HMxV+1UNe7Ee18KQu/EplvktzXXHoK8jIWXsT8K6RFFPoeqF+N/qYsDUzlcC8VrMhxQyEzakYMUSxAofTlyvb/gRr3SaZ7ntV9kpKXrmep68NI9PMw/qB2n7M5e/sGBWy1lq6RdzEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/495d1c76c653e088cd8515f9eb9dbc77/a59e9/image-4.webp 192w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/0ca9f/image-4.webp 384w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/dc9b9/image-4.webp 768w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/e2c2f/image-4.webp 1152w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/f3efb/image-4.webp 1536w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/92932/image-4.webp 2260w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/495d1c76c653e088cd8515f9eb9dbc77/3b721/image-4.png 192w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/66595/image-4.png 384w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/fe486/image-4.png 768w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/d2d74/image-4.png 1152w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/e8464/image-4.png 1536w,\n/static/495d1c76c653e088cd8515f9eb9dbc77/3753e/image-4.png 2260w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/495d1c76c653e088cd8515f9eb9dbc77/fe486/image-4.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>잔액은 1번만 차감되었기 때문에 실패 하였다.</p>\n<h3 id=\"성공-케이스-1\" style=\"position:relative;\"><a href=\"#%EC%84%B1%EA%B3%B5-%EC%BC%80%EC%9D%B4%EC%8A%A4-1\" aria-label=\"성공 케이스 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>성공 케이스</h3>\n<p>재고 차감과 마찬 가지로 비관적 락을 사용하자</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0626f24961b86d144bd80ae08d7f300f/a4847/image-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.70833333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAACToAAAk6AGCYwUcAAAB+0lEQVR42oVTSWLbMBDzQ2ItpMRdu604sVu3vfX/D0IxdJTGTpfDcBmR4AAY7WrdwvqAprUw1qNWLZ72JYqiZlQ59lw/7WWu3ubbXqIo1V3sYrA4TgnzPGJeJvg0wMQOtY0o/QTlZ7S+gw+3iPLdBq77XEBVN/eAFQfLAzGNMDy02ISfYcYP2+M1Doj9Aamf0fUT+mFmLGiNh9ImsykrfQ+459A0HmPkJVbkuO5cQnIRKSRebPNBoSkh643uFls+A8rQtgSJpMvqHOm1rNiYCO9IqwlQylBjB93YTFFzrbTNe93c8lulGVCTgsna9VmvQvGScqyWoE3K4M4nmpcymGhp3S235TctM+WgPc7U7YWUD/y4EnzKFyJUY/KFwMekkv0D3Ue3M2CnHb77EVc/4AuNubCCl0zb04DwXpHQKh/a5FPbFJViuYavUytWWlKvikC1ufWkaLe5+tGYvwOKhqTiWIXQywKXNVTNPJtdgCTeDeH80fXHR3ZCo2OfnV+vWOZnnC/fsK4vmMcFp+WM8/ErLusVp8OFzf+M9STzSk2HN6d/uy+xU0w427H3ZgTqGNLEBxbEbkakKambcmPLvhsOBBqR+CdJrh8PGKZjXtcEFyxqqNHoBt6YTNvzZXk9pD67K4akbsjzn6h+oizCizFlDv3PKP7jsAD+As21k4k9chxVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0626f24961b86d144bd80ae08d7f300f/a59e9/image-5.webp 192w,\n/static/0626f24961b86d144bd80ae08d7f300f/0ca9f/image-5.webp 384w,\n/static/0626f24961b86d144bd80ae08d7f300f/dc9b9/image-5.webp 768w,\n/static/0626f24961b86d144bd80ae08d7f300f/e2c2f/image-5.webp 1152w,\n/static/0626f24961b86d144bd80ae08d7f300f/f3efb/image-5.webp 1536w,\n/static/0626f24961b86d144bd80ae08d7f300f/a517d/image-5.webp 1685w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0626f24961b86d144bd80ae08d7f300f/3b721/image-5.png 192w,\n/static/0626f24961b86d144bd80ae08d7f300f/66595/image-5.png 384w,\n/static/0626f24961b86d144bd80ae08d7f300f/fe486/image-5.png 768w,\n/static/0626f24961b86d144bd80ae08d7f300f/d2d74/image-5.png 1152w,\n/static/0626f24961b86d144bd80ae08d7f300f/e8464/image-5.png 1536w,\n/static/0626f24961b86d144bd80ae08d7f300f/a4847/image-5.png 1685w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0626f24961b86d144bd80ae08d7f300f/fe486/image-5.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>유저의 잔액 정보를 읽는 로직을</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> userid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>userid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token keyword\">new</span> <span class=\"token class-name\">EntityNotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_NOT_FOUND</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>비관적 락이 설정된 메서드로 변경하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span>  name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Lock</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">LockModeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PESSIMISTIC_WRITE</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select u from User u where u.id = :userId\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByIdPessimisticLock</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userId\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">   <span class=\"token annotation punctuation\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> userid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdPessimisticLock</span><span class=\"token punctuation\">(</span>userid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token keyword\">new</span> <span class=\"token class-name\">EntityNotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_NOT_FOUND</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>결과</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e9aa85f4434e20e9c4c909f1d1275225/707c8/image-6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.479166666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAACToAAAk6AGCYwUcAAAAzUlEQVR42lWQaw6CMBCEexGFtoACLVYeIoKRmGi8/4XG3YJaf3yZ2Uk626xwdYt+mDCMN3T9Be3pgqY7w7oGZXX8x7qfeu9+fp1FN4y4P16Y70+M04zxOuNEC5q6Q0sc7JFwqMwBtqxgiFBDOBOOHvGP6rZH3fTec2YKizI3kJGCivSXz7yogo41kjjxqghR0OacmllDH8kU2b5EmuWIVQqd7KB0Bp3uPZK8omxDpZutXJQQhm4Swrfgwh2VFVTORexZY5n4UkUL5ApnIW9TZpZAkGW5xwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e9aa85f4434e20e9c4c909f1d1275225/a59e9/image-6.webp 192w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/0ca9f/image-6.webp 384w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/dc9b9/image-6.webp 768w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/e2c2f/image-6.webp 1152w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/f3efb/image-6.webp 1536w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/5f914/image-6.webp 3072w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e9aa85f4434e20e9c4c909f1d1275225/3b721/image-6.png 192w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/66595/image-6.png 384w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/fe486/image-6.png 768w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/d2d74/image-6.png 1152w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/e8464/image-6.png 1536w,\n/static/e9aa85f4434e20e9c4c909f1d1275225/707c8/image-6.png 3072w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e9aa85f4434e20e9c4c909f1d1275225/fe486/image-6.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"의문점\" style=\"position:relative;\"><a href=\"#%EC%9D%98%EB%AC%B8%EC%A0%90\" aria-label=\"의문점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>의문점</h3>\n<p>비관적 락을 적용하기 위해 관련 자료를 찾아보던 중 비관적 락을 사용했을 때 데드락 발생 가능성이 있다고 하였다.</p>\n<p>하지만 내가 작성한 코드에는 데드락이 발생하지 않아서 왜 데드락이 발생하지 않는지\n생각해보았다.</p>\n<p>내가 락을 설정한 쿼리를 보면</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Lock</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">LockModeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PESSIMISTIC_WRITE</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT p FROM Product p WHERE p.id IN :productIds \"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllByPessimisticLock</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"productIds\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> productIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이 코드는 상품 조회 시 where ~ In 절을 사용하여 데이터를 한 번에 가져온다.</p>\n<p>예를 들어, A 유저가 상품 1,2,3,4를 조회한 후 락을 설정한다면, B 유저가 상품 2,1,4,5,6을 조회하려 할 때 락이 이미 걸려있어서 B 유저는 락을 기다리게 됩니다. 이러한 상황에서는 B 유저만 락을 기다리므로 데드락이 발생하지 않을 것이라고 유추하였다.</p>\n<p>그렇다면 , 데드락이 발생하는 코드는 어떤 것일까?</p>\n<p>상품을 조회할 때 where ~ In 절로 한 번에 가져오는 것이 아니라 반복문을 통해 1개씩 조회하는 경우라고 생각하였다.</p>\n<p>A 유저가 상품 1,2,3,4를 조회하는데, 우선 상품 1을 조회합니다. 이때, B 유저는 2,1,4,5,6를 조회하는데, 우선 상품 2를 조회합니다. 그 다음 A 유저가 상품 2를 조회하려 하는데 B가 락을 선점했기 때문에 락 해제를 기다리게 됩니다. 그리고 B 유저가 상품 1을 조회하려 하는데 A가 상품 1에 대한 락을 선점했기 때문에 락 해제를 기다리게 됩니다.</p>\n<p>A 유저와 B 유저 모두 서로 락이 해제되기만을 기다리기 때문에 데드락이 발생한다.</p>\n<p>내가 유추한 것이 맞는지 확인하기 위해 테스트 코드를 작성해보았다.</p>\n<h4 id=\"테스트-코드\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C\" aria-label=\"테스트 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테스트 코드</h4>\n<p>재고 차감하는 로직</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deduct2</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requestForOrders <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestForOrder</span> requestForOrder <span class=\"token operator\">:</span> requestForOrders<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Product</span> findProduct <span class=\"token operator\">=</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdPessimisticLock</span><span class=\"token punctuation\">(</span>requestForOrder<span class=\"token punctuation\">.</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EntityNotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PRODUCT_NOT_FOUND</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Long</span> stock <span class=\"token operator\">=</span> requestForOrder<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            findProduct<span class=\"token punctuation\">.</span><span class=\"token function\">deductQuantity</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>반복문을 통해 상품을 하나 씩 조회한 뒤, 재고 차감을 진행하는 코드로 변경하였다.</p>\n<p>락 설정은 아래와 같이 설정하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token annotation punctuation\">@Lock</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">LockModeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PESSIMISTIC_WRITE</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT p FROM Product p WHERE p.id = :productId \"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByIdPessimisticLock</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"productId\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그리고 테스트 코드를 다음과 같이 작성하였다.</p>\n<p>“건희” 유저가 양파 3개, 감자 3개 주문</p>\n<p>“거니” 유저가 감자 3개, 양파 3개 주문</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">   <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"동시에 주문을 했을 때 주문에 맞게 재고를 차감한다. 데드락 테스트\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@RepeatedTest</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">deductQuantityWithConCurrency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">Product</span> productOnion <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"양파\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productPotato <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"감자\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productCarrot <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productMushroom <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"버섯\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">,</span>productPotato<span class=\"token punctuation\">,</span>productCarrot<span class=\"token punctuation\">,</span>productMushroom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> geonhee <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeUser</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"건희\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">User</span> gunny <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeUser</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"거니\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 양파 3개 , 감자 3개 주문</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 감자 3개 , 양파 3개 주문</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">OrderPostRequest</span> requests1 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>geonhee<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request1_1<span class=\"token punctuation\">,</span> request1_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">OrderPostRequest</span> requests2 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>gunny<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request2_1<span class=\"token punctuation\">,</span> request2_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">allOf</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>  fakeStockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct2</span><span class=\"token punctuation\">(</span>requests1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>  fakeStockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct2</span><span class=\"token punctuation\">(</span>requests2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Product</span> findProductPotato <span class=\"token operator\">=</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//then</span>\n        <span class=\"token class-name\">Assertions</span><span class=\"token punctuation\">.</span><span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>findProductPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">30L</span><span class=\"token operator\">-</span><span class=\"token number\">3L</span><span class=\"token operator\">-</span><span class=\"token number\">3L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"결과\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EA%B3%BC\" aria-label=\"결과 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결과</h4>\n<p>예상한 대로 데드락이 발생한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c1fe7356b6366d66e1a0934782bb31ca/e4ca2/image-7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAACToAAAk6AGCYwUcAAAAbklEQVR42qXOSw7DIAwEUA6SBoM/UNqq9z/ddEQkVGWZLJ4M9shyeo8PVB3VghqUisZlyaujFdKGzoaJwsn+KEUxhNjq+XT+K1JwSbeO8friyWsLQ5IVOddZ15vhac3qKXfUJLxw2wXb47BzcMcP555vuHLPnRYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c1fe7356b6366d66e1a0934782bb31ca/a59e9/image-7.webp 192w,\n/static/c1fe7356b6366d66e1a0934782bb31ca/0ca9f/image-7.webp 384w,\n/static/c1fe7356b6366d66e1a0934782bb31ca/dc9b9/image-7.webp 768w,\n/static/c1fe7356b6366d66e1a0934782bb31ca/e2c2f/image-7.webp 1152w,\n/static/c1fe7356b6366d66e1a0934782bb31ca/b78e0/image-7.webp 1312w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c1fe7356b6366d66e1a0934782bb31ca/3b721/image-7.png 192w,\n/static/c1fe7356b6366d66e1a0934782bb31ca/66595/image-7.png 384w,\n/static/c1fe7356b6366d66e1a0934782bb31ca/fe486/image-7.png 768w,\n/static/c1fe7356b6366d66e1a0934782bb31ca/d2d74/image-7.png 1152w,\n/static/c1fe7356b6366d66e1a0934782bb31ca/e4ca2/image-7.png 1312w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c1fe7356b6366d66e1a0934782bb31ca/fe486/image-7.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>만약에</p>\n<p>주문을 “건희” , “거니” 유저 모두 양파 3개, 감자 3개 순서대로 주문한다면??</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">        <span class=\"token class-name\">User</span> geonhee <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeUser</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"건희\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">User</span> gunny <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeUser</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"거니\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 양파 3개 , 감자 3개 주문</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 양파 3개 , 감자 3개 주문</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">OrderPostRequest</span> requests1 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>geonhee<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request1_1<span class=\"token punctuation\">,</span> request1_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">OrderPostRequest</span> requests2 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>gunny<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request2_1<span class=\"token punctuation\">,</span> request2_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">allOf</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>  fakeStockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct4</span><span class=\"token punctuation\">(</span>requests1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>  fakeStockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct4</span><span class=\"token punctuation\">(</span>requests2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>운 좋게 데드락이 발생하지 않을 수 있으니 테스트를 100번 수행하게 했지만</p>\n<p>데드락이 발생하지 않았다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/b2a21/image-8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.895833333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAACToAAAk6AGCYwUcAAABi0lEQVR42p2T23KCQBBE/Y+oiIrKHbkI4gVUNCl9yP9/TWd6jClJ8CUPU0PNsmd7enZ74TJFtiqx2R2Q5SXiNEcQJfDDGF6wfIpYa7/rrh+1opesCtSnC86Xq8ax+UB9aHCQ2q46oij3SLLiHnLYwvYwX7iYS+b3dGa3QoBrVKcG19snLu837OtGQCfN5bbSnKQFzLEFxw0wMqcYDE30ByMMBqZ+P0dv4fiIV7mqyddbla2nOwxfW7Ql82dP1kKxg2AewNrQGLei53gh0mKN+nhWRfSU0Ic/UZwpmIoIt6QtbjRGkz+wFrAS39abPQLZ5HwbzLVwmalXbJXKrLndCXoBrHTCrD2mRsW2gKiSrbNVbuxq9w+QLUcCeADvClNR6ItCS2t6bSSPJ9Z/gXcP3/qGwBLESS5Dc9XLLh9bwM2u1iF0Afmz7QRwvfvV4ZA6Feq1yXO5b6efoahf4huDQF6j8WSmHlIZgS+HskxWKPeVvhK+jrzYgDW+DPqlHgrIMCaYyQthTGeLl8AvvFxr9g8kz70AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/a59e9/image-8.webp 192w,\n/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/0ca9f/image-8.webp 384w,\n/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/dc9b9/image-8.webp 768w,\n/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/2bb8d/image-8.webp 987w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/3b721/image-8.png 192w,\n/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/66595/image-8.png 384w,\n/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/fe486/image-8.png 768w,\n/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/b2a21/image-8.png 987w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/1d8f42fc5db98f6e4bbc1f0ab97c569e/fe486/image-8.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>그렇다면, 제일 처음 유추 한대로</p>\n<p>where ~ In 절에 락을 걸었을 때도 테스트를 진행 해보면</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> requestForOrders <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> productIdQuntitiyMap <span class=\"token operator\">=</span> <span class=\"token function\">convertToProductIdQuantityMap</span><span class=\"token punctuation\">(</span>requestForOrders<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token operator\">=</span> fakeProductReader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Product</span> product <span class=\"token operator\">:</span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Long</span> quantity <span class=\"token operator\">=</span> productIdQuntitiyMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            product<span class=\"token punctuation\">.</span><span class=\"token function\">deductQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">   <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> productRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllByPessimisticLock</span><span class=\"token punctuation\">(</span>productRequest<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"동시에 주문을 했을 때 주문에 맞게 재고를 차감한다. 데드락 테스트\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@RepeatedTest</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">deductQuantityWithConCurrency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token class-name\">Product</span> productOnion <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"양파\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productPotato <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"감자\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productCarrot <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"당근\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Product</span> productMushroom <span class=\"token operator\">=</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"버섯\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">,</span>productPotato<span class=\"token punctuation\">,</span>productCarrot<span class=\"token punctuation\">,</span>productMushroom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> geonhee <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeUser</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"건희\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">User</span> gunny <span class=\"token operator\">=</span> <span class=\"token class-name\">FakeUser</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"거니\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 양파 3개 , 감자 3개 주문</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request1_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 감자 3개 , 양파 3개 주문</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_1 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productOnion<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ProductRequestForOrder</span> request2_2 <span class=\"token operator\">=</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">OrderPostRequest</span> requests1 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>geonhee<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request1_1<span class=\"token punctuation\">,</span> request1_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">OrderPostRequest</span> requests2 <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderPostRequest</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>gunny<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>request2_1<span class=\"token punctuation\">,</span> request2_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">allOf</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>  fakeStockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>requests1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>  fakeStockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>requests2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Product</span> findProductPotato <span class=\"token operator\">=</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>productPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//then</span>\n        <span class=\"token class-name\">Assertions</span><span class=\"token punctuation\">.</span><span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>findProductPotato<span class=\"token punctuation\">.</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">30L</span><span class=\"token operator\">-</span><span class=\"token number\">3L</span><span class=\"token operator\">-</span><span class=\"token number\">3L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"결과-1\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EA%B3%BC-1\" aria-label=\"결과 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결과</h4>\n<p>상품들의 한 번에 조회하기 때문에</p>\n<p>데드락이 발생하지 않는다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/06cc84f16b9343dc090abe68c8799d4e/9708d/image-9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAABKklEQVR42m2R3XaCMBCEeRGR/38ISDQoSCuK9rTv/zRcTHfX2nLRi+9kNyeZzGQtbU6Ybh+Y75+YH19ST7cH3i4z+nGC2Xc41Bpt1UDlCk2hUNNapQVRQhElwXWVFItVqAbdMOJyfWAY37GnBw5dj53u0LQGKR3MCcfxYG8c2Lb7u25/WNWLleQlzGkgwTv04YgkK5HmFUEuyJnrRwiiFBnt+UGMMM4QUu+HiRCs2Dr+YmUUoSWh4XyBpnjc52UtVHWLOMllz/VCgcXo4r/YW48FK5j+jCv9naGoa0HVaHEXJ4W440uOGwgvkVfPiCDH0+bl8CiCAjskQS+IyFWGlL6CRSOKzPG4Zp71KjIPhR3yVI/9KDGZUu3+ItOjT0eBiGxoAAw5WtXC8g0qCdLl5ZRxKAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/06cc84f16b9343dc090abe68c8799d4e/a59e9/image-9.webp 192w,\n/static/06cc84f16b9343dc090abe68c8799d4e/0ca9f/image-9.webp 384w,\n/static/06cc84f16b9343dc090abe68c8799d4e/dc9b9/image-9.webp 768w,\n/static/06cc84f16b9343dc090abe68c8799d4e/e2c2f/image-9.webp 1152w,\n/static/06cc84f16b9343dc090abe68c8799d4e/9ac9d/image-9.webp 1160w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/06cc84f16b9343dc090abe68c8799d4e/3b721/image-9.png 192w,\n/static/06cc84f16b9343dc090abe68c8799d4e/66595/image-9.png 384w,\n/static/06cc84f16b9343dc090abe68c8799d4e/fe486/image-9.png 768w,\n/static/06cc84f16b9343dc090abe68c8799d4e/d2d74/image-9.png 1152w,\n/static/06cc84f16b9343dc090abe68c8799d4e/9708d/image-9.png 1160w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/06cc84f16b9343dc090abe68c8799d4e/fe486/image-9.png\"\n            alt=\"Alt text\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>","frontmatter":{"title":"동시성 문제와 데이터 일관성 문제 해결 with pessimistic lock","summary":"e-커머스 상품 주문 서비스 중에 동시성 문제가 야기 되는 경우를 분석하고 테스트 코드를 작성해본다.","date":"2023.12.30.","categories":["항해플러스"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAACToAAAk6AGCYwUcAAAA40lEQVR42p2QyXLCMBBE+Q+8aZflRbEQ2EX+/7s6LSVUcYAcOHRNqz3zajyned1gXUDTCbS9RDso+LBinBYqYo4JflrhwlJl2CuNh1C2+o4zzzo9gKJXEITpQVMKim/ZSWg2qZorWH4realGaM7I98CkHA4bcKdKPUxAZLazbtoj67H6TL+bsWajtGh68Rr4JR2+ObCzcWbjlQAxSJx5iqacgjr3v77h5gXUvttQEzhxm8TNrm7CojwuBEr+Zvdi6D9VoPOEsF7ygbhljH7G7Q/YfgK0BE5zREo3GEsQD57NZ8Afc3vHg0a8i8sAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/9cc56873e8f0777bd2c8da78846ecabf/99484/image.png","srcSet":"/static/9cc56873e8f0777bd2c8da78846ecabf/8ebf9/image.png 266w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/7a139/image.png 531w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/99484/image.png 1062w","sizes":"(min-width: 1062px) 1062px, 100vw"},"sources":[{"srcSet":"/static/9cc56873e8f0777bd2c8da78846ecabf/c07fe/image.webp 266w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/5a620/image.webp 531w,\n/static/9cc56873e8f0777bd2c8da78846ecabf/20678/image.webp 1062w","type":"image/webp","sizes":"(min-width: 1062px) 1062px, 100vw"}]},"width":1062,"height":387}},"publicURL":"/static/9cc56873e8f0777bd2c8da78846ecabf/image.png"}}}}]}},"pageContext":{"slug":"/항해플러스/동시성문제/pessimistic-lock/"}},"staticQueryHashes":[],"slicesMap":{}}