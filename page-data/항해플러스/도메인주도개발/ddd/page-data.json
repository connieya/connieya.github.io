{"componentChunkName":"component---src-templates-post-template-tsx","path":"/항해플러스/도메인주도개발/ddd/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"tableOfContents":"","html":"<p>주문 도메인에 주문 항목을 표현하는 OrderProduct 객체를</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\r\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\r\n<span class=\"token annotation punctuation\">@Getter</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Id</span>\r\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\r\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> count<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> price<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@CreatedDate</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createdDate<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@LastModifiedDate</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> lastModifiedDate<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// ... 생략</span>\r\n<span class=\"token punctuation\">}</span>\r\n</code></pre></div>\n<p>의미를 더 분명하게 하기 위해 이름을 OrderLine 으로 변경하였다.</p>\n<p>또한, 구매 개수를 count 대신 quantity 로 변경하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\r\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\r\n<span class=\"token annotation punctuation\">@Getter</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderLine</span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Id</span>\r\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\r\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> quantity<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> price<span class=\"token punctuation\">;</span>\r\n\r\n\r\n    <span class=\"token annotation punctuation\">@CreatedDate</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createdDate<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@LastModifiedDate</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> lastModifiedDate<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// .... 생략</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>OrderService 가 의존하는 클래스가 많다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\r\n<span class=\"token annotation punctuation\">@Slf4j</span>\r\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderService</span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">UserReader</span> userReader<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OrderAppender</span> orderAppender<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PointManager</span> pointManager<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">StockManager</span> stockManager<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">UserManager</span> userManager<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PaymentService</span> paymentService<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ApplicationEventPublisher</span> publisher<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SystemTimeProvider</span> timeProvider<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">DataPlatformService</span> dataPlatformService<span class=\"token punctuation\">;</span>\r\n\r\n\r\n    <span class=\"token annotation punctuation\">@Transactional</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OrderPostResponse</span> <span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> userReader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 재고 차감</span>\r\n        stockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 주문</span>\r\n        <span class=\"token class-name\">Order</span> savedOrder <span class=\"token operator\">=</span> orderAppender<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> timeProvider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 잔액 차감</span>\r\n        userManager<span class=\"token punctuation\">.</span><span class=\"token function\">deductPoint</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 포인트 내역 저장</span>\r\n        pointManager<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token comment\">// 결제</span>\r\n        paymentService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>savedOrder<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        publisher<span class=\"token punctuation\">.</span><span class=\"token function\">publishEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">OrderPostResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>재고를 차감하는 행위를 StockManager 에서 수행한다.</p>\n<p>상품은 Product 도메인이고, Product 도메인 안에 quantity 필드가 재고를 나타낸다.</p>\n<p>그렇다면 StockManager 에서 재고를 차감하는 게 맞을까?</p>\n<p>StockManager 가 아닌 ProductService 에게 재고 차감하는 역할을 위임하자</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\r\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProductService</span> <span class=\"token punctuation\">{</span>\r\n\r\n      <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ProductRepository</span> productRepository<span class=\"token punctuation\">;</span>\r\n      <span class=\"token comment\">// .. 생략</span>\r\n\r\n     <span class=\"token annotation punctuation\">@Transactional</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> productRequests <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> productIdQuntitiyMap <span class=\"token operator\">=</span> <span class=\"token function\">convertToProductIdQuantityMap</span><span class=\"token punctuation\">(</span>productRequests<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token operator\">=</span> <span class=\"token function\">findProducts</span><span class=\"token punctuation\">(</span>productRequests<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Product</span> product <span class=\"token operator\">:</span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token class-name\">Long</span> quantity <span class=\"token operator\">=</span> productIdQuntitiyMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            product<span class=\"token punctuation\">.</span><span class=\"token function\">deductQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token keyword\">private</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">convertToProductIdQuantityMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findProducts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> productRequests<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllByPessimisticLock</span><span class=\"token punctuation\">(</span>productRequests<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>… 추후에 내용 추가하기…</p>","frontmatter":{"title":"도메인 주도 개발 리팩토링","summary":"도메인 주도 개발","date":"2023.01.06.","categories":["항해플러스"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAACToAAAk6AGCYwUcAAACl0lEQVR42o1Ua3OiMBT1f+xOd1RQfBVE5BkggQBq1W7dutP//yP60bM3qThdp7X9cOYScu/JfZykYzkT2FEIhyVYZgHmkYfxYgZrPsXIvQ3lc8ZJW2fy2jGDAaxohAEb4r5ywR8FJmyK7qKP3tJA1yPrGRrdRU+v9R5Zwzeh4gknMyTrD4jQH8JcDjEMLHiFD7Gr4EkfSxkgbBKwh4xsjKCOkO0ErXOkhHjNMGX3MJaKaHgyA81zJiQYRDplNqImJTBNGK9TxJtUB6t1UMfwq1CTe7QeJ7PPCVuoU+V+Bb8OiSwDI+R7ASefo+v20FuYBNUCsyW7TTjwLX0y30qElEm6zTFLbfSJYEBt0SCfq7gbhBQwiiZwxRJelYNtS9i5Qz0ewQrHet+KxhjHU+2n1jcJ23523V8wIglbFCieShS/JernhrBBfVxDPJYECYe7KvuTJlaEXDZ4D1GtUK232B+OeCQcji+oVg9Ihbz45EX1hrIGV5DNScVxWb92Ip7hGqwUKDcN1k9HPByeIVY1EvrHCoFEcL2vkBS8jTnFIlf2tdNfmriGmuCd8wO9qIBdFGA7RmVLlIeKbKW/012ulXCOOfVJ5FT6x0OZkHTYiiOoIkSkwfvM0RJpBzIMRxffL6esoIKimpGAGU1ZwCZCFayIWu0pn28Tqimrko2kwZyGkG1TiKcaq78blFRyeaipZAG+L75HqDSWrjl8Geo+veltpDO06Ftlpwja0r8U9jieIawS6h+n68dh0JB05v5AvzTG2e9bV085qafqzv4JI67gVjUkCVv+IX0+r7F52SHfcSq7oaGF2vdTQnXqjF6cuMn0E2Zz71Jqe4/HyfS/9c0MlYN6bZKGRLpK4Aj3fVmXCj7o+4XwH3A9XrB+OnV8AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/5682e46de17abd6052f6962103595f58/df4e4/image.png","srcSet":"/static/5682e46de17abd6052f6962103595f58/af7d6/image.png 203w,\n/static/5682e46de17abd6052f6962103595f58/164a3/image.png 405w,\n/static/5682e46de17abd6052f6962103595f58/df4e4/image.png 810w","sizes":"(min-width: 810px) 810px, 100vw"},"sources":[{"srcSet":"/static/5682e46de17abd6052f6962103595f58/1ccbb/image.webp 203w,\n/static/5682e46de17abd6052f6962103595f58/67876/image.webp 405w,\n/static/5682e46de17abd6052f6962103595f58/b22e3/image.webp 810w","type":"image/webp","sizes":"(min-width: 810px) 810px, 100vw"}]},"width":810,"height":752}},"publicURL":"/static/5682e46de17abd6052f6962103595f58/image.png"}}}}]}},"pageContext":{"slug":"/항해플러스/도메인주도개발/ddd/"}},"staticQueryHashes":[],"slicesMap":{}}