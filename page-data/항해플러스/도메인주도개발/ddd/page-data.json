{"componentChunkName":"component---src-templates-post-template-tsx","path":"/항해플러스/도메인주도개발/ddd/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EC%A3%BC%EB%AC%B8-%EB%B9%84%EC%A6%88%EB%8B%88%EC%8A%A4-%EB%A1%9C%EC%A7%81\">주문 비즈니스 로직</a></p>\n<ul>\n<li><a href=\"#%EC%9E%AC%EA%B3%A0-%EC%B0%A8%EA%B0%90-%ED%96%89%EC%9C%84\">재고 차감 행위</a></li>\n<li><a href=\"#%EC%9E%94%EC%95%A1-%EC%B0%A8%EA%B0%90-%ED%96%89%EC%9C%84\">잔액 차감 행위</a></li>\n</ul>\n</li>\n</ul>","html":"<p>주문 도메인에 주문 항목을 표현하는 OrderProduct 객체</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\r\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\r\n<span class=\"token annotation punctuation\">@Getter</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Id</span>\r\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\r\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> count<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> price<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@CreatedDate</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createdDate<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@LastModifiedDate</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> lastModifiedDate<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// ... 생략</span>\r\n<span class=\"token punctuation\">}</span>\r\n</code></pre></div>\n<p>의미를 더 분명하게 하기 위해 이름을 OrderLine 으로 변경하였다.</p>\n<p>또한, 구매 개수를 count 대신 quantity 로 변경하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\r\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\r\n<span class=\"token annotation punctuation\">@Getter</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderLine</span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Id</span>\r\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\r\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> productId<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> quantity<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> price<span class=\"token punctuation\">;</span>\r\n\r\n\r\n    <span class=\"token annotation punctuation\">@CreatedDate</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createdDate<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@LastModifiedDate</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> lastModifiedDate<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// .... 생략</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"주문-비즈니스-로직\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EB%AC%B8-%EB%B9%84%EC%A6%88%EB%8B%88%EC%8A%A4-%EB%A1%9C%EC%A7%81\" aria-label=\"주문 비즈니스 로직 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주문 비즈니스 로직</h2>\n<p>OrderService 에서 createOrder 메서드로 주문을 생성한다.</p>\n<p>여기서 코드를 개선 해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\r\n<span class=\"token annotation punctuation\">@Slf4j</span>\r\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderService</span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">UserReader</span> userReader<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OrderAppender</span> orderAppender<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PointManager</span> pointManager<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">StockManager</span> stockManager<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">UserManager</span> userManager<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PaymentService</span> paymentService<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ApplicationEventPublisher</span> publisher<span class=\"token punctuation\">;</span>\r\n\r\n\r\n    <span class=\"token annotation punctuation\">@Transactional</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OrderPostResponse</span> <span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> userReader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 재고 차감</span>\r\n        stockManager<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 주문</span>\r\n        <span class=\"token class-name\">Order</span> savedOrder <span class=\"token operator\">=</span> orderAppender<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> timeProvider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 잔액 차감</span>\r\n        userManager<span class=\"token punctuation\">.</span><span class=\"token function\">deductPoint</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 포인트 내역 저장</span>\r\n        pointManager<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token comment\">// 결제</span>\r\n        paymentService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>savedOrder<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        publisher<span class=\"token punctuation\">.</span><span class=\"token function\">publishEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">OrderPostResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>savedOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"재고-차감-행위\" style=\"position:relative;\"><a href=\"#%EC%9E%AC%EA%B3%A0-%EC%B0%A8%EA%B0%90-%ED%96%89%EC%9C%84\" aria-label=\"재고 차감 행위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>재고 차감 행위</h3>\n<p>재고를 차감하는 행위를 StockManager 에서 수행한다.</p>\n<p>상품은 Product 도메인이고, Product 도메인 안에 quantity 필드가 재고를 나타낸다.</p>\n<p>그렇다면 StockManager 에서 재고를 차감하는 게 맞을까?</p>\n<p>StockManager 가 아닌 ProductService 에게 재고 차감하는 역할을 위임하자</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\r\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProductService</span> <span class=\"token punctuation\">{</span>\r\n\r\n      <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ProductRepository</span> productRepository<span class=\"token punctuation\">;</span>\r\n      <span class=\"token comment\">// .. 생략</span>\r\n\r\n     <span class=\"token annotation punctuation\">@Transactional</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderPostRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> productRequests <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> productIdQuntitiyMap <span class=\"token operator\">=</span> <span class=\"token function\">convertToProductIdQuantityMap</span><span class=\"token punctuation\">(</span>productRequests<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token operator\">=</span> <span class=\"token function\">findProducts</span><span class=\"token punctuation\">(</span>productRequests<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Product</span> product <span class=\"token operator\">:</span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token class-name\">Long</span> quantity <span class=\"token operator\">=</span> productIdQuntitiyMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            product<span class=\"token punctuation\">.</span><span class=\"token function\">deductQuantity</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n        productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token keyword\">private</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">convertToProductIdQuantityMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> products<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getQuantity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findProducts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token punctuation\">></span></span> productRequests<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> productRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllByPessimisticLock</span><span class=\"token punctuation\">(</span>productRequests<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestForOrder</span><span class=\"token operator\">::</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"잔액-차감-행위\" style=\"position:relative;\"><a href=\"#%EC%9E%94%EC%95%A1-%EC%B0%A8%EA%B0%90-%ED%96%89%EC%9C%84\" aria-label=\"잔액 차감 행위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>잔액 차감 행위</h3>\n<p>UserManager 클래스에서 잔액 차감을 하고 있다.</p>\n<p>UserManager 는 어떤 역할을 하는 지 이름도 모호하고 UserManager 클래스에서 도메인 로직을 구현하는 것은 옳지 않는 것 같다.</p>\n<p>잔액 차감이라는 로직은 User 도메인이 이미 하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\r\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"users\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\r\n<span class=\"token annotation punctuation\">@Getter</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseEntity</span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Id</span>\r\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> currentPoint<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Version</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> version<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// .. 생략</span>\r\n\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deductPoints</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> totalPrice<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentPoint <span class=\"token operator\">&lt;</span> totalPrice<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserException<span class=\"token punctuation\">.</span>InsufficientPointsException</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INSUFFICIENT_POINT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentPoint <span class=\"token operator\">-=</span> totalPrice<span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// .. 생략</span>\r\n\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>잔액이 부족한지 여부도 체크해서 응집도를 높인 코드이다.</p>\n<p>UserManager 라는 클래스를 따로 만들어서 비즈니스 로직을 괜히 복잡하게 할 필요가 없을 것 같다.</p>\n<p>그리고 잔액 차감은 결제 하기 전에 하는 것으로 정했기 때문에</p>\n<p>PaymentService execute 메서드에 파리미터로 넘긴 뒤에</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\r\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PaymentService</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PaymentRepository</span> paymentRepository<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Order</span> order <span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span> user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        user<span class=\"token punctuation\">.</span><span class=\"token function\">deductPoints</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">.</span><span class=\"token function\">getTotalPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token class-name\">Payment</span> payment <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Payment</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        paymentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>payment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n</code></pre></div>\n<p>User 도메인 로직을 수행하는 식으로 코드 수를 줄여 나갔다.</p>","frontmatter":{"title":"도메인 주도 개발 , 리팩토링","summary":"도메인 주도 개발","date":"2023.01.06.","categories":["항해플러스"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAACToAAAk6AGCYwUcAAACl0lEQVR42o1Ua3OiMBT1f+xOd1RQfBVE5BkggQBq1W7dutP//yP60bM3qThdp7X9cOYScu/JfZykYzkT2FEIhyVYZgHmkYfxYgZrPsXIvQ3lc8ZJW2fy2jGDAaxohAEb4r5ywR8FJmyK7qKP3tJA1yPrGRrdRU+v9R5Zwzeh4gknMyTrD4jQH8JcDjEMLHiFD7Gr4EkfSxkgbBKwh4xsjKCOkO0ErXOkhHjNMGX3MJaKaHgyA81zJiQYRDplNqImJTBNGK9TxJtUB6t1UMfwq1CTe7QeJ7PPCVuoU+V+Bb8OiSwDI+R7ASefo+v20FuYBNUCsyW7TTjwLX0y30qElEm6zTFLbfSJYEBt0SCfq7gbhBQwiiZwxRJelYNtS9i5Qz0ewQrHet+KxhjHU+2n1jcJ23523V8wIglbFCieShS/JernhrBBfVxDPJYECYe7KvuTJlaEXDZ4D1GtUK232B+OeCQcji+oVg9Ihbz45EX1hrIGV5DNScVxWb92Ip7hGqwUKDcN1k9HPByeIVY1EvrHCoFEcL2vkBS8jTnFIlf2tdNfmriGmuCd8wO9qIBdFGA7RmVLlIeKbKW/012ulXCOOfVJ5FT6x0OZkHTYiiOoIkSkwfvM0RJpBzIMRxffL6esoIKimpGAGU1ZwCZCFayIWu0pn28Tqimrko2kwZyGkG1TiKcaq78blFRyeaipZAG+L75HqDSWrjl8Geo+veltpDO06Ftlpwja0r8U9jieIawS6h+n68dh0JB05v5AvzTG2e9bV085qafqzv4JI67gVjUkCVv+IX0+r7F52SHfcSq7oaGF2vdTQnXqjF6cuMn0E2Zz71Jqe4/HyfS/9c0MlYN6bZKGRLpK4Aj3fVmXCj7o+4XwH3A9XrB+OnV8AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/5682e46de17abd6052f6962103595f58/df4e4/image.png","srcSet":"/static/5682e46de17abd6052f6962103595f58/af7d6/image.png 203w,\n/static/5682e46de17abd6052f6962103595f58/164a3/image.png 405w,\n/static/5682e46de17abd6052f6962103595f58/df4e4/image.png 810w","sizes":"(min-width: 810px) 810px, 100vw"},"sources":[{"srcSet":"/static/5682e46de17abd6052f6962103595f58/1ccbb/image.webp 203w,\n/static/5682e46de17abd6052f6962103595f58/67876/image.webp 405w,\n/static/5682e46de17abd6052f6962103595f58/b22e3/image.webp 810w","type":"image/webp","sizes":"(min-width: 810px) 810px, 100vw"}]},"width":810,"height":752}},"publicURL":"/static/5682e46de17abd6052f6962103595f58/image.png"}}}}]}},"pageContext":{"slug":"/항해플러스/도메인주도개발/ddd/"}},"staticQueryHashes":[],"slicesMap":{}}