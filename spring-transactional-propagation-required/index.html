<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.5"/><meta data-react-helmet="true" name="description"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0"/><meta data-react-helmet="true" http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:title" content="Spring @Transactional의 기본, REQUIRED 파헤치기"/><meta data-react-helmet="true" property="og:description"/><meta data-react-helmet="true" property="og:image" content=""/><meta data-react-helmet="true" property="og:url"/><meta data-react-helmet="true" property="og:site_name" content="Spring @Transactional의 기본, REQUIRED 파헤치기"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Spring @Transactional의 기본, REQUIRED 파헤치기"/><meta data-react-helmet="true" name="twitter:description"/><meta data-react-helmet="true" name="twitter:image" content=""/><meta data-react-helmet="true" name="twitter:site" content="@사용자이름"/><meta data-react-helmet="true" name="twitter:creator" content="@사용자이름"/><meta data-react-helmet="true" name="google-site-verification" content="웹 마스터 도구가 제공하는 Meta 태그"/><meta data-react-helmet="true" name="naver-site-verification" content="웹 마스터 도구가 제공하는 Meta 태그"/><style data-href="/styles.9e907bc32054b7771552.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Spring @Transactional의 기본, REQUIRED 파헤치기</title><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="canonical" href="https://connieya.github.io/spring-transactional-propagation-required/" data-baseprotocol="https:" data-basehost="connieya.github.io"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css 11pfcjj">.css-11pfcjj{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;}</style><div class="css-11pfcjj esjg9ma0"><style data-emotion="css 123clne">.css-123clne{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;height:7rem;}</style><div class="css-123clne e1o8p83g6"><style data-emotion="css j1kgmw">.css-j1kgmw{width:100%;max-width:768px;margin:0 auto;padding:0 1rem;}@media (max-width: 768px){.css-j1kgmw{padding:0 0.75rem;}}</style><div class="css-j1kgmw e1o8p83g5"><style data-emotion="css 15umcqw">.css-15umcqw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:2rem;}</style><div class="css-15umcqw e1o8p83g4"><style data-emotion="css 6ybclw">.css-6ybclw{-webkit-text-decoration:none;text-decoration:none;color:inherit;-webkit-transition:opacity 0.2s ease;transition:opacity 0.2s ease;}.css-6ybclw:hover{opacity:0.8;}</style><a class="css-6ybclw e1o8p83g3" href="/"><style data-emotion="css vqqu6f">.css-vqqu6f{font-size:1.3rem;font-weight:bold;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol','Noto Color Emoji';}</style><span class="css-vqqu6f e1o8p83g1">박건희</span></a><a class="css-6ybclw e1o8p83g2" href="/blog/"><style data-emotion="css 11g2wj9">.css-11g2wj9{font-size:1.1rem;font-weight:400;color:#666;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol','Noto Color Emoji';}</style><span class="css-11g2wj9 e1o8p83g0">개발</span></a><a class="css-6ybclw e1o8p83g2" href="/guestbook/"><span class="css-11g2wj9 e1o8p83g0">방명록</span></a></div></div></div><style data-emotion="css-global 4cqo99">*{padding:0;margin:0;box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol','Noto Color Emoji';}html,body,#___gatsby{height:100%;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol','Noto Color Emoji';}a,a:hover{color:inherit;-webkit-text-decoration:none;text-decoration:none;cursor:pointer;}</style><style data-emotion="css 11k3q87">.css-11k3q87{position:relative;width:100%;max-width:768px;margin:0 auto;}</style><div class="css-11k3q87 e17f455w0"><style data-emotion="css jwelnu">.css-jwelnu{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:2.5rem 1rem 2rem;max-width:768px;margin:0 auto;}@media (max-width: 768px){.css-jwelnu{padding:2rem 0.75rem 1.5rem;}}</style><div class="css-jwelnu ehbuenk4"><style data-emotion="css gjsprg">.css-gjsprg{word-break:keep-all;line-height:1.3;font-size:1.9rem;margin-bottom:1.3rem;}@media (max-width: 768px){.css-gjsprg{font-size:1.8rem;margin-bottom:0.8rem;}}</style><h1 class="css-gjsprg ehbuenk3">Spring @Transactional의 기본, REQUIRED 파헤치기</h1><style data-emotion="css 1r9pax5">.css-1r9pax5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;color:#757575;font-size:0.9rem;}@media (max-width: 768px){.css-1r9pax5{-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;}}</style><div class="css-1r9pax5 ehbuenk2"><style data-emotion="css 1bmnxg7">.css-1bmnxg7{white-space:nowrap;}</style><div class="css-1bmnxg7 ehbuenk1">2024-03-15<style data-emotion="css uaob3j">.css-uaob3j{margin-left:0.5rem;}</style><span class="css-uaob3j ehbuenk0">약 <!-- -->10<!-- -->분</span></div></div></div><style data-emotion="css pqebd0">.css-pqebd0{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;margin:0 auto;padding:1.5rem 1rem;line-height:1.75;word-break:break-all;}@media (max-width: 768px){.css-pqebd0{padding:1.5rem 0.75rem;}}.css-pqebd0 h1,.css-pqebd0 h2,.css-pqebd0 h3{margin-bottom:1.5rem;font-weight:700;}.css-pqebd0 h1{padding-left:0.2rem;font-size:2rem;border-bottom:1px solid #e2e5e6;}.css-pqebd0 h2{font-size:1.75rem;border-bottom:1px solid #e2e5e6;}.css-pqebd0 h3{font-size:1.25rem;}.css-pqebd0 *+h1,.css-pqebd0 *+h2,.css-pqebd0 *+h3{margin-top:2rem;margin-bottom:0.5rem;}.css-pqebd0 hr+h1,.css-pqebd0 hr+h2,.css-pqebd0 hr+h3{margin-top:0;}.css-pqebd0 blockquote{margin:30px 0;padding:0 1rem;color:#757575;font-weight:800;border-left:2px solid #e2e5e6;}.css-pqebd0 ol,.css-pqebd0 ul{margin-top:0rem;margin-bottom:0rem;margin-left:1rem;padding:0.5rem 0;}.css-pqebd0 li{font-weight:300;}.css-pqebd0 hr{margin:100px 0;border:1px solid #000;}.css-pqebd0 a{color:#0E68C8;}.css-pqebd0 p{margin:0;padding:0.5rem 0;font-weight:300;}.css-pqebd0 img{margin:1rem 0;max-width:100%;height:auto;display:block;margin-left:auto;margin-right:auto;}.css-pqebd0 pre[class*='language-'],.css-pqebd0 code[class*='language-']{color:#d4d4d4;font-size:13px;font-family:Menlo,Monaco,Consolas,'Andale Mono','Ubuntu Mono','Courier New',monospace;direction:ltr;white-space:pre;text-align:left;text-shadow:none;word-break:normal;word-spacing:normal;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;border-radius:0.5rem;}.css-pqebd0 pre[class*='language-']::selection,.css-pqebd0 code[class*='language-']::selection,.css-pqebd0 pre[class*='language-'] *::selection,.css-pqebd0 code[class*='language-'] *::selection{text-shadow:none;background:#264f78;}@media print{.css-pqebd0 pre[class*='language-'],.css-pqebd0 code[class*='language-']{text-shadow:none;}}.css-pqebd0 pre[class*='language-']{padding:1rem;overflow:auto;background:#1e1e1e;}.css-pqebd0:not(pre)>code[class*='language-']{padding:0.1em 0.3em;background:#1e1e1e;border-radius:0;border-radius:0.3em;}.css-pqebd0 .namespace{opacity:0.7;}.css-pqebd0 .token.doctype .token.doctype-tag{color:#569cd6;}.css-pqebd0 .token.doctype .token.name{color:#9cdcfe;}.css-pqebd0 .token.comment,.css-pqebd0 .token.prolog{color:#6a9955;}.css-pqebd0 .token.punctuation,.css-pqebd0 .language-html .language-css .token.punctuation,.css-pqebd0 .language-html .language-javascript .token.punctuation{color:#d4d4d4;}.css-pqebd0 .token.property,.css-pqebd0 .token.tag,.css-pqebd0 .token.boolean,.css-pqebd0 .token.number,.css-pqebd0 .token.constant,.css-pqebd0 .token.symbol,.css-pqebd0 .token.inserted,.css-pqebd0 .token.unit{color:#b5cea8;}.css-pqebd0 .token.selector,.css-pqebd0 .token.attr-name,.css-pqebd0 .token.string,.css-pqebd0 .token.char,.css-pqebd0 .token.builtin,.css-pqebd0 .token.deleted{color:#ce9178;}.css-pqebd0 .language-css .token.string.url{-webkit-text-decoration:underline;text-decoration:underline;}.css-pqebd0 .token.operator,.css-pqebd0 .token.entity{color:#d4d4d4;}.css-pqebd0 .token.operator.arrow{color:#569cd6;}.css-pqebd0 .token.atrule{color:#ce9178;}.css-pqebd0 .token.atrule .token.rule{color:#c586c0;}.css-pqebd0 .token.atrule .token.url{color:#9cdcfe;}.css-pqebd0 .token.atrule .token.url .token.function{color:#dcdcaa;}.css-pqebd0 .token.atrule .token.url .token.punctuation{color:#d4d4d4;}.css-pqebd0 .token.keyword{color:#569cd6;}.css-pqebd0 .token.keyword.module,.css-pqebd0 .token.keyword.control-flow{color:#c586c0;}.css-pqebd0 .token.function,.css-pqebd0 .token.function .token.maybe-class-name{color:#dcdcaa;}.css-pqebd0 .token.regex{color:#d16969;}.css-pqebd0 .token.important{color:#569cd6;}.css-pqebd0 .token.italic{font-style:italic;}.css-pqebd0 .token.constant{color:#9cdcfe;}.css-pqebd0 .token.class-name,.css-pqebd0 .token.maybe-class-name{color:#4ec9b0;}.css-pqebd0 .token.console{color:#9cdcfe;}.css-pqebd0 .token.parameter{color:#9cdcfe;}.css-pqebd0 .token.interpolation{color:#9cdcfe;}.css-pqebd0 .token.punctuation.interpolation-punctuation{color:#569cd6;}.css-pqebd0 .token.boolean{color:#569cd6;}.css-pqebd0 .token.property,.css-pqebd0 .token.variable,.css-pqebd0 .token.imports .token.maybe-class-name,.css-pqebd0 .token.exports .token.maybe-class-name{color:#9cdcfe;}.css-pqebd0 .token.selector{color:#d7ba7d;}.css-pqebd0 .token.escape{color:#d7ba7d;}.css-pqebd0 .token.tag{color:#569cd6;}.css-pqebd0 .token.tag .token.punctuation{color:#808080;}.css-pqebd0 .token.cdata{color:#808080;}.css-pqebd0 .token.attr-name{color:#9cdcfe;}.css-pqebd0 .token.attr-value,.css-pqebd0 .token.attr-value .token.punctuation{color:#ce9178;}.css-pqebd0 .token.attr-value .token.punctuation.attr-equals{color:#d4d4d4;}.css-pqebd0 .token.entity{color:#569cd6;}.css-pqebd0 .token.namespace{color:#4ec9b0;}.css-pqebd0 pre[class*='language-javascript'],.css-pqebd0 code[class*='language-javascript'],.css-pqebd0 pre[class*='language-jsx'],.css-pqebd0 code[class*='language-jsx'],.css-pqebd0 pre[class*='language-typescript'],.css-pqebd0 code[class*='language-typescript'],.css-pqebd0 pre[class*='language-tsx'],.css-pqebd0 code[class*='language-tsx']{color:#9cdcfe;}.css-pqebd0 pre[class*='language-css'],.css-pqebd0 code[class*='language-css']{color:#ce9178;}.css-pqebd0 pre[class*='language-html'],.css-pqebd0 code[class*='language-html']{color:#d4d4d4;}.css-pqebd0 .language-regex .token.anchor{color:#dcdcaa;}.css-pqebd0 .language-html .token.punctuation{color:#808080;}.css-pqebd0 pre[class*='language-']>code[class*='language-']{position:relative;z-index:1;}.css-pqebd0 .line-highlight.line-highlight{z-index:0;background:#f7ebc6;box-shadow:inset 5px 0 0 #f7d87c;}.css-pqebd0 pre[class*='language-text'],.css-pqebd0 code[class*='language-text']{padding:0.25rem;color:#000000;background-color:#e2e5e6;}@media (max-width: 768px){.css-pqebd0 img{width:100%;}.css-pqebd0 pre[class*='language-']{width:100%;overflow-x:auto;}}</style><div class="css-pqebd0 e13plzdv0"><h2 id="tldr" style="position:relative;"><a href="#tldr" aria-label="tldr permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TL;DR</h2>
<ul>
<li>REQUIRED는 있으면 합류, 없으면 새로 시작합니다. 외부 TX가 있으면 내부는 한 몸이 되어 원자성이 보장됩니다.</li>
<li>내부에서 예외가 나면 TX는 rollback-only로 찍히고, 바깥에서 try-catch로 잡아도 최종 커밋 시 UnexpectedRollbackException이 발생합니다.</li>
<li>의도적 부분 커밋이 필요하면 noRollbackFor(원자성 해제) 또는 REQUIRES_NEW(독립 TX)로 명시하세요.</li>
</ul>
<h2 id="들어가며" style="position:relative;"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0" aria-label="들어가며 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>들어가며</h2>
<p>트랜잭션은 원자성(Atomicity), 즉 'All or Nothing'을 보장합니다. 하나의 작업 단위로 묶인 모든 연산이 함께 성공하거나 함께 실패하는 이 강력한 원칙 덕분에, 우리는 데이터 정합성을 믿고 개발할 수 있습니다.</p>
<p>하지만 이 믿음은 때로 예상치 못한 결과를 낳기도 합니다. 현실의 코드는 수많은 @Transactional 어노테이션과 서비스 간의 연쇄 호출로 이루어져 있기 때문입니다. 예를 들어, 주문 처리 로직 안에서 재고를 감소시키고 포인트를 차감하는 것은 흔한 시나리오입니다.</p>
<p>이때 내부적으로 호출된 서비스의 트랜잭션은 어떻게 동작할까요? 독립적인 트랜잭션으로 처리될까요, 아니면 외부의 더 큰 트랜잭션의 일부가 될까요?</p>
<p>만약 두 서비스가 하나의 트랜잭션으로 묶인다면, 이들은 하나의 '운명 공동체'가 됩니다. 재고 차감은 성공했지만 포인트 차감에서 예외가 발생하면, 이미 성공한 재고 차감까지 모두 롤백되어 원자성이 보장됩니다. 반면, 만약 서로 다른 트랜잭션으로 동작한다면 재고는 커밋되고 포인트만 롤백되는 '부분 커밋' 상황이 발생하여 데이터 정합성이 깨질 수 있습니다.</p>
<p>이처럼 기존 트랜잭션에 합류할지, 새로 시작할지를 결정하는 규칙이 바로 <strong>트랜잭션 전파(Transaction Propagation)</strong> 입니다. 전파를 제대로 이해하지 못하면, 의도치 않은 롤백 범위와 데이터 불일치라는 함정에 빠지기 쉽습니다. 한번 어긋난 데이터는 시스템 규모가 클수록 추적하고 복구하기 매우 어렵습니다.</p>
<h2 id="전파propagation-7종-살펴보기" style="position:relative;"><a href="#%EC%A0%84%ED%8C%8Cpropagation-7%EC%A2%85-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0" aria-label="전파propagation 7종 살펴보기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>전파(Propagation) 7종 살펴보기</h2>
<p>스프링은 다음과 같이 7가지의 트랜잭션 전파 속성을 제공합니다. <br/> 이번 글에서는 이 중에서 가장 기본이자 핵심인 <code class="language-text">REQUIRED</code> 속성에 대해 집중적으로 알아보겠습니다.</p>
<table>
<thead>
<tr>
<th align="left">전파</th>
<th align="left">한 줄 정의</th>
<th align="left">부모 TX 있음</th>
<th align="left">부모 TX 없음</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code class="language-text">REQUIRED</code> (기본)</td>
<td align="left">있으면 <strong>합류</strong>, 없으면 <strong>새로 시작</strong></td>
<td align="left">합류</td>
<td align="left">새 TX 시작</td>
</tr>
<tr>
<td align="left"><code class="language-text">REQUIRES_NEW</code></td>
<td align="left"><strong>항상 새 TX</strong>로 실행, 부모는 <strong>일시중단</strong></td>
<td align="left">부모 <strong>suspend</strong> 후 새 TX</td>
<td align="left">새 TX</td>
</tr>
<tr>
<td align="left"><code class="language-text">NESTED</code></td>
<td align="left">부모 TX 안에서 <strong>세이브포인트</strong> 생성(부분 롤백)</td>
<td align="left">세이브포인트로 부분 롤백</td>
<td align="left"><code class="language-text">REQUIRED</code>처럼 새 TX</td>
</tr>
<tr>
<td align="left"><code class="language-text">SUPPORTS</code></td>
<td align="left">있으면 타고, 없으면 <strong>비트랜잭션</strong></td>
<td align="left">합류</td>
<td align="left">TX 없이 실행</td>
</tr>
<tr>
<td align="left"><code class="language-text">MANDATORY</code></td>
<td align="left"><strong>부모 TX 필수</strong></td>
<td align="left">합류</td>
<td align="left">예외 발생</td>
</tr>
<tr>
<td align="left"><code class="language-text">NOT_SUPPORTED</code></td>
<td align="left"><strong>항상 비트랜잭션</strong>, 부모는 <strong>일시중단</strong></td>
<td align="left">부모 <strong>suspend</strong></td>
<td align="left">TX 없이 실행</td>
</tr>
<tr>
<td align="left"><code class="language-text">NEVER</code></td>
<td align="left"><strong>TX 금지</strong></td>
<td align="left">예외 발생</td>
<td align="left">TX 없이 실행</td>
</tr>
</tbody>
</table>
<h3 id="전파를-눈으로-확인하기" style="position:relative;"><a href="#%EC%A0%84%ED%8C%8C%EB%A5%BC-%EB%88%88%EC%9C%BC%EB%A1%9C-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0" aria-label="전파를 눈으로 확인하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>전파를 ‘눈’으로 확인하기</h3>
<p>트랜잭션 경계, 합류, 커밋, 롤백이 실제로 어떻게 동작하는지 로그로 직접 확인하는 것이 가장 확실한 방법입니다.</p>
<p>아래 설정을 application.yml에 추가하면 트랜잭션의 모든 동작을 한눈에 볼 수 있습니다.</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token comment"># Tx 경계/합류/롤백/서스펜드</span>
    <span class="token key atrule">org.springframework.transaction.interceptor</span><span class="token punctuation">:</span> TRACE
    <span class="token key atrule">org.springframework.orm.jpa.JpaTransactionManager</span><span class="token punctuation">:</span> DEBUG

    <span class="token comment"># SQL + 바인딩 값 (Hibernate 6)</span>
    <span class="token key atrule">org.hibernate.SQL</span><span class="token punctuation">:</span> DEBUG
    <span class="token key atrule">org.hibernate.orm.jdbc.bind</span><span class="token punctuation">:</span> TRACE

    <span class="token comment"># 선택: 상위 TM/풀/슬로우SQL</span>
    <span class="token key atrule">org.springframework.transaction</span><span class="token punctuation">:</span> DEBUG
    <span class="token key atrule">com.zaxxer.hikari</span><span class="token punctuation">:</span> DEBUG</code></pre></div>
<h2 id="required--있으면-타고-없으면-내가-시작한다" style="position:relative;"><a href="#required--%EC%9E%88%EC%9C%BC%EB%A9%B4-%ED%83%80%EA%B3%A0-%EC%97%86%EC%9C%BC%EB%A9%B4-%EB%82%B4%EA%B0%80-%EC%8B%9C%EC%9E%91%ED%95%9C%EB%8B%A4" aria-label="required  있으면 타고 없으면 내가 시작한다 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>REQUIRED — “있으면 타고, 없으면 내가 시작한다"</h2>
<p>@Transactional의 기본 전파 속성은 <code class="language-text">REQUIRED</code>입니다. 규칙은 매우 단순합니다.</p>
<ul>
<li>부모 트랜잭션이 있으면 → 합류합니다.</li>
<li>없으면 → 새로운 트랜잭션을 시작합니다.</li>
</ul>
<p>이 단순한 규칙이 어떻게 원자성을 보장하고, 또 때로는 어떻게 부분 커밋을 유발하는지 시나리오를 통해 알아보겠습니다.</p>
<h2 id="테스트-시나리오" style="position:relative;"><a href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4" aria-label="테스트 시나리오 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>테스트 시나리오</h2>
<p>간단한 이커머스 시나리오를 바탕으로 트랜잭션 전파 속성을 테스트해 보겠습니다. 주문 시 재고 차감 후 포인트를 차감하는 순서로 로직이 진행됩니다. 트랜잭션 전파 속성 자체에 집중하기 위해 변수명이나 계층 구조 , 로직을 단순화했습니다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token comment">// 주문</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StockService</span> stockService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PointService</span> pointService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">place</span><span class="token punctuation">(</span><span class="token class-name">OrderCommand<span class="token punctuation">.</span>Place</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stockService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StockCommand<span class="token punctuation">.</span>Deduct</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pointService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PointCommand<span class="token punctuation">.</span>Deduct</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 재고 차감</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StockRepository</span> stockRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token class-name">StockCommand<span class="token punctuation">.</span>Deduct</span> deduct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... 재고 차감 로직 ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 포인트 차감</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PointService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PointRepository</span> pointRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token class-name">PointCommand<span class="token punctuation">.</span>Deduct</span> pointCommand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... 포인트 차감 로직 (잔액 부족 시 예외 발생) ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2 id="시나리오-1--외부-트랜잭션-있음---모두-한-몸처럼-롤백" style="position:relative;"><a href="#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-1--%EC%99%B8%EB%B6%80-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%9E%88%EC%9D%8C---%EB%AA%A8%EB%91%90-%ED%95%9C-%EB%AA%B8%EC%B2%98%EB%9F%BC-%EB%A1%A4%EB%B0%B1" aria-label="시나리오 1  외부 트랜잭션 있음   모두 한 몸처럼 롤백 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>시나리오 1 : 외부 트랜잭션 있음 -> 모두 한 몸처럼 롤백</h2>
<p>상황</p>
<ul>
<li>OrderService.place() 에 @Transactional 있음</li>
<li>포인트가 부족해 PointService.deduct() 에서 런타임 예외 발생</li>
</ul>
<p>테스트 코드</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"REQUIRED: 외부 TX가 있으면 포인트 예외 시 전체 롤백"</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">required_withOuterTx_rollsBackAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// given</span>
    <span class="token class-name">Stock</span> stock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stock</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Stock</span> savedStock <span class="token operator">=</span> stockRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Point</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Point</span> savedPoint <span class="token operator">=</span> pointRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// when</span>
    <span class="token function">assertThatThrownBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
        orderService<span class="token punctuation">.</span><span class="token function">place</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderCommand<span class="token punctuation">.</span>Place</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


     <span class="token class-name">Point</span> updatedPoint <span class="token operator">=</span> pointRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>savedPoint<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">Stock</span> updatedStock <span class="token operator">=</span> stockRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>savedStock<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// then: 모두 롤백</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>updatedPoint<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>updatedStock<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>테스트는 성공합니다. 로그를 통해 동작을 살펴보겠습니다.</p>
<h3 id="stockservicededuct는-기존-트랜잭션에-합류" style="position:relative;"><a href="#stockservicededuct%EB%8A%94-%EA%B8%B0%EC%A1%B4-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%97%90-%ED%95%A9%EB%A5%98" aria-label="stockservicededuct는 기존 트랜잭션에 합류 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>StockService.deduct는 기존 트랜잭션에 합류</h3>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Getting transaction for [...StockService.deduct]
Participating in existing transaction</code></pre></div>
<p>Participating in existing transaction 메시지를 통해 OrderService가 만든 트랜잭션에 성공적으로 합류했음을 확인할 수 있습니다.</p>
<h3 id="pointservicededuct에서-예외-발생-및-rollback-only-마킹" style="position:relative;"><a href="#pointservicededuct%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D-%EB%B0%8F-rollback-only-%EB%A7%88%ED%82%B9" aria-label="pointservicededuct에서 예외 발생 및 rollback only 마킹 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PointService.deduct에서 예외 발생 및 rollback-only 마킹</h3>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Completing transaction for [...PointService.deduct] after exception: ...
Participating transaction failed - marking existing transaction as rollback-only</code></pre></div>
<h3 id="orderserviceplace-종료-시점에-전체-롤백" style="position:relative;"><a href="#orderserviceplace-%EC%A2%85%EB%A3%8C-%EC%8B%9C%EC%A0%90%EC%97%90-%EC%A0%84%EC%B2%B4-%EB%A1%A4%EB%B0%B1" aria-label="orderserviceplace 종료 시점에 전체 롤백 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OrderService.place 종료 시점에 전체 롤백</h3>
<p>내부에서 예외가 발생했고 트랜잭션이 rollback-only로 표시되었기 때문에, 가장 바깥쪽 트랜잭션 경계인 OrderService가 종료되는 시점에 트랜잭션 매니저는 최종적으로 롤백을 실행합니다</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Completing transaction for [OrderService.place] after exception: ...
Initiating transaction rollback
Rolling back JPA transaction on EntityManager [...]</code></pre></div>
<p><code class="language-text">Initiating transaction rollback</code> 로그를 통해 트랜잭션 전체에 대한 롤백이 시작되었음을 명확히 알 수 있습니다.</p>
<p>이처럼 외부 트랜잭션이 있으므로 <code class="language-text">StockService</code>와 <code class="language-text">PointService</code>는 모두 <code class="language-text">OrderService</code>가 시작한 트랜잭션에 합류했습니다. 그 결과, <code class="language-text">PointService</code>에서 발생한 문제가 트랜잭션 '운명 공동체' 전체에 영향을 주었습니다. 이로 인해 성공적으로 수행된 것처럼 보였던 재고 차감 로직까지 함께 롤백되었습니다.</p>
<p>이것이 바로 <code class="language-text">REQUIRED</code> 전파 속성이 데이터의 원자성을 보장하는 방식입니다.</p>
<h2 id="시나리오-2--try-catch-도-소용없는-rollback-only" style="position:relative;"><a href="#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-2--try-catch-%EB%8F%84-%EC%86%8C%EC%9A%A9%EC%97%86%EB%8A%94-rollback-only" aria-label="시나리오 2  try catch 도 소용없는 rollback only permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>시나리오 2 : try-catch 도 소용없는 rollback-only</h2>
<p>앞선 실험에서 우리는 PointService에서 발생한 예외가 OrderService까지 전파되어 전체 트랜잭션을 롤백시키는 것을 확인했습니다.</p>
<p>그렇다면 이런 의문이 생길 수 있습니다.</p>
<p>"만약 OrderService에서 try-catch로 예외를 잡아서 정상 흐름처럼 처리하면, 재고 차감(StockService)은 커밋되지 않을까?"</p>
<p>직접 코드로 확인해 보겠습니다.</p>
<p>OrderService 수정</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">placeWithTryCatch</span><span class="token punctuation">(</span><span class="token class-name">OrderCommand<span class="token punctuation">.</span>Place</span> orderCommand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stockService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StockCommand<span class="token punctuation">.</span>Deduct</span><span class="token punctuation">(</span>orderCommand<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
          pointService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PointCommand<span class="token punctuation">.</span>Deduct</span><span class="token punctuation">(</span>orderCommand<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderCommand<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre></div>
<p>try-catch로 예외를 제어하려는 시도</p>
<p>상황</p>
<ul>
<li>OrderService.placeWithTryCatch()는 @Transactional이 선언되어 있습니다. (외부 트랜잭션 시작)</li>
<li>내부적으로 stockService.deduct()를 호출합니다. (기존 트랜잭션에 합류)</li>
<li>pointService.deduct()를 호출하고, 여기서 발생하는 예외를 try-catch로 잡습니다.</li>
</ul>
<p>테스트 코드</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"REQUIRED: 내부 예외를 catch하면 재고는 커밋될 것이라 예상하는 테스트"</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">required_withCatch_expectCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// given</span>
    <span class="token class-name">Stock</span> stock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stock</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stockRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Point</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pointRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// when</span>
    <span class="token comment">// 예외가 발생하지 않을 것이므로, 그냥 메서드를 호출한다.</span>
    orderService<span class="token punctuation">.</span><span class="token function">placeWithTryCatch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderCommand<span class="token punctuation">.</span>Place</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// then</span>
    <span class="token class-name">Stock</span> updatedStock <span class="token operator">=</span> stockRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Point</span> updatedPoint <span class="token operator">=</span> pointRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 재고는 5로 줄고, 포인트는 그대로 1000이길 기대한다.</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>updatedStock<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;--- 이 검증은 실패할 것이다!</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>updatedPoint<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="예상치-못한-결과-unexpectedrollbackexception" style="position:relative;"><a href="#%EC%98%88%EC%83%81%EC%B9%98-%EB%AA%BB%ED%95%9C-%EA%B2%B0%EA%B3%BC-unexpectedrollbackexception" aria-label="예상치 못한 결과 unexpectedrollbackexception permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>예상치 못한 결과: UnexpectedRollbackException</h3>
<p>하지만 위 테스트를 실행하면, then 검증 구문에 도달하기도 전에 테스트는 실패하며 콘솔에 낯선 예외가 출력됩니다.</p>
<p><img src="/images/transactional/unexpectedRollbackException.png" alt="alt text"></p>
<p>try-catch로 분명히 예외를 잡았는데, 왜 뜬금없이 롤백 관련 예외가 발생하는 것일까요? 바로 여기에 REQUIRED 전파의 핵심 동작 방식인 <strong>rollback-only</strong>가 숨어있습니다</p>
<p>rollback-only 란?</p>
<blockquote>
<p>하나의 물리적인 트랜잭션에 여러 메서드가 참여(REQUIRED)하고 있을 때, 그중 하나라도 롤백되어야 하는 상황이 발생하면 스프링은 현재 트랜잭션에 <strong>"이 트랜잭션은 결국 롤백되어야만 합니다"</strong> 라는 낙인, 즉 rollback-only 플래그를 찍습니다.</p>
</blockquote>
<p>이 낙인은 한번 찍히면 절대 지워지지 않으며, 트랜잭션에 참여한 모든 구성원에게 전파됩니다.</p>
<p>로그를 통해 이 과정을 따라가 보겠습니다.</p>
<h3 id="pointservice에서-예외-발생-및-rollback-only-마킹" style="position:relative;"><a href="#pointservice%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D-%EB%B0%8F-rollback-only-%EB%A7%88%ED%82%B9" aria-label="pointservice에서 예외 발생 및 rollback only 마킹 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PointService에서 예외 발생 및 rollback-only 마킹:</h3>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Completing transaction for [PointService.deduct] after exception: ...
Participating transaction failed - marking existing transaction as rollback-only // 바로 이 순간!</code></pre></div>
<p><code class="language-text">PointService.deduct()</code>에서 예외가 발생하자마자, PointService를 감싸고 있던 트랜잭션 인터셉터는 예외를 잡고 자신이 참여한 물리 트랜잭션에 <code class="language-text">rollback-only</code> 플래그를 세팅합니다. 그리고 나서 잡았던 예외를 다시 밖으로 던집니다.</p>
<h3 id="orderservice에서-예외-catch" style="position:relative;"><a href="#orderservice%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-catch" aria-label="orderservice에서 예외 catch permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OrderService에서 예외 catch:</h3>
<p>OrderService의 try-catch 블록은 PointService가 던진 예외를 성공적으로 잡아냅니다. 그래서 placeWithTryCatch 메서드 자체는 아무 문제 없이 정상적으로 종료됩니다.</p>
<h3 id="orderservice-트랜잭션-커밋-시도" style="position:relative;"><a href="#orderservice-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%BB%A4%EB%B0%8B-%EC%8B%9C%EB%8F%84" aria-label="orderservice 트랜잭션 커밋 시도 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OrderService 트랜잭션 커밋 시도:</h3>
<p>가장 바깥쪽 트랜잭션 경계인 placeWithTryCatch 메서드가 종료되고, 스프링의 트랜잭션 매니저는 이제 트랜잭션을 커밋하려고 합니다.</p>
<h3 id="rollback-only-플래그-발견-및-강제-롤백" style="position:relative;"><a href="#rollback-only-%ED%94%8C%EB%9E%98%EA%B7%B8-%EB%B0%9C%EA%B2%AC-%EB%B0%8F-%EA%B0%95%EC%A0%9C-%EB%A1%A4%EB%B0%B1" aria-label="rollback only 플래그 발견 및 강제 롤백 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rollback-only 플래그 발견 및 강제 롤백:</h3>
<p>바로 이때, 트랜잭션 매니저는 커밋을 시도하기 전에 트랜잭션의 상태를 확인하고, rollback-only 낙인이 찍혀있는 것을 발견합니다.</p>
<ul>
<li>개발자 코드: 정상 종료되었으니 커밋을 원함</li>
<li>트랜잭션 상태: rollback-only이므로 롤백되어야 함</li>
</ul>
<p>이처럼 개발자의 의도와 트랜잭션의 실제 상태가 불일치하는 상황을 명확하게 알리기 위해, 스프링은 <strong>UnexpectedRollbackException</strong> 을 던지는 것입니다.</p>
<p>"너의 코드는 정상 종료됐지만, 트랜잭션은 이미 롤백되도록 운명이 정해져 있어서 어쩔 수 없이 롤백했어!"라고 알려주는 친절한 경고인 셈입니다.</p>
<h3 id="올바른-테스트와-검증" style="position:relative;"><a href="#%EC%98%AC%EB%B0%94%EB%A5%B8-%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%99%80-%EA%B2%80%EC%A6%9D" aria-label="올바른 테스트와 검증 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>올바른 테스트와 검증</h3>
<p>이제 이 동작을 정확히 이해했으니, 테스트 코드를 올바르게 수정할 수 있습니다. placeWithTryCatch 호출하면 최종적으로 UnexpectedRollbackException이 발생하고, 모든 데이터 변경 사항은 롤백될 것임을 검증해야 합니다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"REQUIRED: 내부 예외를 catch해도 rollback-only 때문에 전체 롤백된다"</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">required_withCatch_rollsBackAll_dueToRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// given</span>
    <span class="token class-name">Stock</span> stock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stock</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stockRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Point</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pointRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// when &amp; then</span>
    <span class="token comment">// placeWithTryCatch 호출 시 UnexpectedRollbackException이 발생하는 것을 검증</span>
    <span class="token function">assertThatThrownBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
        orderService<span class="token punctuation">.</span><span class="token function">placeWithTryCatch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderCommand<span class="token punctuation">.</span>Place</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span><span class="token class-name">UnexpectedRollbackException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// then: 모든 것이 롤백되었는지 최종 확인</span>
    <span class="token class-name">Stock</span> updatedStock <span class="token operator">=</span> stockRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Point</span> updatedPoint <span class="token operator">=</span> pointRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 재고와 포인트 모두 초기 상태 그대로여야 한다.</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>updatedStock<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>updatedPoint<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>이 테스트는 성공합니다. 이를 통해 우리는 REQUIRED 전파 환경에서 try-catch는 예외의 흐름을 제어할 뿐, 한번 찍힌 rollback-only 낙인을 무효화할 수는 없다는 중요한 사실을 배울 수 있습니다.</p>
<h2 id="시나리오-3--norollbackfor로-롤백-정책-직접-제어하기" style="position:relative;"><a href="#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-3--norollbackfor%EB%A1%9C-%EB%A1%A4%EB%B0%B1-%EC%A0%95%EC%B1%85-%EC%A7%81%EC%A0%91-%EC%A0%9C%EC%96%B4%ED%95%98%EA%B8%B0" aria-label="시나리오 3  norollbackfor로 롤백 정책 직접 제어하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>시나리오 3 : noRollbackFor로 롤백 정책 직접 제어하기</h2>
<p>그렇다면 '예외는 발생했지만, 전체 작업을 롤백하고 싶지는 않은' 경우는 어떻게 처리해야 할까요? 이럴 때 사용하는 것이 바로 @Transactional의 noRollbackFor 속성입니다.</p>
<p>noRollbackFor는 특정 예외가 발생하더라도 트랜잭션을 rollback-only로 마킹하지 말라고 스프링에게 알려주는 기능입니다.</p>
<p>상황</p>
<ul>
<li>PointService.deduct 메서드의 @Transactional에 <strong>noRollbackFor = IllegalArgumentException.class</strong>를 추가합니다.</li>
<li>OrderService에서는 이전과 동일하게 try-catch로 IllegalArgumentException을 잡습니다.</li>
</ul>
<p>PointService 수정</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"> <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>noRollbackFor <span class="token operator">=</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deductWithNoRollbackFor</span><span class="token punctuation">(</span><span class="token class-name">PointCommand<span class="token punctuation">.</span>Deduct</span> pointCommand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Point</span> point <span class="token operator">=</span> pointRepository<span class="token punctuation">.</span><span class="token function">findByUserId</span><span class="token punctuation">(</span>pointCommand<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"포인트가 없습니다."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      point<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>pointCommand<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span></code></pre></div>
<p>OrderService 수정</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">placeWithTryCatch</span><span class="token punctuation">(</span><span class="token class-name">OrderCommand<span class="token punctuation">.</span>Place</span> orderCommand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stockService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StockCommand<span class="token punctuation">.</span>Deduct</span><span class="token punctuation">(</span>orderCommand<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
         pointService<span class="token punctuation">.</span><span class="token function">deductWithNoRollbackFor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PointCommand<span class="token punctuation">.</span>Deduct</span><span class="token punctuation">(</span>orderCommand<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderCommand<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>테스트 코드</p>
<p>이제 우리의 시나리오대로라면, placeWithTryCatch 예외 없이 정상 종료되고, 재고 차감(StockService)은 커밋되어야 합니다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"noRollbackFor: 내부 예외를 catch하면 재고 차감은 정상 커밋된다"</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">noRollbackFor_withCatch_commitsPartial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stock</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Stock</span> savedStock <span class="token operator">=</span> stockRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Point</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Point</span> savedPoint <span class="token operator">=</span> pointRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        orderService<span class="token punctuation">.</span><span class="token function">placeWithTryCatch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderCommand<span class="token punctuation">.</span>Place</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Point</span> updatedPoint <span class="token operator">=</span> pointRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>savedPoint<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Stock</span> updatedStock <span class="token operator">=</span> stockRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>savedStock<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>updatedPoint<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>updatedStock<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span></code></pre></div>
<p>이 테스트는 성공합니다! 드디어 우리가 의도한 대로 부분 커밋을 제어할 수 있게 되었습니다.</p>
<p>로그로 확인하는 동작 원리</p>
<p>이전과 로그를 비교해 보면 결정적인 차이를 발견할 수 있습니다.</p>
<h3 id="pointservicededuct에서-예외-발생--rollback-only-마킹-안-함" style="position:relative;"><a href="#pointservicededuct%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D--rollback-only-%EB%A7%88%ED%82%B9-%EC%95%88-%ED%95%A8" aria-label="pointservicededuct에서 예외 발생  rollback only 마킹 안 함 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PointService.deduct에서 예외 발생 → rollback-only 마킹 안 함!</h3>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">// PointService.deduct() 진입
Getting transaction for [PointService.deduct]
Found thread-bound EntityManager [...] for JPA transaction
Participating in existing transaction

// 예외 발생 후
Completing transaction for [PointService...] after exception: IllegalArgumentException: 포인트가 부족합니다.
// *** 이전과 달리 'marking existing transaction as rollback-only' 로그가 없다! ***</code></pre></div>
<p>noRollbackFor 설정 때문에, IllegalArgumentException이 발생했음에도 불구하고 트랜잭션 인터셉터는 트랜잭션을 rollback-only로 마킹하지 않고 그냥 예외만 던집니다.</p>
<h3 id="orderservice에서-커밋-성공" style="position:relative;"><a href="#orderservice%EC%97%90%EC%84%9C-%EC%BB%A4%EB%B0%8B-%EC%84%B1%EA%B3%B5" aria-label="orderservice에서 커밋 성공 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OrderService에서 커밋 성공</h3>
<p>OrderService가 예외를 catch하고 메서드가 정상적으로 종료된 후, 트랜잭션 매니저가 커밋을 시도합니다.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">// OrderService.placeWithTryCatch() 메서드가 정상 종료된 후
Completing transaction for [OrderService.placeWithTryCatch]
// rollback-only 플래그가 없으므로, 커밋을 진행한다.
Initiating transaction commit
Committing JPA transaction on EntityManager [...]</code></pre></div>
<p>rollback-only 낙인이 없으므로 트랜잭션 매니저는 아무런 방해 없이 커밋을 진행합니다. 이 시점까지 트랜잭션 내에서 성공적으로 수행된 모든 작업(즉, stockService.deduct())이 DB에 반영됩니다.</p>
<h3 id="norollbackfor-사용-시-주의사항" style="position:relative;"><a href="#norollbackfor-%EC%82%AC%EC%9A%A9-%EC%8B%9C-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD" aria-label="norollbackfor 사용 시 주의사항 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>noRollbackFor 사용 시 주의사항</h3>
<p>noRollbackFor는 강력한 기능이지만, 신중하게 사용해야 합니다.</p>
<ul>
<li>데이터 정합성: 이 기능을 사용한다는 것은 의도적으로 원자성을 깨고 부분 커밋을 허용하겠다는 의미입니다. 재고는 차감됐는데 주문은 실패하는 등의 시나리오가 발생하지 않도록 비즈니스 로직을 매우 신중하게 설계해야 합니다.</li>
<li>예외의 성격: NullPointerException이나 DataAccessException과 같이 시스템이 불안정하거나 데이터 접근에 문제가 생긴 예외에 대해서는 noRollbackFor를 사용해서는 안 됩니다. 비즈니스적으로 예측 가능하고, 후속 처리가 가능한 예외(예: InsufficientBalanceException)에 대해서만 제한적으로 사용하는 것이 좋습니다.</li>
</ul>
<p>이렇게 rollbackFor/noRollbackFor 속성을 활용하면, 단순한 성공/실패를 넘어 훨씬 더 정교하고 유연한 트랜잭션 제어가 가능해집니다.</p>
<h2 id="시나리오-4--외부-트랜잭션-없음--의도치-않은-부분-커밋-발생" style="position:relative;"><a href="#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-4--%EC%99%B8%EB%B6%80-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%97%86%EC%9D%8C--%EC%9D%98%EB%8F%84%EC%B9%98-%EC%95%8A%EC%9D%80-%EB%B6%80%EB%B6%84-%EC%BB%A4%EB%B0%8B-%EB%B0%9C%EC%83%9D" aria-label="시나리오 4  외부 트랜잭션 없음  의도치 않은 부분 커밋 발생 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>시나리오 4 : 외부 트랜잭션 없음 → 의도치 않은 부분 커밋 발생</h2>
<p>마지막으로, OrderService의 @Transactional을 제거하면 어떻게 될까요?</p>
<ul>
<li>OrderService.placeNoTx()로 호출하면, 외부 트랜잭션이 없는 상태에서 시작합니다.</li>
<li>StockService.deduct()는 부모 트랜잭션이 없으므로 REQUIRED 정책에 따라 새로운 트랜잭션(TX1)을 시작합니다. 로직 수행 후 TX1을 커밋합니다.</li>
<li>PointService.deduct() 역시 부모 트랜잭션이 없으므로 또 다른 새로운 트랜잭션(TX2)을 시작합니다. 로직 수행 중 예외가 발생하여 TX2는 롤백됩니다.</li>
</ul>
<p>결과적으로 재고 차감은 커밋되고, 포인트 차감은 롤백되는 부분 커밋이 발생하여 데이터 정합성이 깨지게 됩니다. 이는 트랜잭션 전파에 대한 이해 없이 @Transactional을 남용했을 때 발생할 수 있는 대표적인 문제입니다.</p>
<h2 id="requires_new는-어떨까" style="position:relative;"><a href="#requires_new%EB%8A%94-%EC%96%B4%EB%96%A8%EA%B9%8C" aria-label="requires_new는 어떨까 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>REQUIRES_NEW는 어떨까?</h2>
<p>부분 커밋을 허용할 것이라면 <code class="language-text">REQUIRED_NEW</code> 가 낫지 않을까?</p>
<p>noRollbackFor 과 REQUIRED_NEW 의 차이는 무엇일까?</p>
<p>한 줄 비교</p>
<ul>
<li>noRollbackFor : 같은 물리 TX 내에서 특정 예외에 대해 rollback-only 마킹을 막아 부분 커밋을 허용합니다.</li>
<li>REQUIRES_NEW : 부모 TX를 <strong>일시중단(suspend)</strong> 하고 완전히 새로운 물리 TX로 실행합니다. 부분 커밋/롤백 경계를 더 명확히 관리할 수 있습니다</li>
</ul>
<p><code class="language-text">REQUIRES_NEW</code> 에 대한 더 자세한 내용은 다음 시리즈에서 깊이 있게 다루어 보겠습니다.</p>
<h2 id="맺으며" style="position:relative;"><a href="#%EB%A7%BA%EC%9C%BC%EB%A9%B0" aria-label="맺으며 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>맺으며</h2>
<p>지금까지 @Transactional의 기본 전파 전략인 REQUIRED에 대해 깊이 있게 알아보았습니다.</p>
<h3 id="요약" style="position:relative;"><a href="#%EC%9A%94%EC%95%BD" aria-label="요약 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>요약</h3>
<ul>
<li>REQUIRED는 호출하는 쪽에 진행 중인 트랜잭션이 있으면 참여하고, 없으면 새로운 트랜잭션을 시작합니다.</li>
<li>이 특징 때문에 서비스의 가장 바깥 계층에 @Transactional을 선언하면, 그 안에서 호출되는 다른 서비스들은 하나의 거대한 트랜잭션으로 묶여 원자성을 보장받을 수 있습니다.</li>
<li>하지만 트랜잭션 내에서 발생한 RuntimeException은 트랜잭션을 rollback-only로 마킹하며, 이는 try-catch로도 막을 수 없는 강력한 전파력을 가집니다.</li>
<li>이런 롤백 정책을 제어하고 싶을 때는 noRollbackFor 와 같은 속성을 사용해 명시적으로 처리해야 합니다.</li>
<li>반대로, 가장 바깥 계층에 트랜잭션이 없으면 각 서비스가 개별 트랜잭션을 생성하여 의도치 않은 부분 커밋을 유발할 수 있음을 항상 명심해야 합니다.</li>
</ul></div><style data-emotion="css fmunkh">.css-fmunkh{position:absolute;top:0;left:768px;height:100%;padding-left:4rem;}@media (max-width: 1400px){.css-fmunkh{display:none;}}</style><aside class="css-fmunkh ek4ynda1"><style data-emotion="css 1s5ilwz">.css-1s5ilwz{position:-webkit-sticky;position:sticky;top:6rem;width:240px;overflow:hidden;font-size:0.8rem;}.css-1s5ilwz p{margin:0;}.css-1s5ilwz a{display:block;padding:0.5rem;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;border-radius:4px;-webkit-transition:all 0.1s ease-out;transition:all 0.1s ease-out;}.css-1s5ilwz a:hover{background-color:#badcff;}.css-1s5ilwz ul:first-child{border-left:none;}.css-1s5ilwz ul{margin-left:0.5rem;padding:0 0.5rem;list-style:none;border-left:2px solid #e2e5e6;}</style><nav class="css-1s5ilwz ek4ynda0"><ul>
<li>
<p><a href="#tldr">TL;DR</a></p>
</li>
<li>
<p><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></p>
</li>
<li>
<p><a href="#%EC%A0%84%ED%8C%8Cpropagation-7%EC%A2%85-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0">전파(Propagation) 7종 살펴보기</a></p>
<ul>
<li><a href="#%EC%A0%84%ED%8C%8C%EB%A5%BC-%EB%88%88%EC%9C%BC%EB%A1%9C-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0">전파를 ‘눈’으로 확인하기</a></li>
</ul>
</li>
<li>
<p><a href="#required--%EC%9E%88%EC%9C%BC%EB%A9%B4-%ED%83%80%EA%B3%A0-%EC%97%86%EC%9C%BC%EB%A9%B4-%EB%82%B4%EA%B0%80-%EC%8B%9C%EC%9E%91%ED%95%9C%EB%8B%A4">REQUIRED — “있으면 타고, 없으면 내가 시작한다"</a></p>
</li>
<li>
<p><a href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4">테스트 시나리오</a></p>
</li>
<li>
<p><a href="#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-1--%EC%99%B8%EB%B6%80-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%9E%88%EC%9D%8C---%EB%AA%A8%EB%91%90-%ED%95%9C-%EB%AA%B8%EC%B2%98%EB%9F%BC-%EB%A1%A4%EB%B0%B1">시나리오 1 : 외부 트랜잭션 있음 -> 모두 한 몸처럼 롤백</a></p>
<ul>
<li><a href="#stockservicededuct%EB%8A%94-%EA%B8%B0%EC%A1%B4-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%97%90-%ED%95%A9%EB%A5%98">StockService.deduct는 기존 트랜잭션에 합류</a></li>
<li><a href="#pointservicededuct%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D-%EB%B0%8F-rollback-only-%EB%A7%88%ED%82%B9">PointService.deduct에서 예외 발생 및 rollback-only 마킹</a></li>
<li><a href="#orderserviceplace-%EC%A2%85%EB%A3%8C-%EC%8B%9C%EC%A0%90%EC%97%90-%EC%A0%84%EC%B2%B4-%EB%A1%A4%EB%B0%B1">OrderService.place 종료 시점에 전체 롤백</a></li>
</ul>
</li>
<li>
<p><a href="#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-2--try-catch-%EB%8F%84-%EC%86%8C%EC%9A%A9%EC%97%86%EB%8A%94-rollback-only">시나리오 2 : try-catch 도 소용없는 rollback-only</a></p>
<ul>
<li><a href="#%EC%98%88%EC%83%81%EC%B9%98-%EB%AA%BB%ED%95%9C-%EA%B2%B0%EA%B3%BC-unexpectedrollbackexception">예상치 못한 결과: UnexpectedRollbackException</a></li>
<li><a href="#pointservice%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D-%EB%B0%8F-rollback-only-%EB%A7%88%ED%82%B9">PointService에서 예외 발생 및 rollback-only 마킹:</a></li>
<li><a href="#orderservice%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-catch">OrderService에서 예외 catch:</a></li>
<li><a href="#orderservice-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%BB%A4%EB%B0%8B-%EC%8B%9C%EB%8F%84">OrderService 트랜잭션 커밋 시도:</a></li>
<li><a href="#rollback-only-%ED%94%8C%EB%9E%98%EA%B7%B8-%EB%B0%9C%EA%B2%AC-%EB%B0%8F-%EA%B0%95%EC%A0%9C-%EB%A1%A4%EB%B0%B1">rollback-only 플래그 발견 및 강제 롤백:</a></li>
<li><a href="#%EC%98%AC%EB%B0%94%EB%A5%B8-%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%99%80-%EA%B2%80%EC%A6%9D">올바른 테스트와 검증</a></li>
</ul>
</li>
<li>
<p><a href="#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-3--norollbackfor%EB%A1%9C-%EB%A1%A4%EB%B0%B1-%EC%A0%95%EC%B1%85-%EC%A7%81%EC%A0%91-%EC%A0%9C%EC%96%B4%ED%95%98%EA%B8%B0">시나리오 3 : noRollbackFor로 롤백 정책 직접 제어하기</a></p>
<ul>
<li><a href="#pointservicededuct%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D--rollback-only-%EB%A7%88%ED%82%B9-%EC%95%88-%ED%95%A8">PointService.deduct에서 예외 발생 → rollback-only 마킹 안 함!</a></li>
<li><a href="#orderservice%EC%97%90%EC%84%9C-%EC%BB%A4%EB%B0%8B-%EC%84%B1%EA%B3%B5">OrderService에서 커밋 성공</a></li>
<li><a href="#norollbackfor-%EC%82%AC%EC%9A%A9-%EC%8B%9C-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD">noRollbackFor 사용 시 주의사항</a></li>
</ul>
</li>
<li>
<p><a href="#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-4--%EC%99%B8%EB%B6%80-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%97%86%EC%9D%8C--%EC%9D%98%EB%8F%84%EC%B9%98-%EC%95%8A%EC%9D%80-%EB%B6%80%EB%B6%84-%EC%BB%A4%EB%B0%8B-%EB%B0%9C%EC%83%9D">시나리오 4 : 외부 트랜잭션 없음 → 의도치 않은 부분 커밋 발생</a></p>
</li>
<li>
<p><a href="#requires_new%EB%8A%94-%EC%96%B4%EB%96%A8%EA%B9%8C">REQUIRES_NEW는 어떨까?</a></p>
</li>
<li>
<p><a href="#%EB%A7%BA%EC%9C%BC%EB%A9%B0">맺으며</a></p>
<ul>
<li><a href="#%EC%9A%94%EC%95%BD">요약</a></li>
</ul>
</li>
</ul></nav></aside></div><style data-emotion="css b3pts2">.css-b3pts2{display:grid;place-items:center;margin-top:40px;padding:25px 0;font-size:15px;color:#aaa;font-weight:bold;text-align:center;line-height:1.2;background-color:#f0f0f0;}@media (max-width: 768px){.css-b3pts2{font-size:13px;}}</style><div class="css-b3pts2 ehmnl591">© <!-- -->2025<!-- --> 박건희<style data-emotion="css 1tmvi1x">.css-1tmvi1x{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:5px;font-size:25px;}.css-1tmvi1x>a{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;color:inherit;}@media (max-width: 768px){.css-1tmvi1x{font-size:20px;}}</style><div class="css-1tmvi1x ehmnl590"><a href="https://github.com/connieya" target="_blank" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/spring-transactional-propagation-required/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-df12038c07713455cf6e.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-8535dbf06a13c1090bd2.js\"],\"component---src-pages-blog-tsx\":[\"/component---src-pages-blog-tsx-d2e65452bccf51ec7d66.js\"],\"component---src-pages-guestbook-tsx\":[\"/component---src-pages-guestbook-tsx-caab7d387c8f82e763e7.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-fd11d8a720f37f9fad74.js\"],\"component---src-templates-post-template-tsx\":[\"/component---src-templates-post-template-tsx-066e8ae937e494dc3d21.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="b28f7e78d6acc4945370";</script><script src="/webpack-runtime-efa366ad35d664760232.js" async></script><script src="/framework-a02ced70e77b2a7c030d.js" async></script><script src="/app-df12038c07713455cf6e.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>